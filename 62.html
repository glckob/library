<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីគ្រប់គ្រងបណ្ណាល័យ (Firebase Login)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&family=Moul&family=Noto+Sans+Khmer:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Barcode Generation Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Excel Export Library (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Link to the external CSS file -->
    <link rel="stylesheet" href="./styles.css?v=1.1">
</head>
<body class="bg-gray-100">

    <!-- Print Header (Only visible for printing reports) -->
    <div id="print-header">
         <div class="print-header-content">
            <div class="motto">
                <p>ព្រះរាជាណាចក្រកម្ពុជា</p>
                <p>ជាតិ សាសនា ព្រះមហាក្សត្រ</p>
            </div>
            <div class="school-name">
                <span id="print-school-name"></span>
            </div>
            <div class="report-title">
                <span id="print-report-title"></span>
            </div>
            <!-- NEW: Print Subtitle (for class loan report) -->
            <div class="text-xs text-gray-700 font-semibold mt-2 hidden print-only" id="class-loan-report-subtitle"></div>
         </div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="fixed inset-0 bg-gray-200 flex items-center justify-center z-50">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-lg">
            <!-- Login Form -->
            <div id="login-form-container">
                <h2 class="text-3xl font-bold text-center mb-6 font-koulen">ចូលប្រើប្រាស់</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 mb-1">អ៊ីមែល</label>
                        <input type="email" id="login-email" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 mb-1">ពាក្យសម្ងាត់</label>
                        <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition-colors">ចូលប្រើ</button>
                    <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
                </form>
                <p class="text-center mt-4 text-gray-600">
                    មិនទាន់មានគណនី? <a href="#" id="show-register" class="text-blue-500 hover:underline">ចុះឈ្មោះនៅទីនេះ</a>
                </p>
            </div>
            <!-- Register Form -->
            <div id="register-form-container" class="hidden">
                <h2 class="text-3xl font-bold text-center mb-6 font-koulen">បង្កើតគណនីថ្មី</h2>
                <form id="register-form">
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 mb-1">អ៊ីមែល</label>
                        <input type="email" id="register-email" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-700 mb-1">ពាក្យសម្ងាត់</label>
                        <input type="password" id="register-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600 transition-colors">ចុះឈ្មោះ</button>
                    <p id="register-error" class="text-red-500 text-sm text-center mt-4"></p>
                </form>
                <p class="text-center mt-4 text-gray-600">
                    មានគណនីហើយ? <a href="#" id="show-login" class="text-blue-500 hover:underline">ចូលប្រើនៅទីនេះ</a>
                </p>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden">
        <div class="flex h-screen bg-gray-200">
            <!-- Sidebar -->
            <div id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col no-print">
                <div class="p-4 border-b border-gray-700">
                    <h1 class="text-2xl font-bold text-center font-moul">បណ្ណាល័យខ្ញុំ</h1>
                    <p id="sidebar-school-name" class="text-sm text-center font-moul text-gray-300 mt-1"></p>
                </div>
                <nav class="flex-1 px-2 py-4 space-y-2">
                    <a href="#" data-page="home" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-home mr-3"></i> ទំព័រដើម
                    </a>
                    <a href="#" data-page="books" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-book mr-3"></i> គ្រប់គ្រងសៀវភៅ
                    </a>
                    <a href="#" data-page="loans" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-user mr-3"></i> ខ្ចី-សង បុគ្គល
                    </a>
                     <a href="#" data-page="class-loans" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-users mr-3"></i> ខ្ចី-សង តាមថ្នាក់
                    </a>
                    <a href="#" data-page="reading-log" class="nav-link flex items-center px-4 py-2 text-gray-100 bg-gray-900 rounded-md">
                        <i class="fas fa-book-open mr-3"></i> ចូលអាន
                    </a>
                    <a href="#" data-page="locations" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-map-marker-alt mr-3"></i> ទីតាំងរក្សាទុក
                    </a>
                    <a href="#" data-page="students" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-user-graduate mr-3"></i> ទិន្នន័យសិស្ស
                    </a>
                    <a href="#" data-page="student-cards" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-id-card mr-3"></i> កាតសិស្ស
                    </a>
                    <a href="#" data-page="settings" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-cog mr-3"></i> ការកំណត់
                    </a>
                </nav>
                <!-- Credits Section -->
                <div class="p-2 border-t border-gray-700 text-center text-xs text-gray-400 no-print">
                    <p>កម្មវិធីនេះសរសេរដោយ លោកគ្រូ វង្ស សាណូវុទ្ធ</p>
                    <p class="mt-1">ឧបត្ថម្ភការផលិតដោយ៖ អង្គការហ្គូដណេប៊ឺសកម្ពុជា</p>
                </div>
                <div class="p-2 border-t border-gray-700 text-center text-xs text-gray-400 no-print">
                    <p id="user-email" class="truncate"></p>
                    <button id="logout-btn" class="w-full mt-2 bg-red-500 text-white py-1 rounded hover:bg-red-600">ចាកចេញ</button>
                </div>
            </div>

            <!-- Main content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                    <!-- Home Page -->
                    <div id="page-home" class="page hidden">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">ផ្ទាំងគ្រប់គ្រង</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                                <i class="fas fa-book text-5xl text-blue-500 mr-6"></i>
                                <div>
                                    <p class="text-lg text-gray-600">ប្រភេទសៀវភៅសរុប</p>
                                    <p id="total-books" class="text-4xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                                <i class="fas fa-layer-group text-5xl text-purple-500 mr-6"></i>
                                <div>
                                    <p class="text-lg text-gray-600">ចំនួនសៀវភៅសរុប</p>
                                    <p id="total-quantity" class="text-4xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                                <i class="fas fa-hand-holding-hand text-5xl text-green-500 mr-6"></i>
                                <div>
                                    <p class="text-lg text-gray-600">កំពុងខ្ចី</p>
                                    <p id="total-loans" class="text-4xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Book Management Page -->
                    <div id="page-books" class="page hidden">
                         <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-3xl font-bold text-gray-800 no-print">បញ្ជីសៀវភៅ</h2>
                            <div class="flex items-center">
                                <input type="text" id="search-books" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md mr-4 no-print" placeholder="ស្វែងរកសៀវភៅ...">
                                <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 mr-2 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                                <button onclick="window.openBookModal()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 no-print"><i class="fas fa-plus mr-2"></i>បន្ថែម</button>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                            <div id="books-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left whitespace-no-wrap">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">ល.រ</th>
                                            <th class="p-3">ចំណងជើង</th>
                                            <th class="p-3">អ្នកនិពន្ធ</th>
                                            <th class="p-3">ISBN</th>
                                            <th class="p-3">ចំនួនសរុប</th>
                                            <th class="p-3">ចំនួននៅសល់</th>
                                            <th class="p-3">ទីតាំង</th>
                                            <th class="p-3">ប្រភព</th>
                                            <th class="p-3 no-print">សកម្មភាព</th>
                                        </tr>
                                    </thead>
                                    <tbody id="book-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Individual Loan Management Page -->
                    <div id="page-loans" class="page hidden">
                        <!-- Section for creating new individual loans -->
                        <h2 class="text-3xl font-bold text-gray-800 mb-4 no-print">បង្កើតកំណត់ត្រាខ្ចី-សង បុគ្គល</h2>
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6 no-print">
                            <form id="loan-form">
                                <input type="hidden" id="loan-borrower-gender">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-start">
                                    <!-- ISBN Input -->
                                    <div>
                                        <label for="loan-isbn-input" class="block text-gray-700 mb-1 font-medium">វាយបញ្ចូល/ស្កេន ISBN</label>
                                        <input type="text" id="loan-isbn-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ស្កេន Barcode..." autocomplete="off" required>
                                        <p id="loan-book-error" class="text-xs text-red-500 mt-1"></p>
                                    </div>
                                    <!-- Book Title Display -->
                                    <div>
                                        <label for="loan-book-title-display" class="block text-gray-700 mb-1 font-medium">ឈ្មោះសៀវភៅ</label>
                                        <input type="text" id="loan-book-title-display" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                                        <input type="hidden" id="loan-book-id">
                                    </div>
                                    <!-- Student ID Input -->
                                    <div>
                                        <label for="loan-student-id-input" class="block text-gray-700 mb-1 font-medium">វាយបញ្ចូល/ស្កេន អត្តលេខសិស្ស</label>
                                        <input type="text" id="loan-student-id-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ស្កេនកាតសិស្ស..." autocomplete="off" required>
                                        <p id="loan-student-error" class="text-xs text-red-500 mt-1"></p>
                                    </div>
                                    <!-- Borrower Name Display -->
                                    <div>
                                        <label for="loan-borrower-name-display" class="block text-gray-700 mb-1 font-medium">ឈ្មោះអ្នកខ្ចី</label>
                                        <input type="text" id="loan-borrower-name-display" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <button type="submit" class="w-full md:w-auto bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600"><i class="fas fa-plus mr-2"></i>បង្កើតការខ្ចី</button>
                                </div>
                            </form>
                        </div>

                        <!-- Section for loan history -->
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h3 class="text-xl font-bold text-gray-800 no-print">ប្រវត្តិនៃការខ្ចី-សង បុគ្គល</h3>
                            <div class="flex items-center">
                                <input type="text" id="search-loans" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md mr-4 no-print" placeholder="ស្វែងរកការខ្ចី...">
                                <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                            </div>
                        </div>
                        
                        <!-- Filter and Summary Section -->
                        <div class="bg-white p-4 rounded-lg shadow-md mb-6 no-print">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="loan-filter-start-date" class="block text-sm font-medium text-gray-700">ពីថ្ងៃ</label>
                                    <input type="date" id="loan-filter-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="loan-filter-end-date" class="block text-sm font-medium text-gray-700">ដល់ថ្ងៃ</label>
                                    <input type="date" id="loan-filter-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div class="flex space-x-2">
                                    <button id="loan-filter-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 w-full">ត្រង</button>
                                    <button id="loan-reset-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 w-full">សម្អាត</button>
                                </div>
                            </div>
                            <div id="loan-summary" class="mt-4 text-center font-semibold text-gray-700"></div>
                        </div>
                        
                        <!-- Loan List Table -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <div id="loans-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">ល.រ</th>
                                            <th class="p-3">ចំណងជើងសៀវភៅ</th>
                                            <th class="p-3">ឈ្មោះអ្នកខ្ចី</th>
                                            <th class="p-3">ថ្ងៃខ្ចី</th>
                                            <th class="p-3">ថ្ងៃសង</th>
                                            <th class="p-3">ស្ថានភាព</th>
                                            <th class="p-3 no-print">សកម្មភាព</th>
                                        </tr>
                                    </thead>
                                    <tbody id="loan-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Class Loan Management Page -->
                    <div id="page-class-loans" class="page hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4 no-print">បង្កើតកំណត់ត្រាខ្ចី-សង តាមថ្នាក់</h2>
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6 no-print">
                            <form id="class-loan-form">
                                <!-- START: MODIFIED FORM LAYOUT -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                                    <!-- ISBN Input -->
                                    <div>
                                        <label for="class-loan-isbn-input" class="block text-gray-700 mb-1 font-medium">វាយបញ្ចូល/ស្កេន ISBN</label>
                                        <input type="text" id="class-loan-isbn-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ស្កេន Barcode..." autocomplete="off" required>
                                    </div>
                                    <!-- Book Title Display -->
                                    <div>
                                        <label for="class-loan-book-title-display" class="block text-gray-700 mb-1 font-medium">ឈ្មោះសៀវភៅ</label>
                                        <input type="text" id="class-loan-book-title-display" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                                        <input type="hidden" id="class-loan-book-id">
                                        <p id="class-loan-book-error" class="text-xs text-red-500 mt-1"></p>
                                    </div>
                                    <!-- Class Select with Student Count -->
                                    <div class="flex items-end gap-2">
                                        <div class="flex-grow">
                                            <label for="class-loan-class-select" class="block text-gray-700 mb-1 font-medium">ជ្រើសរើសថ្នាក់</label>
                                            <select id="class-loan-class-select" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></select>
                                        </div>
                                        <p id="class-info-text" class="text-sm text-blue-600 font-semibold pb-2 whitespace-nowrap"></p>
                                    </div>
                                </div>

                                <!-- Student List Container -->
                                <div id="class-loan-student-list-container" class="mt-4 bg-gray-50 p-4 rounded-md border hidden max-h-60 overflow-y-auto">
                                    <!-- Student list with checkboxes will be dynamically inserted here -->
                                </div>

                                <!-- Loan Quantity Display & Submit Button -->
                                <div class="mt-4 flex flex-wrap items-center justify-between gap-4">
                                    <div>
                                        <label for="class-loan-quantity" class="block text-gray-700 mb-1 font-medium">ចំនួនខ្ចី</label>
                                        <input type="number" id="class-loan-quantity" class="w-32 px-3 py-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                                    </div>
                                    <button type="submit" class="bg-cyan-500 text-white px-6 py-2 rounded-md hover:bg-cyan-600"><i class="fas fa-users mr-2"></i>បង្កើតការខ្ចី</button>
                                </div>
                                <!-- END: MODIFIED FORM LAYOUT -->
                            </form>
                        </div>
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h3 class="text-xl font-bold text-gray-800 no-print">ប្រវត្តិនៃការខ្ចីតាមថ្នាក់</h3>
                            <div class="flex items-center">
                                <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 no-print mr-2"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                                <!-- NEW: Button to print student list for class loans -->
                                <button id="print-class-loan-list-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ពបញ្ជីខ្ចី</button>
                            </div>
                        </div>
                        <!-- Filter Section -->
                        <div class="bg-white p-4 rounded-lg shadow-md mb-6 no-print">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div class="md:col-span-2">
                                    <label for="class-loan-filter-select" class="block text-sm font-medium text-gray-700">ត្រងតាមថ្នាក់</label>
                                    <select id="class-loan-filter-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                                </div>
                                <div>
                                    <button id="class-loan-reset-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 w-full">បង្ហាញទាំងអស់</button>
                                </div>
                            </div>
                        </div>
                         <div class="bg-white p-4 rounded-lg shadow-md">
                            <div id="class-loans-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">#</th>
                                            <th class="p-3">សៀវភៅ</th>
                                            <th class="p-3">ថ្នាក់</th>
                                            <th class="p-3">ថ្ងៃខ្ចី</th>
                                            <th class="p-3">ស្ថានភាពសង</th>
                                            <th class="p-3 no-print">សកម្មភាព</th>
                                        </tr>
                                    </thead>
                                    <tbody id="class-loan-list"></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- NEW: Print Area for Class Loan Students -->
                        <div id="class-loan-students-print-area" class="print-area">
                             <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                             <div id="class-loan-students-table-container"></div>
                        </div>
                    </div>
                    
                    <!-- Reading Log Page -->
                    <div id="page-reading-log" class="page">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4 no-print">កត់ត្រាការចូលអាន</h2>
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6 no-print">
                            <form id="reading-log-form">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label for="reading-log-student-id" class="block text-gray-700 mb-1 font-medium">ស្កេនអត្តលេខសិស្ស</label>
                                        <input type="text" id="reading-log-student-id" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ស្កេនកាតសិស្ស..." autocomplete="off" required>
                                        <p id="reading-log-student-error" class="text-xs text-red-500 mt-1"></p>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="reading-log-student-name" class="block text-gray-700 mb-1 font-medium">ឈ្មោះសិស្ស</label>
                                        <input type="text" id="reading-log-student-name" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                                        <input type="hidden" id="reading-log-student-obj-id">
                                    </div>
                                    <div class="md:col-span-3">
                                        <label for="reading-log-isbn-input" class="block text-gray-700 mb-1 font-medium">ស្កេន ISBN សៀវភៅ</label>
                                        <input type="text" id="reading-log-isbn-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ស្កេនសៀវភៅម្តងមួយ..." autocomplete="off">
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <h4 class="font-medium">សៀវភៅបានស្កេន៖</h4>
                                    <ul id="scanned-books-list" class="list-disc list-inside mt-2 text-gray-700">
                                        <!-- Scanned books will appear here -->
                                    </ul>
                                </div>
                                <div class="flex justify-end mt-6">
                                    <button type="button" onclick="window.clearReadingLogForm()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">សម្អាត</button>
                                    <button type="submit" class="bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600">រក្សាទុកការចូលអាន</button>
                                </div>
                            </form>
                        </div>
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h3 class="text-xl font-bold text-gray-800 no-print">ប្រវត្តិនៃការចូលអាន</h3>
                             <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                        </div>
                        <!-- Filter and Summary Section -->
                        <div class="bg-white p-4 rounded-lg shadow-md mb-6 no-print">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="reading-log-filter-start-date" class="block text-sm font-medium text-gray-700">ពីថ្ងៃ</label>
                                    <input type="date" id="reading-log-filter-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="reading-log-filter-end-date" class="block text-sm font-medium text-gray-700">ដល់ថ្ងៃ</label>
                                    <input type="date" id="reading-log-filter-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div class="flex space-x-2">
                                    <button id="reading-log-filter-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 w-full">ត្រង</button>
                                    <button id="reading-log-reset-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 w-full">សម្អាត</button>
                                </div>
                            </div>
                             <div id="reading-log-summary" class="mt-4 text-center font-semibold text-gray-700"></div>
                        </div>
                         <div class="bg-white p-4 rounded-lg shadow-md">
                            <div id="reading-log-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">#</th>
                                            <th class="p-3">កាលបរិច្ឆេទ</th>
                                            <th class="p-3">ឈ្មោះសិស្ស</th>
                                            <th class="p-3">សៀវភៅបានអាន</th>
                                            <th class="p-3 no-print">សកម្មភាព</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reading-log-history"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Location Management Page -->
                    <div id="page-locations" class="page hidden">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-3xl font-bold text-gray-800 no-print">គ្រប់គ្រងទីតាំងរក្សាទុក</h2>
                            <div class="flex items-center">
                                <input type="text" id="search-locations" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md mr-4 no-print" placeholder="ស្វែងរកទីតាំង...">
                                <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 mr-2 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                                <button onclick="window.openLocationModal()" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 no-print"><i class="fas fa-plus mr-2"></i>បន្ថែម</button>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <div id="locations-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">#</th>
                                            <th class="p-3">ឈ្មោះទីតាំង</th>
                                            <th class="p-3">ប្រភពធ្នើ</th>
                                            <th class="p-3">ឆ្នាំ</th>
                                            <th class="p-3 no-print">សកម្មភាព</th>
                                        </tr>
                                    </thead>
                                    <tbody id="location-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Student Data Page -->
                    <div id="page-students" class="page hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4 no-print">ទិន្នន័យសិស្ស</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md mb-6 no-print">
                            <h3 class="text-xl font-bold mb-2">តំណភ្ជាប់ Google Sheet</h3>
                            <div class="flex flex-wrap items-center gap-2">
                                <input type="url" id="google-sheet-url" class="flex-grow px-3 py-2 border border-gray-300 rounded-md" placeholder="ដាក់ Link Google Sheet CSV នៅទីនេះ...">
                                <button id="save-url-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600"><i class="fas fa-save mr-2"></i>រក្សាទុក Link</button>
                                <button id="fetch-data-btn" class="bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600"><i class="fas fa-download mr-2"></i>ទាញយកទិន្នន័យ</button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">**សំគាល់:** សូមប្រាកដថា Link របស់អ្នកបាន Publish to the web ជាទម្រង់ CSV។ (File > Share > Publish to web > CSV)</p>
                        </div>

                        <div class="flex flex-wrap justify-between items-start mb-6 gap-4">
                            <div class="flex items-start">
                                <h3 class="text-xl font-bold text-gray-800 no-print">បញ្ជីសិស្ស</h3>
                                <div id="duplicate-student-list" class="text-red-500 text-sm ml-6"></div>
                            </div>
                            <div class="flex items-center">
                                <!-- START: NEW CLASS FILTER DROPDOWN -->
                                <select id="student-class-filter" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md mr-4 no-print"></select>
                                <!-- END: NEW CLASS FILTER DROPDOWN -->
                                <input type="text" id="search-students" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md mr-4 no-print" placeholder="ស្វែងរកសិស្ស...">
                                <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 mr-2 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                                <button onclick="window.openStudentModal()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 no-print"><i class="fas fa-plus mr-2"></i>បន្ថែមសិស្ស</button>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                            <div id="students-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left whitespace-no-wrap">
                                    <thead class="bg-gray-200">
                                        <tr id="student-list-header">
                                            <!-- Headers will be generated dynamically -->
                                        </tr>
                                    </thead>
                                    <tbody id="student-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Student Card Page -->
                    <div id="page-student-cards" class="page hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4 no-print">បោះពុម្ពកាតសិស្ស</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <div class="controls no-print">
                                <select id="card-class-filter" class="w-full md:w-auto">
                                  <option value="">-- ជ្រើសរើសថ្នាក់ទាំងអស់ --</option>
                                </select>
                                <input type="text" id="card-search-box" class="w-full md:w-auto" placeholder="ស្វែងរកតាមឈ្មោះ ឬអត្តលេខ..." />
                                <button onclick="window.printCards()" class="bg-blue-500 text-white hover:bg-blue-600">
                                    <i class="fas fa-print mr-2"></i> បោះពុម្ព / រក្សាទុក PDF
                                </button>
                            </div>
                            <p class="text-red-600 text-center text-sm my-2 no-print">
                                **សំគាល់:** ដើម្បីបោះពុម្ព Logo និងត្រាអោយចេញ សូមចុច "More Settings" ហើយ ✓ "Background graphics"
                            </p>
                            <div id="loading-cards" class="w-full text-center p-4">🔄 កំពុងដំណើរការ...</div>
                            <div id="student-card-container" class="card-container" style="display: none;">
                                <!-- Student cards will be generated here by JavaScript -->
                            </div>
                        </div>
                    </div>


                    <!-- Settings Page -->
                    <div id="page-settings" class="page hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">ការកំណត់</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column: Settings -->
                            <div class="space-y-8">
                                <!-- General Info Section -->
                                <div class="bg-white p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ព័ត៌មានទូទៅ</h3>
                                    <div class="space-y-4">
                                        <!-- School Name -->
                                        <div>
                                            <label for="school-name-input" class="block text-sm font-medium text-gray-700">ឈ្មោះសាលា</label>
                                            <div id="school-name-container" class="mt-1 flex items-center gap-2">
                                                <input type="text" id="school-name-input" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm">
                                                <p id="school-name-display" class="hidden flex-grow font-semibold text-lg"></p>
                                                <button id="save-school-name-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">រក្សាទុក</button>
                                                <button id="edit-school-name-btn" class="hidden bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600">កែប្រែ</button>
                                                <button id="delete-school-name-btn" class="hidden bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">លុប</button>
                                            </div>
                                        </div>
                                        <!-- Academic Year -->
                                        <div>
                                            <label for="academic-year-input" class="block text-sm font-medium text-gray-700">ឆ្នាំសិក្សា</label>
                                            <div id="academic-year-container" class="mt-1 flex items-center gap-2">
                                                <input type="text" id="academic-year-input" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm" placeholder="YYYY-YYYY">
                                                <p id="academic-year-display" class="hidden flex-grow font-semibold text-lg"></p>
                                                <button id="save-academic-year-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">រក្សាទុក</button>
                                                <button id="edit-academic-year-btn" class="hidden bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600">កែប្រែ</button>
                                                <button id="delete-academic-year-btn" class="hidden bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">លុប</button>
                                            </div>
                                        </div>
                                        <!-- Principal Seal -->
                                        <div>
                                            <label for="seal-image-url" class="block text-sm font-medium text-gray-700">ត្រានាយកសាលា (URL)</label>
                                            <div class="mt-1 flex items-center gap-4">
                                                <div class="flex-grow">
                                                    <input type="url" id="seal-image-url" class="block w-full rounded-md border-gray-300 shadow-sm" placeholder="https://example.com/seal.png">
                                                    <button id="save-seal-url-btn" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">រក្សាទុក URL</button>
                                                </div>
                                                <img id="seal-image-preview" src="https://placehold.co/100x100/e2e8f0/e2e8f0?text=Preview" alt="Seal Preview" class="w-24 h-24 object-contain border rounded-md bg-gray-100">
                                            </div>
                                        </div>
                                        <!-- Card Background -->
                                        <div>
                                            <label for="card-bg-url" class="block text-sm font-medium text-gray-700">ផ្ទៃខាងក្រោយកាត (URL)</label>
                                            <div class="mt-1 flex items-center gap-4">
                                                <div class="flex-grow">
                                                    <input type="url" id="card-bg-url" class="block w-full rounded-md border-gray-300 shadow-sm" placeholder="https://example.com/background.png">
                                                    <button id="save-card-bg-btn" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">រក្សាទុក URL</button>
                                                </div>
                                                <img id="card-bg-preview" src="https://placehold.co/100x100/e2e8f0/e2e8f0?text=Preview" alt="Card BG Preview" class="w-24 h-24 object-contain border rounded-md bg-gray-100">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Change Password Section -->
                                <div class="bg-white p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ផ្លាស់ប្តូរពាក្យសម្ងាត់</h3>
                                    <form id="change-password-form" class="space-y-4">
                                        <div>
                                            <label for="current-password" class="block text-sm font-medium text-gray-700">ពាក្យសម្ងាត់បច្ចុប្បន្ន</label>
                                            <input type="password" id="current-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                        </div>
                                        <div>
                                            <label for="new-password" class="block text-sm font-medium text-gray-700">ពាក្យសម្ងាត់ថ្មី</label>
                                            <input type="password" id="new-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                        </div>
                                        <div>
                                            <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">ยืนยันពាក្យសម្ងាត់ថ្មី</label>
                                            <input type="password" id="confirm-new-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                        </div>
                                        <p id="change-password-error" class="text-red-500 text-sm"></p>
                                        <p id="change-password-success" class="text-green-500 text-sm"></p>
                                        <button type="submit" class="w-full bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600">ផ្លាស់ប្តូរពាក្យសម្ងាត់</button>
                                    </form>
                                </div>
                            </div>
                            <!-- Right Column: Data & Danger Zone -->
                            <div class="space-y-8">
                                <!-- START: NEW EXPORT SECTION -->
                                <div class="bg-white p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">នាំចេញទិន្នន័យ</h3>
                                    <p class="text-gray-600 mb-4">ជ្រើសរើសប្រភេទទិន្នន័យ រួចចុចប៊ូតុងដើម្បីទាញយកជាไฟล์ Excel (.xlsx)។</p>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="export-data-select" class="block text-sm font-medium text-gray-700">ជ្រើសរើសទិន្នន័យ</label>
                                            <select id="export-data-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                                <option value="" disabled selected>-- សូមជ្រើសរើស --</option>
                                                <option value="books">បញ្ជីសៀវភៅ</option>
                                                <option value="loans">ប្រវត្តិនៃការខ្ចី-សង បុគ្គល</option>
                                                <option value="class-loans">ប្រវត្តិនៃការខ្ចីតាមថ្នាក់</option>
                                                <option value="reading-logs">ប្រវត្តិនៃការចូលអាន</option>
                                                <option value="locations">ទីតាំងរក្សាទុក</option>
                                                <option value="students">បញ្ជីសិស្ស</option>
                                                <option value="settings">ព័ត៌មានទូទៅ</option>
                                            </select>
                                        </div>
                                        <button id="export-excel-btn" class="w-full bg-emerald-500 text-white px-4 py-2 rounded-md hover:bg-emerald-600 flex items-center justify-center">
                                            <i class="fas fa-file-excel mr-2"></i> នាំចេញជា Excel
                                        </button>
                                    </div>
                                </div>
                                <!-- END: NEW EXPORT SECTION -->

                                <div class="bg-white p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-bold text-red-600 mb-4 border-b pb-2">តំបន់គ្រោះថ្នាក់</h3>
                                    <p class="text-gray-600 mb-6">ការดำเนินการខាងក្រោមនឹងលុបទិន្នន័យជាអចិន្ត្រៃយ៍ ហើយមិនអាចមិនធ្វើវិញបានទេ។ សូមប្រើដោយប្រុងប្រយត្នបំផុត។</p>
                                    
                                    <div class="space-y-6">
                                        <!-- Delete Buttons -->
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបបញ្ជីសៀវភៅទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបទិន្នន័យសៀវភៅទាំងអស់ចេញពីប្រព័ន្ធ។</p>
                                            <button onclick="window.openPasswordConfirmModal('books')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបកំណត់ត្រាខ្ចី-សង បុគ្គលទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបប្រវត្តិខ្ចី-សងរបស់បុគ្គលទាំងអស់។</p>
                                            <button onclick="window.openPasswordConfirmModal('loans')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបប្រវត្តិនៃការខ្ចីតាមថ្នាក់ទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបប្រវត្តិខ្ចី-សងតាមថ្នាក់ទាំងអស់។</p>
                                            <button onclick="window.openPasswordConfirmModal('classLoans')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបប្រវត្តិនៃការចូលអានទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបកំណត់ត្រាការចូលអានទាំងអស់។</p>
                                            <button onclick="window.openPasswordConfirmModal('readingLogs')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបទីតាំងរក្សាទុកទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបទីតាំងធ្នើសៀវភៅទាំងអស់។</p>
                                            <button onclick="window.openPasswordConfirmModal('locations')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបបញ្ជីទិន្នន័យសិស្សទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបข้อมูลសិស្សទាំងអស់ចេញពីប្រព័ន្ធ។</p>
                                            <button onclick="window.openPasswordConfirmModal('students')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="book-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-20">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 id="book-modal-title" class="text-2xl font-bold mb-6">បន្ថែមសៀវភៅថ្មី</h3>
            <form id="book-form">
                <input type="hidden" id="book-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="title" class="block text-gray-700 mb-1">ចំណងជើង</label>
                        <input type="text" id="title" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="author" class="block text-gray-700 mb-1">អ្នកនិពន្ធ</label>
                        <input type="text" id="author" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                     <div>
                        <label for="isbn" class="block text-gray-700 mb-1">លេខ ISBN</label>
                        <input type="text" id="isbn" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="quantity" class="block text-gray-700 mb-1">ចំនួន</label>
                        <input type="number" id="quantity" class="w-full px-3 py-2 border border-gray-300 rounded-md" required min="0">
                    </div>
                    <div>
                        <label for="book-location-id" class="block text-gray-700 mb-1">ទីតាំងរក្សាទុក</label>
                        <select id="book-location-id" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></select>
                    </div>
                    <div>
                        <label for="source" class="block text-gray-700 mb-1">ប្រភពសៀវភៅ</label>
                        <input type="text" id="source" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.closeBookModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">បោះបង់</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="location-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-20">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 id="location-modal-title" class="text-2xl font-bold mb-6">បន្ថែមទីតាំងថ្មី</h3>
            <form id="location-form">
                <input type="hidden" id="location-id">
                <div class="mb-4">
                    <label for="location-name" class="block text-gray-700 mb-1">ឈ្មោះទីតាំង</label>
                    <input type="text" id="location-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="location-source" class="block text-gray-700 mb-1">ប្រភពធ្នើ</label>
                    <input type="text" id="location-source" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="location-year" class="block text-gray-700 mb-1">ឆ្នាំ</label>
                    <input type="number" id="location-year" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.closeLocationModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">បោះបង់</button>
                    <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded-md">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>
    <div id="class-return-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-20">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6">សងសៀវភៅសម្រាប់ថ្នាក់</h3>
            <form id="class-return-form">
                <input type="hidden" id="class-return-loan-id">
                <div class="mb-4">
                    <p><strong>សៀវភៅ:</strong> <span id="class-return-book-title"></span></p>
                    <p><strong>ថ្នាក់:</strong> <span id="class-return-class-name"></span></p>
                    <p><strong>ចំនួនខ្ចីសរុប:</strong> <span id="class-return-total-students"></span></p>
                    <p><strong>បានសងរួច:</strong> <span id="class-return-already-returned"></span></p>
                </div>
                <div class="mb-4">
                    <label for="number-to-return" class="block text-gray-700 mb-1">បញ្ចូលចំនួនសងបន្ថែម</label>
                    <input type="number" id="number-to-return" class="w-full px-3 py-2 border border-gray-300 rounded-md" required min="1">
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.closeClassReturnModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">បោះបង់</button>
                    <button type="submit" class="bg-teal-500 text-white px-4 py-2 rounded-md">រក្សាទុកការសង</button>
                </div>
            </form>
        </div>
    </div>
     <div id="class-loan-edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-20">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6">កែប្រែការខ្ចីតាមថ្នាក់</h3>
            <form id="class-loan-edit-form">
                <input type="hidden" id="class-loan-edit-id">
                <div class="mb-4">
                    <p><strong>សៀវភៅ:</strong> <span id="class-loan-edit-book-title"></span></p>
                    <p><strong>ថ្នាក់:</strong> <span id="class-loan-edit-class-name"></span></p>
                </div>
                <div class="mb-4">
                    <label for="class-loan-edit-date" class="block text-gray-700 mb-1">កាលបរិច្ឆេទខ្ចី</label>
                    <input type="date" id="class-loan-edit-date" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.closeClassLoanEditModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">បោះបង់</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">រក្សាទុកការផ្លាស់ប្តូរ</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Student Modal -->
    <div id="student-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-20">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
            <h3 id="student-modal-title" class="text-2xl font-bold mb-6">បន្ថែមសិស្សថ្មី</h3>
            <form id="student-form">
                <input type="hidden" id="student-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="student-no" class="block text-gray-700 mb-1">ល.រ</label>
                        <input type="text" id="student-no" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="student-code" class="block text-gray-700 mb-1">អត្តលេខ</label>
                        <input type="text" id="student-code" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="student-lastname" class="block text-gray-700 mb-1">នាមត្រកូល</label>
                        <input type="text" id="student-lastname" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="student-firstname" class="block text-gray-700 mb-1">នាមខ្លួន</label>
                        <input type="text" id="student-firstname" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="student-gender" class="block text-gray-700 mb-1">ភេទ</label>
                        <select id="student-gender" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="ប្រុស">ប្រុស</option>
                            <option value="ស្រី">ស្រី</option>
                        </select>
                    </div>
                    <div>
                        <label for="student-dob" class="block text-gray-700 mb-1">ថ្ងៃខែឆ្នាំកំណើត</label>
                        <input type="text" id="student-dob" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="student-class" class="block text-gray-700 mb-1">ថ្នាក់</label>
                        <input type="text" id="student-class" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="student-photo-url" class="block text-gray-700 mb-1">រូបថត URL</label>
                        <input type="url" id="student-photo-url" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.closeStudentModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">បោះបង់</button>
                    <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-md">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Password Confirmation Modal -->
    <div id="password-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-30">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">ยืนยันการลบ</h3>
            <p class="text-gray-600 mb-4">ដើម្បីยืนยัน សូមវាយបញ្ចូលรหัสผ่านរបស់អ្នក រួចចុចប៊ូតុង "ยืนยัน"។</p>
            <form id="password-confirm-form">
                <input type="hidden" id="collection-to-delete">
                <div>
                    <label for="user-password" class="block text-gray-700 mb-1">ពាក្យសម្ងាត់</label>
                    <input type="password" id="user-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    <p id="password-error" class="text-red-500 text-sm mt-1"></p>
                </div>
                <div class="flex justify-end mt-6 space-x-2">
                    <button type="button" onclick="window.closePasswordConfirmModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md">បោះបង់</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md">ยืนยัน</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex-col items-center justify-center z-40 hidden">
        <i class="fas fa-spinner fa-spin text-white text-5xl"></i>
        <p class="text-white text-xl mt-4">កំពុងដំណើរការ...</p>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, updateDoc, deleteDoc, query, where, writeBatch, getDocs, increment, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAohuQEs4nWuw1PSqfZpvxN1sF16BX_Qgw",
            authDomain: "library-glc-kob.firebaseapp.com",
            projectId: "library-glc-kob",
            storageBucket: "library-glc-kob.appspot.com",
            messagingSenderId: "806682991838",
            appId: "1:806682991838:web:4f63c2a07c39d89a74a89a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE & DOM ELEMENTS ---
        let books = [];
        let loans = [];
        let classLoans = [];
        let locations = [];
        let students = [];
        let readingLogs = [];
        let settingsData = {};
        let currentUserId = null;
        let unsubscribeBooks = () => {};
        let unsubscribeLoans = () => {};
        let unsubscribeClassLoans = () => {};
        let unsubscribeLocations = () => {};
        let unsubscribeStudents = () => {};
        let unsubscribeSettings = () => {};
        let unsubscribeReadingLogs = () => {};
        let currentScannedBooks = [];
        let currentStudentGender = ''; // For gender tracking

        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-btn');
        const sidebarSchoolName = document.getElementById('sidebar-school-name');

        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        
        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('user-email').textContent = user.email;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                setupRealtimeListeners(currentUserId);
                // Set default page to reading log
                navigateTo('reading-log');
            } else {
                currentUserId = null;
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                // Unsubscribe from all listeners
                unsubscribeBooks();
                unsubscribeLoans();
                unsubscribeClassLoans();
                unsubscribeLocations();
                unsubscribeStudents();
                unsubscribeSettings();
                unsubscribeReadingLogs();
                // Clear local data
                books = []; loans = []; classLoans = []; locations = []; students = []; readingLogs = [];
                renderAll();
            }
        });
        
        showRegisterBtn.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form-container').classList.add('hidden'); document.getElementById('register-form-container').classList.remove('hidden'); });
        showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-form-container').classList.add('hidden'); document.getElementById('login-form-container').classList.remove('hidden'); });
        registerForm.addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; const errorP = document.getElementById('register-error'); errorP.textContent = ''; createUserWithEmailAndPassword(auth, email, password).catch(error => { errorP.textContent = 'ការចុះឈ្មោះបានបរាជ័យ: ' + error.message; }); });
        loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const errorP = document.getElementById('login-error'); errorP.textContent = ''; signInWithEmailAndPassword(auth, email, password).catch(error => { errorP.textContent = 'ការចូលប្រើបានបរាជ័យ: ' + error.message; }); });
        logoutBtn.addEventListener('click', () => { signOut(auth); });

        // --- NAVIGATION ---
        const navigateTo = (pageId) => {
            pages.forEach(page => page.classList.add('hidden'));
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }

            navLinks.forEach(nav => {
                if (nav.getAttribute('data-page') === pageId) {
                    nav.classList.add('bg-gray-900', 'text-white');
                    nav.classList.remove('text-gray-300');
                } else {
                    nav.classList.remove('bg-gray-900', 'text-white');
                    nav.classList.add('text-gray-300');
                }
            });

            // Auto-focus or setup for specific pages
            if (pageId === 'class-loans') {
                populateClassLoanForm();
                setTimeout(() => document.getElementById('class-loan-isbn-input').focus(), 100);
            }
            if (pageId === 'loans') {
                window.clearLoanForm();
            }
             if (pageId === 'student-cards') {
                renderStudentCards(); 
            }
            if (pageId === 'reading-log') {
                window.clearReadingLogForm();
                setTimeout(() => document.getElementById('reading-log-student-id').focus(), 100);
            }
        };

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.getAttribute('data-page');
                navigateTo(pageId);
            });
        });

        // --- RENDERING FUNCTIONS ---
        const renderAll = () => {
            renderBooks();
            renderLoans();
            renderClassLoans();
            renderLocations();
            renderStudents();
            renderStudentCards();
            renderReadingLogs();
            updateDashboard();
        };

        const renderBooks = () => {
            const bookList = document.getElementById('book-list');
            const searchBooksInput = document.getElementById('search-books');
            const searchTerm = searchBooksInput.value.toLowerCase();
            const filteredBooks = books.filter(book => book.title.toLowerCase().includes(searchTerm) || (book.author && book.author.toLowerCase().includes(searchTerm)) || (book.isbn && book.isbn.toLowerCase().includes(searchTerm)));
            bookList.innerHTML = '';
            if (filteredBooks.length === 0) { bookList.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-gray-500">រកមិនឃើញសៀវភៅទេ។</td></tr>`; return; }
            const sortedBooks = [...filteredBooks].sort((a,b) => a.title.localeCompare(b.title));
            sortedBooks.forEach((book, index) => {
                const loanedCount = loans.filter(loan => loan.bookId === book.id && loan.status === 'ខ្ចី').length;
                const remaining = (book.quantity || 0) - loanedCount;
                const location = locations.find(loc => loc.id === book.locationId);
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="p-3">${index + 1}</td>
                    <td class="p-3">${book.title} ${loanedCount > 0 ? `<span class="text-xs bg-yellow-200 text-yellow-800 rounded-full px-2 py-1 ml-2 no-print">ខ្ចី ${loanedCount}</span>` : ''}</td>
                    <td class="p-3">${book.author || ''}</td>
                    <td class="p-3">${book.isbn || ''}</td>
                    <td class="p-3">${book.quantity || 0}</td>
                    <td class="p-3 font-bold ${remaining > 0 ? 'text-green-600' : 'text-red-600'}">${remaining}</td>
                    <td class="p-3">${location ? location.name : 'N/A'}</td>
                    <td class="p-3">${book.source || ''}</td>
                    <td class="p-3 no-print"><button onclick="window.editBook('${book.id}')" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button><button onclick="window.deleteBook('${book.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>
                `;
                bookList.appendChild(row);
            });
        };

        const renderLoans = () => {
            const loanList = document.getElementById('loan-list');
            const searchLoansInput = document.getElementById('search-loans');
            const loanSummary = document.getElementById('loan-summary');
            const startDate = document.getElementById('loan-filter-start-date').value;
            const endDate = document.getElementById('loan-filter-end-date').value;

            const individualLoans = loans.filter(loan => !loan.classLoanId);
            
            // Date Filtering
            let dateFilteredLoans = individualLoans;
            if (startDate) {
                dateFilteredLoans = dateFilteredLoans.filter(loan => loan.loanDate >= startDate);
            }
            if (endDate) {
                dateFilteredLoans = dateFilteredLoans.filter(loan => loan.loanDate <= endDate);
            }

            // Gender Summary
            let maleCount = 0;
            let femaleCount = 0;
            dateFilteredLoans.forEach(loan => {
                if (loan.borrowerGender === 'ប្រុស' || loan.borrowerGender === 'M') maleCount++;
                if (loan.borrowerGender === 'ស្រី' || loan.borrowerGender === 'F') femaleCount++;
            });
            loanSummary.textContent = `សរុប: ${dateFilteredLoans.length} នាក់ (ប្រុស: ${maleCount} នាក់, ស្រី: ${femaleCount} នាក់)`;

            // Search Term Filtering
            const searchTerm = searchLoansInput.value.toLowerCase();
            const filteredLoans = dateFilteredLoans.filter(loan => { 
                const book = books.find(b => b.id === loan.bookId); 
                return (loan.borrower && loan.borrower.toLowerCase().includes(searchTerm)) || (book && book.title.toLowerCase().includes(searchTerm)); 
            });
            
            loanList.innerHTML = '';
            if (filteredLoans.length === 0) { loanList.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">រកមិនឃើញកំណត់ត្រាខ្ចីទេ។</td></tr>`; return; }
            
            const sortedLoans = [...filteredLoans].sort((a,b) => new Date(b.loanDate) - new Date(a.loanDate));
            sortedLoans.forEach((loan, index) => {
                const book = books.find(b => b.id === loan.bookId);
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `<td class="p-3">${index + 1}</td><td class="p-3">${book ? book.title : 'សៀវភៅត្រូវបានលុប'}</td><td class="p-3">${loan.borrower}</td><td class="p-3">${loan.loanDate}</td><td class="p-3">${loan.returnDate || 'N/A'}</td><td class="p-3"><span class="px-2 py-1 text-xs rounded-full ${loan.status === 'ខ្ចី' ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800'}">${loan.status}</span></td><td class="p-3 no-print">${loan.status === 'ខ្ចី' ? `<button onclick="window.returnBook('${loan.id}')" class="text-green-500 hover:text-green-700 mr-2" title="សម្គាល់ថាសងវិញ"><i class="fas fa-undo"></i></button>` : ''}<button onclick="window.deleteLoan('${loan.id}')" class="text-red-500 hover:text-red-700" title="លុបកំណត់ត្រា"><i class="fas fa-trash"></i></button></td>`;
                loanList.appendChild(row);
            });
        };

        const renderClassLoans = () => {
            const classLoanList = document.getElementById('class-loan-list');
            const selectedClass = document.getElementById('class-loan-filter-select').value;
            
            let filtered = classLoans;
            if (selectedClass) {
                filtered = filtered.filter(loan => loan.className === selectedClass);
            }

            classLoanList.innerHTML = '';
            if (filtered.length === 0) { classLoanList.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">មិនទាន់មានប្រវត្តិខ្ចីតាមថ្នាក់ទេ។</td></tr>`; return; }
            
            const sortedClassLoans = [...filtered].sort((a,b) => new Date(b.loanDate) - new Date(a.loanDate));
            sortedClassLoans.forEach((loan, index) => {
                const book = books.find(b => b.id === loan.bookId);
                const row = document.createElement('tr');
                row.className = 'border-b';
                const isFullyReturned = (loan.returnedCount || 0) >= loan.loanedQuantity;
                row.innerHTML = `
                    <td class="p-3">${index + 1}</td>
                    <td class="p-3">${book ? book.title : 'សៀវភៅត្រូវបានលុប'}</td>
                    <td class="p-3">${loan.className}</td>
                    <td class="p-3">${loan.loanDate}</td>
                    <td class="p-3">
                        <span class="font-bold ${isFullyReturned ? 'text-green-600' : 'text-orange-600'}">
                            សងបាន: ${loan.returnedCount || 0} / ${loan.loanedQuantity}
                        </span>
                    </td>
                    <td class="p-3 no-print">
                        ${!isFullyReturned ? `<button onclick="window.openClassReturnModal('${loan.id}')" class="text-teal-500 hover:text-teal-700 mr-2" title="សងសៀវភៅ"><i class="fas fa-book-reader"></i></button>` : ''}
                        <button onclick="window.openClassLoanEditModal('${loan.id}')" class="text-blue-500 hover:text-blue-700 mr-2" title="កែប្រែ"><i class="fas fa-edit"></i></button>
                        <button onclick="window.deleteClassLoan('${loan.id}')" class="text-red-500 hover:text-red-700" title="លុបប្រវត្តិនេះ"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                classLoanList.appendChild(row);
            });
        };
        
        const renderLocations = () => {
            const locationList = document.getElementById('location-list');
            const searchLocationsInput = document.getElementById('search-locations');
            const searchTerm = searchLocationsInput.value.toLowerCase();
            const filteredLocations = locations.filter(loc => loc.name.toLowerCase().includes(searchTerm));
            locationList.innerHTML = '';
            if (filteredLocations.length === 0) { locationList.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">រកមិនឃើញទីតាំងទេ។</td></tr>`; return; }
            const sortedLocations = [...filteredLocations].sort((a,b) => a.name.localeCompare(b.name));
            sortedLocations.forEach((loc, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `<td class="p-3">${index + 1}</td><td class="p-3">${loc.name}</td><td class="p-3">${loc.source || ''}</td><td class="p-3">${loc.year || ''}</td><td class="p-3 no-print"><button onclick="window.editLocation('${loc.id}')" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button><button onclick="window.deleteLocation('${loc.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>`;
                locationList.appendChild(row);
            });
        };

        const renderStudents = () => {
            const studentList = document.getElementById('student-list');
            const studentListHeader = document.getElementById('student-list-header');
            const searchStudentsInput = document.getElementById('search-students');
            const classFilter = document.getElementById('student-class-filter'); // Get the filter
            const duplicateListContainer = document.getElementById('duplicate-student-list');
            
            duplicateListContainer.innerHTML = ''; // Clear previous results

            if (students.length > 0) {
                const idKey = Object.keys(students[0]).find(k => k.toLowerCase().includes('អត្តលេខ'));
                const lastNameKey = Object.keys(students[0]).find(k => k.includes('នាមត្រកូល'));
                const firstNameKey = Object.keys(students[0]).find(k => k.includes('នាមខ្លួន'));
                const noKey = 'ល.រ';

                if (idKey) {
                    const idMap = new Map();
                    students.forEach(student => {
                        const studentId = (student[idKey] || '').trim();
                        if (studentId) {
                            if (!idMap.has(studentId)) {
                                idMap.set(studentId, []);
                            }
                            idMap.get(studentId).push(student);
                        }
                    });

                    const duplicates = [];
                    for (const studentGroup of idMap.values()) {
                        if (studentGroup.length > 1) {
                            duplicates.push(...studentGroup);
                        }
                    }

                    if (duplicates.length > 0) {
                        let html = '<div class="font-sans"><strong>អត្តលេខស្ទួន៖</strong><ul>';
                        duplicates.forEach(student => {
                            const fullName = `${student[lastNameKey] || ''} ${student[firstNameKey] || ''}`.trim();
                            html += `<li class="ml-4">- ល.រ: ${student[noKey] || 'N/A'}, អត្តលេខ: ${student[idKey]}, ឈ្មោះ: ${fullName}</li>`;
                        });
                        html += '</ul></div>';
                        duplicateListContainer.innerHTML = html;
                    }
                }
            }

            const searchTerm = searchStudentsInput.value.toLowerCase();
            const selectedClass = classFilter.value; 
            const classKey = students.length > 0 ? Object.keys(students[0]).find(k => k.includes('ថ្នាក់')) : null;

            let filteredStudents = students;

            // Filter by class first
            if (selectedClass && classKey) {
                filteredStudents = filteredStudents.filter(student => student[classKey] === selectedClass);
            }

            // Then filter by search term
            if (searchTerm) {
                filteredStudents = filteredStudents.filter(student => {
                    return Object.values(student).some(value =>
                        String(value).toLowerCase().includes(searchTerm)
                    );
                });
            }

            studentList.innerHTML = '';
            studentListHeader.innerHTML = '';

            if (filteredStudents.length === 0) {
                studentList.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-gray-500">មិនទាន់មានទិន្នន័យសិស្ស ឬរកមិនឃើញ។</td></tr>`;
                return;
            }

            const headers = ['ល.រ', 'អត្តលេខ', 'នាមត្រកូល', 'នាមខ្លួន', 'ភេទ', 'ថ្ងៃខែឆ្នាំកំណើត', 'ថ្នាក់', 'រូបថត URL', 'សកម្មភាព'];
            
            const sortedStudents = [...filteredStudents].sort((a, b) => {
                const numA = parseInt(a['ល.រ'], 10) || 0;
                const numB = parseInt(b['ល.រ'], 10) || 0;
                return numA - numB;
            });

            // Render headers
            let headerHTML = '';
            headers.forEach(header => {
                const thClass = header === 'សកម្មភាព' ? 'p-3 no-print' : 'p-3';
                headerHTML += `<th class="${thClass}">${header}</th>`;
            });
            studentListHeader.innerHTML = headerHTML;

            // Render rows
            sortedStudents.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                
                let rowHTML = '';
                headers.slice(0, -1).forEach(header => { // All headers except 'Actions'
                    rowHTML += `<td class="p-3">${student[header] || ''}</td>`;
                });
                
                // Add actions cell
                rowHTML += `
                    <td class="p-3 no-print">
                        <button onclick="window.openStudentModal('${student.id}')" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="window.deleteStudent('${student.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </td>`;

                row.innerHTML = rowHTML;
                studentList.appendChild(row);
            });
        };

        const renderReadingLogs = () => {
            const readingLogHistory = document.getElementById('reading-log-history');
            const readingLogSummary = document.getElementById('reading-log-summary');
            const startDate = document.getElementById('reading-log-filter-start-date').value;
            const endDate = document.getElementById('reading-log-filter-end-date').value;

            let filtered = readingLogs;
            if (startDate) {
                filtered = filtered.filter(log => log.dateTime.split('T')[0] >= startDate);
            }
            if (endDate) {
                filtered = filtered.filter(log => log.dateTime.split('T')[0] <= endDate);
            }

            // Gender Summary
            let maleCount = 0;
            let femaleCount = 0;
            filtered.forEach(log => {
                if (log.studentGender === 'ប្រុស' || log.studentGender === 'M') maleCount++;
                if (log.studentGender === 'ស្រី' || log.studentGender === 'F') femaleCount++;
            });
            readingLogSummary.textContent = `សរុប: ${filtered.length} នាក់ (ប្រុស: ${maleCount} នាក់, ស្រី: ${femaleCount} នាក់)`;

            readingLogHistory.innerHTML = '';
            if(filtered.length === 0) {
                readingLogHistory.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">មិនទាន់មានប្រវត្តិការចូលអានទេ។</td></tr>`;
                return;
            }

            const sortedLogs = [...filtered].sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));
            sortedLogs.forEach((log, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                const booksRead = log.books.map(b => b.title).join(', ');
                row.innerHTML = `
                    <td class="p-3">${index + 1}</td>
                    <td class="p-3">${new Date(log.dateTime).toLocaleString('en-GB')}</td>
                    <td class="p-3">${log.studentName}</td>
                    <td class="p-3">${booksRead}</td>
                    <td class="p-3 no-print">
                        <button onclick="window.deleteReadingLog('${log.id}')" class="text-red-500 hover:text-red-700" title="លុប"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                readingLogHistory.appendChild(row);
            });
        };
        
        const updateDashboard = () => {
            document.getElementById('total-books').textContent = books.length;
            const totalQuantity = books.reduce((sum, book) => sum + (parseInt(book.quantity, 10) || 0), 0);
            document.getElementById('total-quantity').textContent = totalQuantity;
            const activeLoans = loans.filter(l => l.status === 'ខ្ចី').length;
            document.getElementById('total-loans').textContent = activeLoans;
        };

        const populateClassLoanFilter = () => {
            const classLoanFilterSelect = document.getElementById('class-loan-filter-select');
            classLoanFilterSelect.innerHTML = '<option value="">-- ថ្នាក់ទាំងអស់ --</option>';
            if (students.length > 0) {
                const classKey = Object.keys(students[0]).find(k => k.includes('ថ្នាក់'));
                if (classKey) {
                    const uniqueClasses = [...new Set(students.map(s => s[classKey]))].filter(Boolean).sort();
                    uniqueClasses.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        classLoanFilterSelect.appendChild(option);
                    });
                }
            }
        };
        
        // START: NEW FUNCTION TO POPULATE STUDENT PAGE CLASS FILTER
        const populateStudentClassFilter = () => {
            const classFilter = document.getElementById('student-class-filter');
            // Only populate if there are students and the filter is empty (or has only the 'all' option)
            if (!students.length || (classFilter.options.length > 1 && classFilter.value !== '')) { 
                return;
            }

            const classKey = Object.keys(students[0]).find(k => k.includes('ថ្នាក់'));
            if (!classKey) return;

            // Get unique classes, filter out any empty values, and sort them naturally (e.g., 1, 2, 10)
            const uniqueClasses = [...new Set(students.map(s => s[classKey]))]
                .filter(Boolean)
                .sort((a, b) => a.localeCompare(b, undefined, {numeric: true})); 
            
            const currentVal = classFilter.value; // Save current selection
            classFilter.innerHTML = '<option value="">-- ថ្នាក់ទាំងអស់ --</option>'; 

            uniqueClasses.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });

            // Set default to the smallest class if no class was previously selected
            if (!currentVal && uniqueClasses.length > 0) {
                classFilter.value = uniqueClasses[0];
            } else {
                classFilter.value = currentVal; // Restore previous selection
            }
        };
        // END: NEW FUNCTION

        // --- STUDENT CARD PAGE ---
        function renderStudentCards() {
            if (!document.getElementById('page-student-cards')) return;

            const container = document.getElementById("student-card-container");
            const loading = document.getElementById("loading-cards");
            const classFilter = document.getElementById("card-class-filter");
            const searchBox = document.getElementById("card-search-box");
            
            // Update the dynamic style for the card background
            let styleElement = document.getElementById('dynamic-card-style');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'dynamic-card-style';
                document.head.appendChild(styleElement);
            }
            const cardBgUrl = settingsData.cardBgUrl || 'https://i.imgur.com/s46369v.png'; // Default MOEYS logo
            styleElement.innerHTML = `#page-student-cards .card::before { background-image: url('${cardBgUrl}'); }`;


            // Populate class filter only once
            if (classFilter.options.length <= 1 && students.length > 0) {
                const classKey = Object.keys(students[0]).find(k => k.includes('ថ្នាក់'));
                if (classKey) {
                    const classSet = new Set(students.map(std => std[classKey]).filter(Boolean));
                    [...classSet].sort((a, b) => a.localeCompare(b, undefined, {numeric: true})).forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls;
                        option.textContent = cls;
                        classFilter.appendChild(option);
                    });
                }
            }
            
            const selectedClass = classFilter.value;
            const keyword = searchBox.value.toLowerCase();
            const classKey = students.length > 0 ? Object.keys(students[0]).find(k => k.includes('ថ្នាក់')) : null;
            const nameKey = students.length > 0 ? Object.keys(students[0]).find(k => k.includes('នាមខ្លួន')) : null;
            const lastNameKey = students.length > 0 ? Object.keys(students[0]).find(k => k.includes('នាមត្រកូល')) : null;
            const idKey = students.length > 0 ? Object.keys(students[0]).find(k => k.toLowerCase().includes('អត្តលេខ')) : null;

            const filteredStudents = students.filter(std => {
                const fullName = `${std[lastNameKey] || ''} ${std[nameKey] || ''}`.toLowerCase();
                const studentId = (std[idKey] || '').toLowerCase();
                const classMatch = !selectedClass || (classKey && std[classKey] === selectedClass);
                const keywordMatch = !keyword || fullName.includes(keyword) || studentId.includes(keyword);
                return classMatch && keywordMatch;
            });

            loading.style.display = "none";
            container.style.display = "flex";
            container.innerHTML = "";

            if (filteredStudents.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 w-full p-4">រកមិនឃើញទិន្នន័យសិស្សទេ។</p>`;
                return;
            }

            const schoolName = settingsData.schoolName || 'ឈ្មោះសាលា';
            const academicYear = settingsData.academicYear || 'YYYY-YYYY';
            const sealUrl = settingsData.sealImageUrl || '';

            filteredStudents.forEach(std => {
                const cardDiv = document.createElement("div");
                cardDiv.className = "card";
                const qrId = `qr-${std.id}`;
                const barcodeId = `barcode-${std.id}`;
                
                const dobKey = Object.keys(std).find(k => k.includes('ថ្ងៃខែឆ្នាំកំណើត'));
                const genderKey = Object.keys(std).find(k => k.includes('ភេទ'));
                const photoUrlKey = Object.keys(std).find(k => k.includes('រូបថត URL'));
                
                const fullName = `${std[lastNameKey] || ''} ${std[nameKey] || ''}`.trim();
                const studentClass = classKey ? `${std[classKey]}` : '';
                const studentId = idKey ? std[idKey] : '';
                const dob = dobKey ? std[dobKey] : '';
                const gender = genderKey ? std[genderKey] : '';
                const photoUrl = photoUrlKey && std[photoUrlKey] ? std[photoUrlKey].trim() : null;

                const photoElement = photoUrl 
                    ? `<img class="photo" src="${photoUrl}" alt="Photo" onerror="this.onerror=null;this.src='https://placehold.co/108x108/e2e8f0/7d7d7d?text=Error';"/>`
                    : `<div class="photo no-photo"></div>`;

                cardDiv.innerHTML = `
                  <div>
                    <div class="school-name">${schoolName}</div>
                    <div class="student-name">${fullName}</div>
                    <div class="info-and-qr">
                      <div class="info">
                        <div><b>អត្តលេខ:</b> ${studentId}</div>
                        <div><b>ថ្នាក់:</b> ${studentClass}</div>
                        <div><b>ឆ្នាំសិក្សា:</b> ${academicYear}</div>
                        <div><b>ភេទ:</b> ${gender}</div>
                      </div>
                      <div id="${qrId}" class="qr"></div>
                    </div>
                  </div>
                  <div class="barcode-container">
                     <svg id="${barcodeId}"></svg>
                  </div>
                  <div class="photo-wrapper">
                    ${photoElement}
                    ${sealUrl ? `<img class="stamp" src="${sealUrl}" alt="Stamp" />` : ''}
                  </div>
                `;
                container.appendChild(cardDiv);

                if (studentId && window.QRCode) {
                    new QRCode(document.getElementById(qrId), {
                      text: studentId,
                      width: 70,
                      height: 70,
                      correctLevel: QRCode.CorrectLevel.H
                    });
                }
                
                if (studentId && window.JsBarcode) {
                     try {
                        JsBarcode(`#${barcodeId}`, studentId, {
                            format: "CODE128",
                            height: 30,
                            width: 1.8,
                            displayValue: false,
                            margin: 0
                        });
                    } catch (e) {
                        console.error("Barcode generation failed for ID:", studentId, e);
                        // Optionally hide the barcode container if it fails
                        document.getElementById(barcodeId).style.display = 'none';
                    }
                }
            });
        }

        // --- FIREBASE REALTIME LISTENERS ---
        const setupRealtimeListeners = (userId) => {
            const booksRef = collection(db, "users", userId, "books");
            unsubscribeBooks = onSnapshot(query(booksRef), (snapshot) => { books = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderAll(); });

            const loansRef = collection(db, "users", userId, "loans");
            unsubscribeLoans = onSnapshot(query(loansRef), (snapshot) => { loans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderAll(); });
            
            const classLoansRef = collection(db, "users", userId, "classLoans");
            unsubscribeClassLoans = onSnapshot(query(classLoansRef), (snapshot) => { classLoans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderAll(); });
            
            const locationsRef = collection(db, "users", userId, "locations");
            unsubscribeLocations = onSnapshot(query(locationsRef), (snapshot) => { locations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderAll(); });

            const studentsRef = collection(db, "users", userId, "students");
            unsubscribeStudents = onSnapshot(query(studentsRef), (snapshot) => { 
                students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                populateClassLoanFilter();
                populateStudentClassFilter(); // Call the new function
                renderAll(); 
            });
            
            const readingLogsRef = collection(db, "users", userId, "readingLogs");
            unsubscribeReadingLogs = onSnapshot(query(readingLogsRef), (snapshot) => { readingLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderAll(); });
            
            const settingsRef = doc(db, "users", userId, "settings", "generalInfo");
            unsubscribeSettings = onSnapshot(settingsRef, (doc) => {
                const schoolNameInput = document.getElementById('school-name-input');
                const schoolNameDisplay = document.getElementById('school-name-display');
                const saveSchoolNameBtn = document.getElementById('save-school-name-btn');
                const editSchoolNameBtn = document.getElementById('edit-school-name-btn');
                const deleteSchoolNameBtn = document.getElementById('delete-school-name-btn');
                const academicYearInput = document.getElementById('academic-year-input');
                const academicYearDisplay = document.getElementById('academic-year-display');
                const saveAcademicYearBtn = document.getElementById('save-academic-year-btn');
                const editAcademicYearBtn = document.getElementById('edit-academic-year-btn');
                const deleteAcademicYearBtn = document.getElementById('delete-academic-year-btn');
                const sealImageUrlInput = document.getElementById('seal-image-url');
                const sealImagePreview = document.getElementById('seal-image-preview');
                const googleSheetUrlInput = document.getElementById('google-sheet-url');
                const cardBgUrlInput = document.getElementById('card-bg-url');
                const cardBgPreview = document.getElementById('card-bg-preview');
                const printSchoolName = document.getElementById('print-school-name');

                if (doc.exists()) {
                    settingsData = doc.data(); // Store settings data globally
                    const data = doc.data();
                    
                    // Update School Name UI
                    if (data.schoolName) {
                        sidebarSchoolName.textContent = data.schoolName;
                        if(printSchoolName) printSchoolName.textContent = data.schoolName;
                        schoolNameDisplay.textContent = data.schoolName;
                        schoolNameInput.value = data.schoolName;
                        schoolNameDisplay.classList.remove('hidden');
                        schoolNameInput.classList.add('hidden');
                        saveSchoolNameBtn.classList.add('hidden');
                        editSchoolNameBtn.classList.remove('hidden');
                        deleteSchoolNameBtn.classList.remove('hidden');
                    } else {
                        sidebarSchoolName.textContent = '';
                        if(printSchoolName) printSchoolName.textContent = '';
                        schoolNameDisplay.classList.add('hidden');
                        schoolNameInput.classList.remove('hidden');
                        saveSchoolNameBtn.classList.remove('hidden');
                        editSchoolNameBtn.classList.add('hidden');
                        deleteSchoolNameBtn.classList.add('hidden');
                    }

                    // Update Academic Year UI
                    if (data.academicYear) {
                        academicYearDisplay.textContent = data.academicYear;
                        academicYearInput.value = data.academicYear;
                        academicYearDisplay.classList.remove('hidden');
                        academicYearInput.classList.add('hidden');
                        saveAcademicYearBtn.classList.add('hidden');
                        editAcademicYearBtn.classList.remove('hidden');
                        deleteAcademicYearBtn.classList.remove('hidden');
                    } else {
                        academicYearDisplay.classList.add('hidden');
                        academicYearInput.classList.remove('hidden');
                        saveAcademicYearBtn.classList.remove('hidden');
                        editAcademicYearBtn.classList.add('hidden');
                        deleteAcademicYearBtn.classList.add('hidden');
                    }

                    // Update Seal Image UI
                    if (data.sealImageUrl) {
                        sealImageUrlInput.value = data.sealImageUrl;
                        sealImagePreview.src = data.sealImageUrl;
                    } else {
                         sealImageUrlInput.value = '';
                         sealImagePreview.src = 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=Preview';
                    }

                    // Update Card Background UI
                    if (data.cardBgUrl) {
                        cardBgUrlInput.value = data.cardBgUrl;
                        cardBgPreview.src = data.cardBgUrl;
                    } else {
                         cardBgUrlInput.value = '';
                         cardBgPreview.src = 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=Preview';
                    }
                    
                    // Update Google Sheet URL
                    if (googleSheetUrlInput) {
                        googleSheetUrlInput.value = data.googleSheetUrl || '';
                    }

                } else {
                    settingsData = {}; // Reset if no data
                    sidebarSchoolName.textContent = ''; // Clear sidebar school name
                    if(printSchoolName) printSchoolName.textContent = '';
                    // Reset all fields to default state
                    schoolNameDisplay.classList.add('hidden');
                    schoolNameInput.classList.remove('hidden');
                    saveSchoolNameBtn.classList.remove('hidden');
                    editSchoolNameBtn.classList.add('hidden');
                    deleteSchoolNameBtn.classList.add('hidden');
                    
                    academicYearDisplay.classList.add('hidden');
                    academicYearInput.classList.remove('hidden');
                    saveAcademicYearBtn.classList.remove('hidden');
                    editAcademicYearBtn.classList.add('hidden');
                    deleteAcademicYearBtn.classList.add('hidden');

                    sealImageUrlInput.value = '';
                    sealImagePreview.src = 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=Preview';
                    cardBgUrlInput.value = '';
                    cardBgPreview.src = 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=Preview';
                    if (googleSheetUrlInput) {
                       googleSheetUrlInput.value = '';
                    }
                }
                renderStudentCards();
            });
            
            // --- SEARCH BOX LISTENERS ---
            document.getElementById('search-books').addEventListener('input', renderBooks);
            document.getElementById('search-loans').addEventListener('input', renderLoans);
            document.getElementById('search-locations').addEventListener('input', renderLocations);
            document.getElementById('search-students').addEventListener('input', renderStudents);
            document.getElementById('student-class-filter').addEventListener('change', renderStudents); // Add listener for new filter
            
            // Add event listeners for the student card filters
            document.getElementById('card-class-filter')?.addEventListener('change', renderStudentCards);
            document.getElementById('card-search-box')?.addEventListener('input', renderStudentCards);
            
            // --- EXPORT BUTTON LISTENER ---
            document.getElementById('export-excel-btn').addEventListener('click', exportData);
        };

        // --- GOOGLE SHEET & STUDENT DATA ---
        document.getElementById('save-url-btn').addEventListener('click', async () => {
            if (!currentUserId) return;
            const url = document.getElementById('google-sheet-url').value.trim();
            if (!url) { alert('សូមបញ្ចូល Link ជាមុនសិន'); return; }
            try {
                const settingsRef = doc(db, "users", currentUserId, "settings", "generalInfo");
                await setDoc(settingsRef, { googleSheetUrl: url }, { merge: true });
                alert('រក្សាទុក Link បានជោគជ័យ!');
            } catch (e) { console.error("Error saving URL: ", e); alert('ការរក្សាទុក Link បានបរាជ័យ។'); }
        });

        document.getElementById('fetch-data-btn').addEventListener('click', async () => {
            const url = document.getElementById('google-sheet-url').value.trim();
            if (!url) { alert('សូមបញ្ចូល Link Google Sheet ជាមុនសិន។'); return; }
            if (!url.includes('/pub?output=csv')) { alert('Link មិនត្រឹមត្រូវ។ សូមប្រាកដថា Link បាន Publish ជា CSV។'); return; }

            loadingOverlay.classList.remove('hidden');
            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(url));
                if (!response.ok) { throw new Error(`Network response was not ok, status: ${response.status}`); }
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                if (parsedData.length === 0) { alert('មិនអាចញែកទិន្នន័យពី CSV បានទេ ឬក៏ Sheet មិនមានទិន្នន័យ។'); return; }
                await syncStudentsToFirestore(parsedData);
                alert(`បានទាញយក និងរក្សាទុកទិន្នន័យសិស្ស ${parsedData.length} នាក់ដោយជោគជ័យ។`);
            } catch (error) { console.error('Failed to fetch or process student data:', error); alert('ការទាញយកទិន្នន័យបានបរាជ័យ។ សូមពិនិត្យមើល Link, ការតភ្ជាប់ Internet, ឬសាកល្បងម្ដងទៀត។');
            } finally { loadingOverlay.classList.add('hidden'); }
        });

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            const data = lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((header, index) => { obj[header] = values[index] ? values[index].trim() : ''; });
                return obj;
            });
            return data;
        }

        async function syncStudentsToFirestore(studentData) {
            if (!currentUserId) return;
            const studentsRef = collection(db, "users", currentUserId, "students");
            const existingStudentsSnapshot = await getDocs(studentsRef);
            const deleteBatch = writeBatch(db);
            existingStudentsSnapshot.forEach(doc => { deleteBatch.delete(doc.ref); });
            await deleteBatch.commit();
            const addBatch = writeBatch(db);
            studentData.forEach(student => { const newStudentRef = doc(studentsRef); addBatch.set(newStudentRef, student); });
            await addBatch.commit();
        }

        // --- BOOK MANAGEMENT ---
        window.openBookModal = (id = null) => {
            const bookForm = document.getElementById('book-form');
            bookForm.reset(); document.getElementById('book-id').value = '';
            const locationSelect = document.getElementById('book-location-id');
            locationSelect.innerHTML = '<option value="">-- សូមជ្រើសរើសទីតាំង --</option>';
            locations.forEach(loc => { const option = document.createElement('option'); option.value = loc.id; option.textContent = loc.name; locationSelect.appendChild(option); });
            if (id) {
                const book = books.find(b => b.id === id);
                if (book) {
                    document.getElementById('book-modal-title').textContent = 'កែសម្រួលព័ត៌មានសៀវភៅ';
                    document.getElementById('book-id').value = book.id;
                    document.getElementById('title').value = book.title;
                    document.getElementById('author').value = book.author || '';
                    document.getElementById('isbn').value = book.isbn || '';
                    document.getElementById('quantity').value = book.quantity || 0;
                    document.getElementById('book-location-id').value = book.locationId || '';
                    document.getElementById('source').value = book.source || '';
                }
            } else { document.getElementById('book-modal-title').textContent = 'បន្ថែមសៀវភៅថ្មី'; }
            document.getElementById('book-modal').classList.remove('hidden');
        };
        window.closeBookModal = () => document.getElementById('book-modal').classList.add('hidden');
        window.editBook = (id) => openBookModal(id);
        window.deleteBook = async (id) => {
            if (!currentUserId) return;
            if (confirm('តើអ្នកពិតជាចង់លុបសៀវភៅនេះមែនទេ?')) {
                const isLoaned = loans.some(loan => loan.bookId === id && loan.status === 'ខ្ចី');
                if (isLoaned) { alert('មិនអាចលុបសៀវភៅនេះបានទេ ព្រោះកំពុងមានគេខ្ចី។'); return; }
                try { await deleteDoc(doc(db, "users", currentUserId, "books", id)); } catch (e) { console.error("Error deleting document: ", e); }
            }
        };
        
        document.getElementById('book-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            
            const id = document.getElementById('book-id').value;
            const isbnValue = document.getElementById('isbn').value.trim();
            
            const bookData = {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                isbn: isbnValue,
                quantity: parseInt(document.getElementById('quantity').value, 10) || 0,
                locationId: document.getElementById('book-location-id').value,
                source: document.getElementById('source').value,
            };

            if (!bookData.locationId) {
                alert('សូមជ្រើសរើសទីតាំងរក្សាទុក!');
                return;
            }

            if (bookData.isbn) {
                const booksRef = collection(db, "users", currentUserId, "books");
                const q = query(booksRef, where("isbn", "==", bookData.isbn));
                
                try {
                    const querySnapshot = await getDocs(q);
                    let isDuplicate = false;
                    
                    if (!querySnapshot.empty) {
                        if (id) { 
                            if (querySnapshot.docs[0].id !== id) {
                                isDuplicate = true;
                            }
                        } else { 
                            isDuplicate = true;
                        }
                    }

                    if (isDuplicate) {
                        alert(`លេខ ISBN "${bookData.isbn}" នេះមានក្នុងប្រព័ន្ធរួចហើយ។ សូមប្រើលេខផ្សេង។`);
                        return; 
                    }
                } catch (err) {
                    console.error("Error checking for duplicate ISBN:", err);
                    alert("មានបញ្ហាក្នុងការត្រួតពិនិត្យ ISBN។ សូមព្យាយាមម្តងទៀត។");
                    return;
                }
            }
            
            try {
                if (id) {
                    await setDoc(doc(db, "users", currentUserId, "books", id), bookData);
                } else {
                    await addDoc(collection(db, "users", currentUserId, "books"), bookData);
                }
                closeBookModal();
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                alert("ការរក្សាទុកទិន្នន័យបានបរាជ័យ។");
            }
        });


        // --- LOAN MANAGEMENT (INDIVIDUAL) ---
        window.clearLoanForm = () => {
            document.getElementById('loan-form').reset();
            document.getElementById('loan-book-id').value = '';
            document.getElementById('loan-borrower-gender').value = '';
            document.getElementById('loan-book-error').textContent = '';
            document.getElementById('loan-student-error').textContent = '';
            setTimeout(() => document.getElementById('loan-isbn-input').focus(), 100);
        };
        
        document.getElementById('loan-isbn-input').addEventListener('input', () => {
            const isbn = document.getElementById('loan-isbn-input').value.trim();
            const bookIdInput = document.getElementById('loan-book-id');
            const loanBookTitleDisplay = document.getElementById('loan-book-title-display');
            const loanBookError = document.getElementById('loan-book-error');
            loanBookTitleDisplay.value = ''; bookIdInput.value = ''; loanBookError.textContent = '';
            if (!isbn) return;
            const foundBook = books.find(b => b.isbn && b.isbn.toLowerCase() === isbn.toLowerCase());
            if(foundBook) {
                const loanedCount = loans.filter(loan => loan.bookId === foundBook.id && loan.status === 'ខ្ចី').length;
                const remaining = (foundBook.quantity || 0) - loanedCount;
                if (remaining > 0) { 
                    loanBookTitleDisplay.value = `${foundBook.title}`; 
                    bookIdInput.value = foundBook.id; 
                } else { 
                    loanBookError.textContent = 'សៀវភៅនេះអស់ពីស្តុកហើយ'; 
                }
            } else { 
                loanBookError.textContent = 'រកមិនឃើញ ISBN នេះទេ'; 
            }
        });

        document.getElementById('loan-student-id-input').addEventListener('input', () => {
            const studentId = document.getElementById('loan-student-id-input').value.trim();
            const loanBorrowerNameDisplay = document.getElementById('loan-borrower-name-display');
            const loanStudentError = document.getElementById('loan-student-error');
            const borrowerGenderInput = document.getElementById('loan-borrower-gender');
            loanBorrowerNameDisplay.value = ''; loanStudentError.textContent = ''; borrowerGenderInput.value = '';
            if (!studentId) return;
            const studentIdKey = students.length > 0 ? Object.keys(students[0]).find(k => k.toLowerCase().includes('អត្តលេខ')) : null;
            if (!studentIdKey) { loanStudentError.textContent = 'រកមិនឃើញជួរឈរ "អត្តលេខ" ទេ។'; return; }
            const foundStudent = students.find(s => s[studentIdKey] && s[studentIdKey].trim() === studentId);
            if (foundStudent) {
                const lastNameKey = Object.keys(foundStudent).find(k => k.includes('នាមត្រកូល'));
                const firstNameKey = Object.keys(foundStudent).find(k => k.includes('នាមខ្លួន'));
                const classKey = Object.keys(foundStudent).find(k => k.includes('ថ្នាក់'));
                const genderKey = Object.keys(foundStudent).find(k => k.includes('ភេទ'));
                const studentFullName = `${foundStudent[lastNameKey] || ''} ${foundStudent[firstNameKey] || ''}`.trim();
                const studentClass = foundStudent[classKey] || '';
                loanBorrowerNameDisplay.value = studentClass ? `${studentFullName} - ${studentClass}` : studentFullName;
                borrowerGenderInput.value = foundStudent[genderKey] || '';
            } else { 
                loanStudentError.textContent = 'រកមិនឃើញអត្តលេខសិស្សនេះទេ។'; 
            }
        });

        document.getElementById('loan-form').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            if (!currentUserId) return;
            const bookId = document.getElementById('loan-book-id').value;
            const borrower = document.getElementById('loan-borrower-name-display').value;
            if (!bookId || !borrower) { 
                alert('សូមបំពេញព័ត៌មានឲ្យបានត្រឹមត្រូវ!'); 
                return; 
            }
            const newLoan = { 
                bookId: bookId, 
                borrower: borrower, 
                borrowerGender: document.getElementById('loan-borrower-gender').value,
                loanDate: new Date().toISOString().split('T')[0], 
                returnDate: null, 
                status: 'ខ្ចី' 
            };
            try { 
                await addDoc(collection(db, "users", currentUserId, "loans"), newLoan); 
                clearLoanForm();
            } 
            catch(e) { console.error("Error adding loan: ", e); }
        });

        window.returnBook = async (id) => {
            if (!currentUserId) return;
            if (confirm('តើអ្នកពិតជាចង់សម្គាល់ថាសៀវភៅនេះត្រូវបានសងវិញមែនទេ?')) {
                try { await updateDoc(doc(db, "users", currentUserId, "loans", id), { status: 'សងវិញ', returnDate: new Date().toISOString().split('T')[0] }); } catch(e) { console.error("Error returning book: ", e); }
            }
        };
        window.deleteLoan = async (id) => {
            if (!currentUserId) return;
            if (confirm('តើអ្នកពិតជាចង់លុបកំណត់ត្រានេះមែនទេ?')) {
                try { await deleteDoc(doc(db, "users", currentUserId, "loans", id)); } catch (e) { console.error("Error deleting loan: ", e); }
            }
        };

        // --- LOAN MANAGEMENT (CLASS) ---
        const classLoanClassSelect = document.getElementById('class-loan-class-select');
        const classInfoText = document.getElementById('class-info-text');

        // START: NEW function to update loan count based on checkboxes
        window.updateClassLoanCount = () => {
            const checkedStudents = document.querySelectorAll('#class-loan-student-list-container input[type="checkbox"]:checked');
            document.getElementById('class-loan-quantity').value = checkedStudents.length;
        };
        // END: NEW function

        function populateClassLoanForm() {
            document.getElementById('class-loan-form').reset();
            document.getElementById('class-loan-book-id').value = '';
            document.getElementById('class-loan-book-error').textContent = '';
            document.getElementById('class-info-text').textContent = '';
            const studentListContainer = document.getElementById('class-loan-student-list-container');
            studentListContainer.innerHTML = '';
            studentListContainer.classList.add('hidden');
            window.updateClassLoanCount(); // Reset count to 0

            const classKey = students.length > 0 ? Object.keys(students[0]).find(k => k.includes('ថ្នាក់')) : null;
            classLoanClassSelect.innerHTML = '<option value="">-- សូមជ្រើសរើសថ្នាក់ --</option>';
            if (classKey) {
                const uniqueClasses = [...new Set(students.map(s => s[classKey]))].filter(Boolean).sort();
                uniqueClasses.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className; option.textContent = className;
                    classLoanClassSelect.appendChild(option);
                });
            }
        }

        document.getElementById('class-loan-isbn-input').addEventListener('input', () => {
            const isbn = document.getElementById('class-loan-isbn-input').value.trim();
            const bookIdInput = document.getElementById('class-loan-book-id');
            const classLoanBookTitleDisplay = document.getElementById('class-loan-book-title-display');
            const classLoanBookError = document.getElementById('class-loan-book-error');
            classLoanBookTitleDisplay.value = ''; bookIdInput.value = ''; classLoanBookError.textContent = '';
            if (!isbn) return;
            const foundBook = books.find(b => b.isbn && b.isbn.toLowerCase() === isbn.toLowerCase());
            if(foundBook) {
                const loanedCount = loans.filter(loan => loan.bookId === foundBook.id && loan.status === 'ខ្ចី').length;
                const remaining = (foundBook.quantity || 0) - loanedCount;
                classLoanBookTitleDisplay.value = `${foundBook.title} (នៅសល់ ${remaining})`;
                bookIdInput.value = foundBook.id;
            } else { classLoanBookError.textContent = 'រកមិនឃើញ ISBN នេះទេ'; }
        });
        
        // START: MODIFIED event listener for class selection
        classLoanClassSelect.addEventListener('change', () => {
            const className = classLoanClassSelect.value;
            const studentListContainer = document.getElementById('class-loan-student-list-container');
            
            studentListContainer.innerHTML = ''; // Clear previous list
            studentListContainer.classList.add('hidden'); // Hide by default

            if (!className) {
                classInfoText.textContent = '';
                window.updateClassLoanCount(); // Update count to 0
                return;
            }

            const classKey = students.length > 0 ? Object.keys(students[0]).find(k => k.includes('ថ្នាក់')) : null;
            if (!classKey) {
                classInfoText.textContent = 'Error: Cannot find class data.';
                return;
            }
            const studentsInClass = students.filter(s => s[classKey] === className);

            classInfoText.textContent = `ថ្នាក់នេះមានសិស្ស ${studentsInClass.length} នាក់`;

            if (studentsInClass.length > 0) {
                studentListContainer.classList.remove('hidden');
                const lastNameKey = Object.keys(studentsInClass[0]).find(k => k.includes('នាមត្រកូល'));
                const firstNameKey = Object.keys(studentsInClass[0]).find(k => k.includes('នាមខ្លួន'));
                const genderKey = Object.keys(studentsInClass[0]).find(k => k.includes('ភេទ'));

                const listGrid = document.createElement('div');
                listGrid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2';

                studentsInClass.forEach(student => {
                    const studentFullName = `${student[lastNameKey] || ''} ${student[firstNameKey] || ''}`.trim();
                    const studentGender = student[genderKey] || '';

                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 p-1 rounded hover:bg-gray-200 cursor-pointer';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'form-checkbox h-4 w-4 text-cyan-600 border-gray-300 rounded focus:ring-cyan-500';
                    checkbox.checked = true; // Default to checked
                    checkbox.dataset.fullName = studentFullName;
                    checkbox.dataset.gender = studentGender;
                    
                    checkbox.addEventListener('change', window.updateClassLoanCount);

                    const span = document.createElement('span');
                    span.className = 'text-gray-800 text-sm';
                    span.textContent = studentFullName;

                    label.appendChild(checkbox);
                    label.appendChild(span);
                    listGrid.appendChild(label);
                });
                studentListContainer.appendChild(listGrid);
            }
            // Initial count update
            window.updateClassLoanCount();
        });
        // END: MODIFIED event listener

        // START: MODIFIED form submission logic
        document.getElementById('class-loan-form').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            if (!currentUserId) return;

            const bookId = document.getElementById('class-loan-book-id').value;
            const className = classLoanClassSelect.value;
            const checkedStudentCheckboxes = document.querySelectorAll('#class-loan-student-list-container input[type="checkbox"]:checked');
            const quantity = checkedStudentCheckboxes.length;

            if (!bookId || !className || quantity === 0) {
                alert('សូមជ្រើសរើសសៀវភៅ, ថ្នាក់, និងសិស្សយ៉ាងហោចណាស់ម្នាក់។');
                return;
            }
            
            const selectedBook = books.find(b => b.id === bookId);
            if (!selectedBook) {
                alert('រកមិនឃើញព័ត៌មានសៀវភៅទេ។');
                return;
            }
            const currentlyLoanedCount = loans.filter(l => l.bookId === bookId && l.status === 'ខ្ចី').length;
            const availableCopies = selectedBook.quantity - currentlyLoanedCount;

            if (quantity > availableCopies) {
                alert(`សៀវភៅមិនគ្រប់គ្រាន់! អ្នកចង់ខ្ចី ${quantity} ក្បាល, ប៉ុន្តែនៅសល់តែ ${availableCopies} ក្បាលសម្រាប់ខ្ចី។`);
                return;
            }

            loadingOverlay.classList.remove('hidden');
            try {
                const batch = writeBatch(db);
                const today = new Date().toISOString().split('T')[0];
                
                const newClassLoanRef = doc(collection(db, "users", currentUserId, "classLoans"));
                batch.set(newClassLoanRef, { 
                    bookId: bookId, 
                    className: className, 
                    loanedQuantity: quantity, 
                    loanDate: today, 
                    returnedCount: 0, 
                    status: 'ខ្ចី' 
                });
                
                const loansRef = collection(db, "users", currentUserId, "loans");
                
                checkedStudentCheckboxes.forEach(checkbox => {
                    const borrowerText = `${checkbox.dataset.fullName} - ${className}`;
                    const newLoan = { 
                        bookId: bookId, 
                        borrower: borrowerText, 
                        loanDate: today, 
                        returnDate: null, 
                        status: 'ខ្ចី', 
                        classLoanId: newClassLoanRef.id, 
                        borrowerGender: checkbox.dataset.gender || '' 
                    };
                    batch.set(doc(loansRef), newLoan);
                });

                await batch.commit();
                populateClassLoanForm(); // Reset the form completely
            } catch (err) { 
                console.error("Error creating class loan: ", err); 
                alert("មានបញ្ហាកើតឡើងពេលបង្កើតកំណត់ត្រា។");
            } finally { 
                loadingOverlay.classList.add('hidden'); 
            }
        });
        // END: MODIFIED form submission logic
        
        window.openClassReturnModal = (id) => {
            const classReturnForm = document.getElementById('class-return-form');
            classReturnForm.reset();
            const classLoan = classLoans.find(cl => cl.id === id);
            if (!classLoan) return;
            const book = books.find(b => b.id === classLoan.bookId);
            document.getElementById('class-return-loan-id').value = id;
            document.getElementById('class-return-book-title').textContent = book ? book.title : 'N/A';
            document.getElementById('class-return-class-name').textContent = classLoan.className;
            document.getElementById('class-return-total-students').textContent = classLoan.loanedQuantity;
            document.getElementById('class-return-already-returned').textContent = classLoan.returnedCount || 0;
            const numberInput = document.getElementById('number-to-return');
            const maxReturn = classLoan.loanedQuantity - (classLoan.returnedCount || 0);
            numberInput.max = maxReturn;
            numberInput.placeholder = `អតិបរមា ${maxReturn}`;
            document.getElementById('class-return-modal').classList.remove('hidden');
        };

        window.closeClassReturnModal = () => document.getElementById('class-return-modal').classList.add('hidden');

        document.getElementById('class-return-form').addEventListener('submit', async (e) => {
            e.preventDefault(); if (!currentUserId) return;
            const id = document.getElementById('class-return-loan-id').value;
            const numberToReturn = parseInt(document.getElementById('number-to-return').value, 10);
            const classLoan = classLoans.find(cl => cl.id === id);
            if (!classLoan) return;
            const maxReturn = classLoan.loanedQuantity - (classLoan.returnedCount || 0);
            if (isNaN(numberToReturn) || numberToReturn <= 0 || numberToReturn > maxReturn) { alert(`សូមបញ្ចូលចំនួន hợp lệ ما بين 1 និង ${maxReturn}។`); return; }
            loadingOverlay.classList.remove('hidden');
            try {
                const batch = writeBatch(db);
                const classLoanRef = doc(db, "users", currentUserId, "classLoans", id);
                const q = query(collection(db, "users", currentUserId, "loans"), where("classLoanId", "==", id), where("status", "==", "ខ្ចី"));
                const querySnapshot = await getDocs(q);
                const loansToUpdate = querySnapshot.docs.slice(0, numberToReturn);
                const today = new Date().toISOString().split('T')[0];
                loansToUpdate.forEach(doc => { batch.update(doc.ref, { status: 'សងវិញ', returnDate: today }); });
                const newReturnedCount = (classLoan.returnedCount || 0) + numberToReturn;
                const newStatus = newReturnedCount >= classLoan.loanedQuantity ? 'សង hết' : 'សងខ្លះ';
                batch.update(classLoanRef, { returnedCount: increment(numberToReturn), status: newStatus });
                await batch.commit();
                closeClassReturnModal();
            } catch (err) { console.error("Error updating class loan return: ", err); alert("មានបញ្ហាក្នុងការរក្សាទុកការសង។");
            } finally { loadingOverlay.classList.add('hidden'); }
        });

        window.openClassLoanEditModal = (id) => {
            const classLoan = classLoans.find(cl => cl.id === id);
            if (!classLoan) return;
            const book = books.find(b => b.id === classLoan.bookId);
            document.getElementById('class-loan-edit-id').value = id;
            document.getElementById('class-loan-edit-book-title').textContent = book ? book.title : 'N/A';
            document.getElementById('class-loan-edit-class-name').textContent = classLoan.className;
            document.getElementById('class-loan-edit-date').value = classLoan.loanDate;
            document.getElementById('class-loan-edit-modal').classList.remove('hidden');
        };

        window.closeClassLoanEditModal = () => document.getElementById('class-loan-edit-modal').classList.add('hidden');

        document.getElementById('class-loan-edit-form').addEventListener('submit', async (e) => {
            e.preventDefault(); if (!currentUserId) return;
            const id = document.getElementById('class-loan-edit-id').value;
            const newDate = document.getElementById('class-loan-edit-date').value;
            if (!newDate) { alert("សូមជ្រើសរើសកាលបរិច្ឆេទ។"); return; }
            loadingOverlay.classList.remove('hidden');
            try {
                const batch = writeBatch(db);
                const classLoanRef = doc(db, "users", currentUserId, "classLoans", id);
                batch.update(classLoanRef, { loanDate: newDate });
                const q = query(collection(db, "users", currentUserId, "loans"), where("classLoanId", "==", id));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => { batch.update(doc.ref, { loanDate: newDate }); });
                await batch.commit();
                alert("បានកែប្រែកាលបរិច្ឆេទខ្ចីដោយជោគជ័យ។");
                closeClassLoanEditModal();
            } catch (err) { console.error("Error editing class loan date: ", err); alert("ការកែប្រែបានបរាជ័យ។");
            } finally { loadingOverlay.classList.add('hidden'); }
        });

        window.deleteClassLoan = async (id) => {
            if (!currentUserId) return;
            if (confirm('តើអ្នកពិតជាចង់លុបប្រវត្តិនៃការខ្ចីតាមថ្នាក់នេះមែនទេ? ការធ្វើបែបនេះនឹងលុបកំណត់ត្រាខ្ចីរបស់សិស្សទាំងអស់ដែលពាក់ព័ន្ធនឹងการខ្ចីនេះ។')) {
                loadingOverlay.classList.remove('hidden');
                try {
                    const batch = writeBatch(db);
                    const q = query(collection(db, "users", currentUserId, "loans"), where("classLoanId", "==", id));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => { batch.delete(doc.ref); });
                    const classLoanRef = doc(db, "users", currentUserId, "classLoans", id);
                    batch.delete(classLoanRef);
                    await batch.commit();
                } catch (e) { console.error("Error deleting class loan and associated loans: ", e); alert("ការលុបបានបរាជ័យ។");
                } finally { loadingOverlay.classList.add('hidden'); }
            }
        };

        // --- LOCATION MANAGEMENT ---
        window.openLocationModal = (id = null) => {
            const locationForm = document.getElementById('location-form');
            locationForm.reset(); document.getElementById('location-id').value = '';
            if (id) {
                const loc = locations.find(l => l.id === id);
                if (loc) {
                    document.getElementById('location-modal-title').textContent = 'កែសម្រួលទីតាំង';
                    document.getElementById('location-id').value = loc.id;
                    document.getElementById('location-name').value = loc.name;
                    document.getElementById('location-source').value = loc.source || '';
                    document.getElementById('location-year').value = loc.year || '';
                }
            } else { document.getElementById('location-modal-title').textContent = 'បន្ថែមទីតាំងថ្មី'; }
            document.getElementById('location-modal').classList.remove('hidden');
        };
        window.closeLocationModal = () => document.getElementById('location-modal').classList.add('hidden');
        window.editLocation = (id) => openLocationModal(id);
        window.deleteLocation = async (id) => {
            if (!currentUserId) return;
            if (confirm('តើអ្នកពិតជាចង់លុបទីតាំងនេះមែនទេ?')) {
                const isUsed = books.some(book => book.locationId === id);
                if (isUsed) { alert('មិនអាចលុបទីតាំងនេះបានទេ ព្រោះកំពុងប្រើប្រាស់ដោយសៀវភៅ។'); return; }
                try { await deleteDoc(doc(db, "users", currentUserId, "locations", id)); } catch (e) { console.error("Error deleting location: ", e); }
            }
        };
        document.getElementById('location-form').addEventListener('submit', async (e) => {
            e.preventDefault(); if (!currentUserId) return;
            const id = document.getElementById('location-id').value;
            const locData = { name: document.getElementById('location-name').value, source: document.getElementById('location-source').value, year: document.getElementById('location-year').value, };
            try { if (id) { await setDoc(doc(db, "users", currentUserId, "locations", id), locData); } else { await addDoc(collection(db, "users", currentUserId, "locations"), locData); } closeLocationModal(); } catch (e) { console.error("Error adding/updating location: ", e); }
        });

        // --- STUDENT MANAGEMENT ---
        window.openStudentModal = (id = null) => {
            const studentForm = document.getElementById('student-form');
            studentForm.reset();
            document.getElementById('student-id').value = '';
            const modalTitle = document.getElementById('student-modal-title');
            
            if (id) {
                const student = students.find(s => s.id === id);
                if (student) {
                    modalTitle.textContent = 'កែសម្រួលព័ត៌មានសិស្ស';
                    document.getElementById('student-id').value = student.id;
                    document.getElementById('student-no').value = student['ល.រ'] || '';
                    document.getElementById('student-code').value = student['អត្តលេខ'] || '';
                    document.getElementById('student-lastname').value = student['នាមត្រកូល'] || '';
                    document.getElementById('student-firstname').value = student['នាមខ្លួន'] || '';
                    document.getElementById('student-gender').value = student['ភេទ'] || 'ប្រុស';
                    document.getElementById('student-dob').value = student['ថ្ងៃខែឆ្នាំកំណើត'] || '';
                    document.getElementById('student-class').value = student['ថ្នាក់'] || '';
                    document.getElementById('student-photo-url').value = student['រូបថត URL'] || '';
                }
            } else {
                modalTitle.textContent = 'បន្ថែមសិស្សថ្មី';
                // Intelligent "ល.រ" logic
                let nextStudentNo = 1;
                if (students.length > 0) {
                    const existingNos = students
                        .map(s => parseInt(s['ល.រ'], 10))
                        .filter(n => !isNaN(n));
                    
                    const noSet = new Set(existingNos);
                    let i = 1;
                    while (true) {
                        if (!noSet.has(i)) {
                            nextStudentNo = i;
                            break;
                        }
                        i++;
                    }
                }
                document.getElementById('student-no').value = nextStudentNo;
            }
            document.getElementById('student-modal').classList.remove('hidden');
        };

        window.closeStudentModal = () => {
            document.getElementById('student-modal').classList.add('hidden');
        };

        window.deleteStudent = async (id) => {
            if (!currentUserId) return;
            if (confirm('តើអ្នកពិតជាចង់លុបข้อมูลសិស្សនេះមែនទេ?')) {
                try {
                    await deleteDoc(doc(db, "users", currentUserId, "students", id));
                } catch (e) {
                    console.error("Error deleting student: ", e);
                    alert("ការលុបបានបរាជ័យ។");
                }
            }
        };

        document.getElementById('student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;

            const studentId = document.getElementById('student-id').value;
            const studentData = {
                'ល.រ': document.getElementById('student-no').value,
                'អត្តលេខ': document.getElementById('student-code').value,
                'នាមត្រកូល': document.getElementById('student-lastname').value,
                'នាមខ្លួន': document.getElementById('student-firstname').value,
                'ភេទ': document.getElementById('student-gender').value,
                'ថ្ងៃខែឆ្នាំកំណើត': document.getElementById('student-dob').value,
                'ថ្នាក់': document.getElementById('student-class').value,
                'រូបថត URL': document.getElementById('student-photo-url').value,
            };

            if (!studentData['អត្តលេខ'] || !studentData['នាមត្រកូល'] || !studentData['នាមខ្លួន']) {
                alert('សូមបំពេញអត្តលេខ, នាមត្រកូល, និងនាមខ្លួន។');
                return;
            }

            try {
                if (studentId) {
                    // Update existing student
                    await setDoc(doc(db, "users", currentUserId, "students", studentId), studentData);
                } else {
                    // Add new student
                    await addDoc(collection(db, "users", currentUserId, "students"), studentData);
                }
                closeStudentModal();
            } catch (err) {
                console.error("Error saving student data: ", err);
                alert("ការរក្សាទុកទិន្នន័យសិស្សបានបរាជ័យ។");
            }
        });


        // --- READING LOG MANAGEMENT ---
        let isbnScanTimer = null;

        // MODIFIED: Prevent Enter key from submitting the form and handle scan flow
        document.getElementById('reading-log-form').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault(); // Always prevent the default form submission on Enter

                const activeElement = document.activeElement;

                // If Enter is pressed in the student ID field, move focus to the ISBN field
                if (activeElement && activeElement.id === 'reading-log-student-id') {
                    document.getElementById('reading-log-isbn-input').focus();
                    return; 
                }

                // If Enter is pressed in the ISBN field, process the ISBN immediately
                if (activeElement && activeElement.id === 'reading-log-isbn-input') {
                    clearTimeout(isbnScanTimer); // Stop any pending input event timer
                    
                    const isbnInput = document.getElementById('reading-log-isbn-input');
                    const isbn = isbnInput.value.trim();
                    if (!isbn) return;

                    const foundBook = books.find(b => b.isbn && b.isbn.toLowerCase() === isbn.toLowerCase());
                    if (foundBook) {
                        if (!currentScannedBooks.some(b => b.id === foundBook.id)) {
                            currentScannedBooks.push({ id: foundBook.id, title: foundBook.title });
                            const li = document.createElement('li');
                            li.textContent = foundBook.title;
                            document.getElementById('scanned-books-list').appendChild(li);
                        }
                        isbnInput.value = ''; // Clear input after successful scan
                    }
                    // If book is not found, do nothing, leave the value for correction.
                }
            }
        });

        window.clearReadingLogForm = () => {
            document.getElementById('reading-log-form').reset();
            document.getElementById('reading-log-student-name').value = '';
            document.getElementById('reading-log-student-obj-id').value = '';
            document.getElementById('reading-log-student-error').textContent = '';
            document.getElementById('scanned-books-list').innerHTML = '';
            currentScannedBooks = [];
            currentStudentGender = '';
            document.getElementById('reading-log-student-id').focus();
        };

        document.getElementById('reading-log-student-id').addEventListener('input', () => {
            const studentId = document.getElementById('reading-log-student-id').value.trim();
            const studentNameInput = document.getElementById('reading-log-student-name');
            const studentObjIdInput = document.getElementById('reading-log-student-obj-id');
            const studentError = document.getElementById('reading-log-student-error');
            studentNameInput.value = ''; studentObjIdInput.value = ''; studentError.textContent = ''; currentStudentGender = '';
            if (!studentId) return;
            const studentIdKey = students.length > 0 ? Object.keys(students[0]).find(k => k.toLowerCase().includes('អត្តលេខ')) : null;
            if (!studentIdKey) { studentError.textContent = 'រកមិនឃើញជួរឈរ "អត្តលេខ" ទេ។'; return; }
            const foundStudent = students.find(s => s[studentIdKey] && s[studentIdKey].trim() === studentId);
            if (foundStudent) {
                const lastNameKey = Object.keys(foundStudent).find(k => k.includes('នាមត្រកូល'));
                const firstNameKey = Object.keys(foundStudent).find(k => k.includes('នាមខ្លួន'));
                const classKey = Object.keys(foundStudent).find(k => k.includes('ថ្នាក់'));
                const genderKey = Object.keys(foundStudent).find(k => k.includes('ភេទ'));
                const studentFullName = `${foundStudent[lastNameKey] || ''} ${foundStudent[firstNameKey] || ''}`.trim();
                const studentClass = foundStudent[classKey] || '';
                studentNameInput.value = studentClass ? `${studentFullName} - ${studentClass}` : studentFullName;
                studentObjIdInput.value = foundStudent.id;
                currentStudentGender = foundStudent[genderKey] || '';
                document.getElementById('reading-log-isbn-input').focus();
            } else { studentError.textContent = 'រកមិនឃើញអត្តលេខសិស្សនេះទេ។'; }
        });

        document.getElementById('reading-log-isbn-input').addEventListener('input', () => {
            clearTimeout(isbnScanTimer);
            isbnScanTimer = setTimeout(() => {
                const isbnInput = document.getElementById('reading-log-isbn-input');
                const isbn = isbnInput.value.trim();
                if (!isbn) return;
                const foundBook = books.find(b => b.isbn && b.isbn.toLowerCase() === isbn.toLowerCase());
                if (foundBook) {
                    if (!currentScannedBooks.some(b => b.id === foundBook.id)) {
                        currentScannedBooks.push({ id: foundBook.id, title: foundBook.title });
                        const li = document.createElement('li');
                        li.textContent = foundBook.title;
                        document.getElementById('scanned-books-list').appendChild(li);
                    }
                    isbnInput.value = '';
                }
            }, 300); 
        });

        document.getElementById('reading-log-form').addEventListener('submit', async (e) => {
            e.preventDefault(); if (!currentUserId) return;
            const studentId = document.getElementById('reading-log-student-obj-id').value;
            const studentName = document.getElementById('reading-log-student-name').value;
            if (!studentId || !studentName) { alert('សូមស្កេនអត្តលេខសិស្សជាមុនសិន។'); return; }
            if (currentScannedBooks.length === 0) { alert('សូមស្កេនសៀវភៅយ៉ាងហោចណាស់មួយក្បាល។'); return; }
            const logData = { studentId: studentId, studentName: studentName, studentGender: currentStudentGender, books: currentScannedBooks, dateTime: new Date().toISOString() };
            try { await addDoc(collection(db, "users", currentUserId, "readingLogs"), logData); window.clearReadingLogForm(); } 
            catch (err) { console.error("Error saving reading log: ", err); alert("ការរក្សាទុកកំណត់ត្រាចូលអានបានបរាជ័យ។"); }
        });
        
        window.deleteReadingLog = async (id) => {
             if (!currentUserId) return;
             if (confirm('តើអ្នកពិតជាចង់លុបកំណត់ត្រាចូលអាននេះមែនទេ?')) {
                 try { await deleteDoc(doc(db, "users", currentUserId, "readingLogs", id)); } 
                 catch (e) { console.error("Error deleting reading log: ", e); alert("ការលុបបានបរាជ័យ។"); }
             }
        };

        // --- EXPORT DATA TO EXCEL ---
        const exportData = () => {
            const select = document.getElementById('export-data-select');
            const dataType = select.value;

            if (!dataType) {
                alert('សូមជ្រើសរើសប្រភេទទិន្នន័យដែលត្រូវនាំចេញជាមុនសិន។');
                return;
            }

            let dataToExport = [];
            let fileName = `${dataType}_export.xlsx`;
            
            switch (dataType) {
                case 'books':
                    dataToExport = books.map(book => {
                        const location = locations.find(loc => loc.id === book.locationId);
                        return {
                            'ចំណងជើង': book.title,
                            'អ្នកនិពន្ធ': book.author,
                            'ISBN': book.isbn,
                            'ចំនួនសរុប': book.quantity,
                            'ទីតាំង': location ? location.name : 'N/A',
                            'ប្រភព': book.source
                        };
                    });
                    break;
                case 'loans':
                    dataToExport = loans.filter(l => !l.classLoanId).map(loan => {
                        const book = books.find(b => b.id === loan.bookId);
                        return {
                            'សៀវភៅ': book ? book.title : 'N/A',
                            'អ្នកខ្ចី': loan.borrower,
                            'ភេទ': loan.borrowerGender,
                            'ថ្ងៃខ្ចី': loan.loanDate,
                            'ថ្ងៃសង': loan.returnDate,
                            'ស្ថានភាព': loan.status
                        };
                    });
                    break;
                case 'class-loans':
                    dataToExport = classLoans.map(loan => {
                        const book = books.find(b => b.id === loan.bookId);
                        return {
                            'សៀវភៅ': book ? book.title : 'N/A',
                            'ថ្នាក់': loan.className,
                            'ថ្ងៃខ្ចី': loan.loanDate,
                            'ចំនួនខ្ចី': loan.loanedQuantity,
                            'ចំនួនបានសង': loan.returnedCount || 0,
                            'ស្ថានភាព': loan.status
                        };
                    });
                    break;
                case 'reading-logs':
                    dataToExport = readingLogs.map(log => ({
                        'កាលបរិច្ឆេទ': new Date(log.dateTime).toLocaleString('en-GB'),
                        'ឈ្មោះសិស្ស': log.studentName,
                        'ភេទ': log.studentGender,
                        'សៀវភៅបានអាន': log.books.map(b => b.title).join('; ')
                    }));
                    break;
                case 'locations':
                    dataToExport = locations.map(loc => ({
                        'ឈ្មោះទីតាំង': loc.name,
                        'ប្រភពធ្នើ': loc.source,
                        'ឆ្នាំ': loc.year
                    }));
                    break;
                case 'students':
                    dataToExport = students.map(std => {
                        // Create a new object to control property order
                        const studentData = {};
                        studentData['ល.រ'] = std['ល.រ'];
                        studentData['អត្តលេខ'] = std['អត្តលេខ'];
                        studentData['នាមត្រកូល'] = std['នាមត្រកូល'];
                        studentData['នាមខ្លួន'] = std['នាមខ្លួន'];
                        studentData['ភេទ'] = std['ភេទ'];
                        studentData['ថ្ងៃខែឆ្នាំកំណើត'] = std['ថ្ងៃខែឆ្នាំកំណើត'];
                        studentData['ថ្នាក់'] = std['ថ្នាក់'];
                        studentData['រូបថត URL'] = std['រូបថត URL'];
                        return studentData;
                    });
                    break;
                case 'settings':
                    dataToExport = Object.entries(settingsData).map(([key, value]) => ({
                        'ការកំណត់': key,
                        'តម្លៃ': value
                    }));
                    break;
            }

            if (dataToExport.length === 0) {
                alert('មិនមានទិន្នន័យសម្រាប់នាំចេញទេ។');
                return;
            }

            // Using SheetJS to create and download the Excel file
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Data');
            XLSX.writeFile(workbook, fileName);
        };


        // --- SETTINGS & DATA DELETION ---
        window.openPasswordConfirmModal = (collectionName) => {
            document.getElementById('collection-to-delete').value = collectionName;
            document.getElementById('password-confirm-modal').classList.remove('hidden');
            document.getElementById('user-password').focus();
            document.getElementById('password-error').textContent = '';
        };

        window.closePasswordConfirmModal = () => {
            document.getElementById('password-confirm-modal').classList.add('hidden');
            document.getElementById('password-confirm-form').reset();
        };

        document.getElementById('password-confirm-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const password = document.getElementById('user-password').value;
            const collectionName = document.getElementById('collection-to-delete').value;
            const passwordError = document.getElementById('password-error');
            passwordError.textContent = '';

            if (!password || !collectionName) return;

            loadingOverlay.classList.remove('hidden');

            const credential = EmailAuthProvider.credential(user.email, password);
            
            try {
                await reauthenticateWithCredential(user, credential);
                // Re-authentication successful, proceed with deletion
                await deleteAllData(collectionName);
                closePasswordConfirmModal();
            } catch (error) {
                console.error("Re-authentication failed:", error);
                passwordError.textContent = "ពាក្យសម្ងាត់មិនត្រឹមត្រូវ។";
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        async function deleteAllData(collectionName) {
            if (!currentUserId) return;
            
            const collectionRef = collection(db, "users", currentUserId, collectionName);
            try {
                const querySnapshot = await getDocs(collectionRef);
                const batch = writeBatch(db);
                querySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                alert(`បានលុបទិន្នន័យទាំងអស់ក្នុង "${collectionName}" ដោយជោគជ័យ។`);
            } catch (error) {
                console.error(`Error deleting all documents from ${collectionName}:`, error);
                alert(`ការលុបទិន្នន័យក្នុង "${collectionName}" បានបរាជ័យ។`);
            }
        }

        // --- SETTINGS GENERAL INFO LISTENERS ---
        const saveSchoolNameBtn = document.getElementById('save-school-name-btn');
        const editSchoolNameBtn = document.getElementById('edit-school-name-btn');
        const deleteSchoolNameBtn = document.getElementById('delete-school-name-btn');
        const schoolNameInput = document.getElementById('school-name-input');
        const schoolNameDisplay = document.getElementById('school-name-display');

        saveSchoolNameBtn.addEventListener('click', async () => {
            const name = schoolNameInput.value.trim();
            if (!name) { alert('សូមបញ្ចូលឈ្មោះសាលា។'); return; }
            const settingsRef = doc(db, "users", currentUserId, "settings", "generalInfo");
            try {
                await setDoc(settingsRef, { schoolName: name }, { merge: true });
                alert('រក្សាទុកឈ្មោះសាលាបានជោគជ័យ។');
            } catch (e) { console.error(e); alert('ការរក្សាទុកបានបរាជ័យ។'); }
        });

        editSchoolNameBtn.addEventListener('click', () => {
            schoolNameDisplay.classList.add('hidden');
            schoolNameInput.classList.remove('hidden');
            saveSchoolNameBtn.classList.remove('hidden');
            editSchoolNameBtn.classList.add('hidden');
            deleteSchoolNameBtn.classList.add('hidden');
            schoolNameInput.focus();
        });

        deleteSchoolNameBtn.addEventListener('click', async () => {
            if (confirm('តើអ្នកពិតជាចង់លុបឈ្មោះសាលាមែនទេ?')) {
                const settingsRef = doc(db, "users", currentUserId, "settings", "generalInfo");
                try {
                    await updateDoc(settingsRef, { schoolName: deleteField() });
                    alert('បានលុបឈ្មោះសាលា។');
                } catch (e) { console.error(e); alert('ការលុបបានបរាជ័យ។'); }
            }
        });

        // Academic Year Listeners
        const saveAcademicYearBtn = document.getElementById('save-academic-year-btn');
        const editAcademicYearBtn = document.getElementById('edit-academic-year-btn');
        const deleteAcademicYearBtn = document.getElementById('delete-academic-year-btn');
        const academicYearInput = document.getElementById('academic-year-input');
        const academicYearDisplay = document.getElementById('academic-year-display');

        saveAcademicYearBtn.addEventListener('click', async () => {
            const year = academicYearInput.value.trim();
            if (!year) { alert('សូមបញ្ចូលឆ្នាំសិក្សា។'); return; }
            const settingsRef = doc(db, "users", currentUserId, "settings", "generalInfo");
            try {
                await setDoc(settingsRef, { academicYear: year }, { merge: true });
                alert('រក្សាទុកឆ្នាំសិក្សាបានជោគជ័យ។');
            } catch (e) { console.error(e); alert('ការរក្សាទុកបានបរាជ័យ។'); }
        });

        editAcademicYearBtn.addEventListener('click', () => {
            academicYearDisplay.classList.add('hidden');
            academicYearInput.classList.remove('hidden');
            saveAcademicYearBtn.classList.remove('hidden');
            editAcademicYearBtn.classList.add('hidden');
            deleteAcademicYearBtn.classList.add('hidden');
            academicYearInput.focus();
        });

        deleteAcademicYearBtn.addEventListener('click', async () => {
            if (confirm('តើអ្នកពិតជាចង់លុបឆ្នាំសិក្សាមែនទេ?')) {
                const settingsRef = doc(db, "users", currentUserId, "settings", "generalInfo");
                try {
                    await updateDoc(settingsRef, { academicYear: deleteField() });
                    alert('បានលុបឆ្នាំសិក្សា។');
                } catch (e) { console.error(e); alert('ការលុបបានបរាជ័យ។'); }
            }
        });


        const sealImageUrlInput = document.getElementById('seal-image-url');
        const sealImagePreview = document.getElementById('seal-image-preview');
        const saveSealUrlBtn = document.getElementById('save-seal-url-btn');

        sealImageUrlInput.addEventListener('input', () => {
            const url = sealImageUrlInput.value.trim();
            if (url) {
                sealImagePreview.src = url;
            } else {
                sealImagePreview.src = 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=Preview';
            }
        });
        
        sealImagePreview.onerror = () => {
            sealImagePreview.src = 'https://placehold.co/100x100/e2e8f0/ff0000?text=Error';
        };

        saveSealUrlBtn.addEventListener('click', async () => {
            const url = sealImageUrlInput.value.trim();
            const settingsRef = doc(db, "users", currentUserId, "settings", "generalInfo");
            try {
                if (url) {
                    await setDoc(settingsRef, { sealImageUrl: url }, { merge: true });
                    alert('រក្សាទុក URL ត្រាបានជោគជ័យ។');
                } else {
                    await updateDoc(settingsRef, { sealImageUrl: deleteField() });
                    alert('បានលុប URL ត្រា។');
                }
            } catch (e) { console.error(e); alert('ការរក្សាទុកបានបរាជ័យ។'); }
        });

        // Card Background Listeners
        const cardBgUrlInput = document.getElementById('card-bg-url');
        const cardBgPreview = document.getElementById('card-bg-preview');
        const saveCardBgBtn = document.getElementById('save-card-bg-btn');

        cardBgUrlInput.addEventListener('input', () => {
            const url = cardBgUrlInput.value.trim();
            cardBgPreview.src = url || 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=Preview';
        });

        cardBgPreview.onerror = () => {
            cardBgPreview.src = 'https://placehold.co/100x100/e2e8f0/ff0000?text=Error';
        };

        saveCardBgBtn.addEventListener('click', async () => {
            const url = cardBgUrlInput.value.trim();
            const settingsRef = doc(db, "users", currentUserId, "settings", "generalInfo");
            try {
                if (url) {
                    await setDoc(settingsRef, { cardBgUrl: url }, { merge: true });
                    alert('រក្សាទុក URL ផ្ទៃខាងក្រោយកាតបានជោគជ័យ។');
                } else {
                    await updateDoc(settingsRef, { cardBgUrl: deleteField() });
                    alert('បានលុប URL ផ្ទៃខាងក្រោយកាត។');
                }
            } catch (e) { console.error(e); alert('ការរក្សាទុកបានបរាជ័យ។'); }
        });


        // --- CHANGE PASSWORD LISTENER ---
        const changePasswordForm = document.getElementById('change-password-form');
        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const errorP = document.getElementById('change-password-error');
            const successP = document.getElementById('change-password-success');

            errorP.textContent = '';
            successP.textContent = '';

            if (newPassword !== confirmPassword) {
                errorP.textContent = 'ពាក្យសម្ងាត់ថ្មី និងការยืนยันមិនตรงគ្នាទេ។';
                return;
            }
            if (newPassword.length < 6) {
                errorP.textContent = 'ពាក្យសម្ងាត់ថ្មីត្រូវមានอย่างน้อย 6 ตัวอักษរ។';
                return;
            }

            loadingOverlay.classList.remove('hidden');
            const credential = EmailAuthProvider.credential(user.email, currentPassword);

            try {
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);
                successP.textContent = 'ផ្លាស់ប្តូរពាក្យសម្ងាត់បានជោគជ័យ!';
                changePasswordForm.reset();
            } catch (error) {
                console.error("Password change failed:", error);
                if (error.code === 'auth/wrong-password') {
                    errorP.textContent = 'ពាក្យសម្ងាត់បច្ចុប្បន្នមិនត្រឹមត្រូវទេ។';
                } else {
                    errorP.textContent = 'ការផ្លាស់ប្តូរពាក្យសម្ងាត់បានបរាជ័យ។';
                }
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });


        // --- FILTER BUTTON LISTENERS ---
        document.getElementById('loan-filter-btn').addEventListener('click', renderLoans);
        document.getElementById('loan-reset-btn').addEventListener('click', () => {
            document.getElementById('loan-filter-start-date').value = '';
            document.getElementById('loan-filter-end-date').value = '';
            renderLoans();
        });
        document.getElementById('class-loan-filter-select').addEventListener('change', renderClassLoans);
        document.getElementById('class-loan-reset-btn').addEventListener('click', () => {
            document.getElementById('class-loan-filter-select').value = '';
            renderClassLoans();
        });
        document.getElementById('reading-log-filter-btn').addEventListener('click', renderReadingLogs);
        document.getElementById('reading-log-reset-btn').addEventListener('click', () => {
            document.getElementById('reading-log-filter-start-date').value = '';
            document.getElementById('reading-log-filter-end-date').value = '';
            renderReadingLogs();
        });

        // --- PRINTING ---
        const prepareAndPrint = (printClass) => {
            document.body.classList.add(printClass);
            window.print();
        };

        window.printReport = () => {
            const activePage = document.querySelector('.page:not(.hidden)');
            if (activePage) {
                const titleSpan = document.getElementById('print-report-title');
                let title = '';
                const pageId = activePage.id;

                switch (pageId) {
                    case 'page-books':
                        title = 'បញ្ជីសៀវភៅ';
                        break;
                    case 'page-loans':
                        const startDateLoans = document.getElementById('loan-filter-start-date').value;
                        const endDateLoans = document.getElementById('loan-filter-end-date').value;
                        title = 'បញ្ជីការខ្ចី-សងបុគ្គល';
                        if (startDateLoans && endDateLoans) {
                            title += ` ពីថ្ងៃ ${startDateLoans} ដល់ថ្ងៃ ${endDateLoans}`;
                        }
                        break;
                    case 'page-class-loans':
                        title = 'បញ្ជីការខ្ចីតាមថ្នាក់';
                        break;
                    case 'page-reading-log':
                        const startDateLogs = document.getElementById('reading-log-filter-start-date').value;
                        const endDateLogs = document.getElementById('reading-log-filter-end-date').value;
                        title = 'បញ្ជីកត់ត្រាការចូលអាន';
                        if (startDateLogs && endDateLogs) {
                            title += ` ពីថ្ងៃ ${startDateLogs} ដល់ថ្ងៃ ${endDateLogs}`;
                        }
                        break;
                    case 'page-locations':
                        title = 'បញ្ជីទីតាំងរក្សាទុកសៀវភៅ';
                        break;
                    case 'page-students':
                        const academicYear = settingsData.academicYear || '';
                        const studentClassFilter = document.getElementById('student-class-filter');
                        const selectedClass = studentClassFilter.value;
                        
                        title = 'បញ្ជីឈ្មោះសិស្ស';
                        
                        if (selectedClass) {
                            title += ` ថ្នាក់ទី ${selectedClass}`;
                        }

                        if (academicYear) {
                            title += ` ឆ្នាំសិក្សា ${academicYear}`;
                        }
                        break;
                }
                titleSpan.textContent = title;
                prepareAndPrint(`printing-${pageId}`);
            }
        };

        window.printCards = () => {
            prepareAndPrint('printing-page-student-cards');
        };

        window.onafterprint = () => {
            const printClasses = Array.from(document.body.classList).filter(
                c => c.startsWith('printing-')
            );
            document.body.classList.remove(...printClasses);
        };
        
        // NEW FUNCTION: Print a detailed class loan report
        document.getElementById('print-class-loan-list-btn').addEventListener('click', () => {
            const selectedClass = document.getElementById('class-loan-filter-select').value;
            if (!selectedClass) {
                alert('សូមជ្រើសរើសថ្នាក់ដែលត្រូវបោះពុម្ពជាមុនសិន។');
                return;
            }
            
            const classKey = students.length > 0 ? Object.keys(students[0]).find(k => k.includes('ថ្នាក់')) : null;
            const lastNameKey = students.length > 0 ? Object.keys(students[0]).find(k => k.includes('នាមត្រកូល')) : null;
            const firstNameKey = students.length > 0 ? Object.keys(students[0]).find(k => k.includes('នាមខ្លួន')) : null;
            const genderKey = students.length > 0 ? Object.keys(students[0]).find(k => k.includes('ភេទ')) : null;

            if (!classKey || !lastNameKey || !firstNameKey || !genderKey) {
                 alert('ទិន្នន័យសិស្សមិនគ្រប់គ្រាន់សម្រាប់បង្កើតរបាយការណ៍ទេ។');
                 return;
            }

            const studentsInClass = students.filter(s => s[classKey] === selectedClass);
            const classLoansForClass = loans.filter(l => l.borrower.includes(selectedClass));
            
            // Group loans by student
            const studentLoanMap = new Map();
            classLoansForClass.forEach(loan => {
                const studentName = loan.borrower.split(' - ')[0];
                if (!studentLoanMap.has(studentName)) {
                    studentLoanMap.set(studentName, []);
                }
                studentLoanMap.get(studentName).push(books.find(b => b.id === loan.bookId)?.title || 'N/A');
            });

            // Get all unique book titles
            const allBookTitles = [...new Set(classLoansForClass.map(l => books.find(b => b.id === l.bookId)?.title).filter(Boolean))].sort();

            // Build the table dynamically
            const tableContainer = document.getElementById('class-loan-students-table-container');
            tableContainer.innerHTML = '';
            
            const table = document.createElement('table');
            table.className = 'w-full text-left whitespace-no-wrap';
            
            // Build table header
            const thead = document.createElement('thead');
            thead.className = 'bg-gray-200';
            const headerRow = document.createElement('tr');
            ['ល.រ', 'ឈ្មោះ', 'ភេទ', ...allBookTitles, 'សរុប'].forEach(text => {
                const th = document.createElement('th');
                th.className = 'p-3 text-center';
                th.textContent = text;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Build table body
            const tbody = document.createElement('tbody');
            let totalStudents = 0;
            let totalMales = 0;
            let totalFemales = 0;
            const bookTotals = {};

            studentsInClass.forEach((student, index) => {
                totalStudents++;
                if (student[genderKey] === 'ប្រុស') totalMales++;
                if (student[genderKey] === 'ស្រី') totalFemales++;
                
                const studentFullName = `${student[lastNameKey] || ''} ${student[firstNameKey] || ''}`.trim();
                const loanedBooks = studentLoanMap.get(studentFullName) || [];
                
                const row = document.createElement('tr');
                row.className = 'border-b';
                
                const noCell = document.createElement('td');
                noCell.className = 'p-3 text-center';
                noCell.textContent = index + 1;
                row.appendChild(noCell);

                const nameCell = document.createElement('td');
                nameCell.className = 'p-3';
                nameCell.textContent = studentFullName;
                row.appendChild(nameCell);
                
                const genderCell = document.createElement('td');
                genderCell.className = 'p-3 text-center';
                genderCell.textContent = student[genderKey];
                row.appendChild(genderCell);

                let studentBookCount = 0;
                allBookTitles.forEach(bookTitle => {
                    const count = loanedBooks.filter(title => title === bookTitle).length;
                    const cell = document.createElement('td');
                    cell.className = 'p-3 text-center';
                    cell.textContent = count > 0 ? count : '';
                    row.appendChild(cell);
                    studentBookCount += count;
                    bookTotals[bookTitle] = (bookTotals[bookTitle] || 0) + count;
                });
                
                const totalCell = document.createElement('td');
                totalCell.className = 'p-3 text-center font-bold';
                totalCell.textContent = studentBookCount;
                row.appendChild(totalCell);
                
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            tableContainer.appendChild(table);

            // Build the footer section
            const footer = document.createElement('div');
            footer.className = 'mt-8 flex flex-wrap justify-between items-start print-only print-footer';
            
            const leftSummary = document.createElement('div');
            leftSummary.className = 'w-1/2';
            leftSummary.innerHTML = `
                <p class="font-semibold text-lg">សរុប៖</p>
                <p>សិស្សសរុប៖ ${totalStudents} នាក់ (ស្រី៖ ${totalFemales} នាក់)</p>
                ${allBookTitles.map(title => `<p>${title}៖ ${bookTotals[title] || 0} ក្បាល</p>`).join('')}
            `;
            footer.appendChild(leftSummary);

            const rightSignature = document.createElement('div');
            rightSignature.className = 'w-1/2 text-right';
            const today = new Date().toLocaleDateString('km-KH');
            rightSignature.innerHTML = `
                <p>ធ្វើនៅ៖ ${settingsData.schoolName || 'ឈ្មោះសាលា'}</p>
                <p>កាលបរិច្ឆេទបោះពុម្ព៖ ${today}</p>
                <p class="mt-8 font-semibold">គ្រូបន្ទុកថ្នាក់៖</p>
                <p class="mt-8">(ហត្ថលេខា)</p>
            `;
            footer.appendChild(rightSignature);
            
            tableContainer.appendChild(footer);


            // Set up the print title and subtitle
            const titleSpan = document.getElementById('print-report-title');
            titleSpan.textContent = `បញ្ជីឈ្មោះសិស្សខ្ចីសៀវភៅ`;
            const subtitle = document.getElementById('class-loan-report-subtitle');
            subtitle.textContent = `ថ្នាក់ទី ${selectedClass} ឆ្នាំសិក្សា ${settingsData.academicYear || 'N/A'}`;
            subtitle.classList.remove('hidden');

            prepareAndPrint('printing-page-class-loan-list');

             // Clean up after print
            setTimeout(() => {
                subtitle.classList.add('hidden');
                tableContainer.innerHTML = '';
            }, 100);
        });

        window.onafterprint = () => {
            const printClasses = Array.from(document.body.classList).filter(
                c => c.startsWith('printing-')
            );
            document.body.classList.remove(...printClasses);
        };
    </script>
</body>
</html>
