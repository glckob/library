<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ចុះឈ្មោះគណនី - បណ្ណាល័យខ្ញុំ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&family=Moul&family=Noto+Sans+Khmer:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans Khmer', sans-serif;
        }
        .font-koulen {
            font-family: 'Koulen', cursive;
        }
        .font-moul {
            font-family: 'Moul', cursive;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center">
    <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-2xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 font-koulen mb-2">បណ្ណាល័យខ្ញុំ</h1>
            <h2 class="text-2xl font-bold text-gray-700 font-koulen">ចុះឈ្មោះគណនីថ្មី</h2>
            <p class="text-gray-600 mt-2">បង្កើតគណនីសម្រាប់ប្រើប្រាស់ប្រព័ន្ធបណ្ណាល័យ</p>
        </div>

        <!-- Registration Form -->
        <form id="register-form" class="space-y-6">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-envelope mr-2 text-blue-500"></i>អ៊ីមែល
                </label>
                <input type="email" id="email" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                       placeholder="បញ្ចូលអ៊ីមែលរបស់អ្នក">
            </div>

            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-lock mr-2 text-blue-500"></i>ពាក្យសម្ងាត់
                </label>
                <input type="password" id="password" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                       placeholder="បញ្ចូលពាក្យសម្ងាត់ (យ៉ាងតិច ៦ តួអក្សរ)">
            </div>

            <div>
                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-lock mr-2 text-blue-500"></i>បញ្ជាក់ពាក្យសម្ងាត់
                </label>
                <input type="password" id="confirm-password" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                       placeholder="បញ្ចូលពាក្យសម្ងាត់ម្តងទៀត">
            </div>

            <div>
                <label for="school-name" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-school mr-2 text-blue-500"></i>ឈ្មោះសាលា
                </label>
                <input type="text" id="school-name" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                       placeholder="បញ្ចូលឈ្មោះសាលារបស់អ្នក">
            </div>

            <button type="submit" id="register-btn" 
                    class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 transition-all duration-200 font-medium">
                <i class="fas fa-user-plus mr-2"></i>ចុះឈ្មោះ
            </button>
        </form>

        <!-- Error/Success Messages -->
        <div id="message" class="mt-4 p-4 rounded-lg hidden">
            <p id="message-text" class="text-sm font-medium"></p>
        </div>

        <!-- Loading Overlay -->
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-700">កំពុងបង្កើតគណនី...</p>
            </div>
        </div>

        <!-- Existing Users List -->
        <div class="mt-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">
                <i class="fas fa-users mr-2 text-blue-500"></i>អ្នកប្រើប្រាស់ដែលមានស្រាប់
            </h3>
            <div id="users-list" class="max-h-40 overflow-y-auto bg-gray-50 rounded-lg p-4">
                <p class="text-gray-500 text-center">កំពុងផ្ទុកបញ្ជីអ្នកប្រើប្រាស់...</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center">
            <p class="text-gray-600 text-sm">
                មានគណនីហើយ? 
                <a href="index.html" class="text-blue-600 hover:text-blue-800 font-medium">ចូលប្រើនៅទីនេះ</a>
            </p>
        </div>
    </div>

    <!-- Firebase and Registration Script -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAohuQEs4nWuw1PSqfZpvxN1sF16BX_Qgw",
            authDomain: "library-glc-kob.firebaseapp.com",
            projectId: "library-glc-kob",
            storageBucket: "library-glc-kob.appspot.com",
            messagingSenderId: "806682991838",
            appId: "1:806682991838:web:4f63c2a07c39d89a74a89a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const registerForm = document.getElementById('register-form');
        const registerBtn = document.getElementById('register-btn');
        const loading = document.getElementById('loading');
        const message = document.getElementById('message');
        const messageText = document.getElementById('message-text');
        const usersList = document.getElementById('users-list');

        // Show message function
        const showMessage = (text, isError = false) => {
            message.className = `mt-4 p-4 rounded-lg ${isError ? 'bg-red-100 border border-red-400' : 'bg-green-100 border border-green-400'}`;
            messageText.className = `text-sm font-medium ${isError ? 'text-red-700' : 'text-green-700'}`;
            messageText.textContent = text;
            message.classList.remove('hidden');
            
            setTimeout(() => {
                message.classList.add('hidden');
            }, 5000);
        };

        // Load existing users
        const loadExistingUsers = async () => {
            try {
                // This is a simplified approach - in production, you'd want to store user info in a public collection
                // For now, we'll show a message that admin needs to check Firebase console
                usersList.innerHTML = `
                    <div class="text-center text-gray-600">
                        <i class="fas fa-info-circle mb-2 text-blue-500"></i>
                        <p class="text-sm">ដើម្បីមើលបញ្ជីអ្នកប្រើប្រាស់ដែលមានស្រាប់</p>
                        <p class="text-sm">សូមពិនិត្យនៅក្នុង Firebase Console</p>
                        <p class="text-xs mt-2 text-gray-500">Authentication → Users</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading users:', error);
                usersList.innerHTML = '<p class="text-red-500 text-sm text-center">មិនអាចផ្ទុកបញ្ជីអ្នកប្រើប្រាស់បានទេ</p>';
            }
        };

        // Registration form handler
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const schoolName = document.getElementById('school-name').value.trim();

            // Validation
            if (password !== confirmPassword) {
                showMessage('ពាក្យសម្ងាត់មិនត្រូវគ្នាទេ', true);
                return;
            }

            if (password.length < 6) {
                showMessage('ពាក្យសម្ងាត់ត្រូវមានយ៉ាងតិច ៦ តួអក្សរ', true);
                return;
            }

            if (!schoolName) {
                showMessage('សូមបញ្ចូលឈ្មោះសាលា', true);
                return;
            }

            // Show loading
            loading.classList.remove('hidden');
            registerBtn.disabled = true;

            try {
                // Create user account
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Create user profile in Firestore
                await setDoc(doc(db, 'users', user.uid, 'settings', 'generalInfo'), {
                    schoolName: schoolName,
                    email: email,
                    createdAt: new Date().toISOString(),
                    defaultPage: 'home'
                });

                // Initialize empty collections for the user
                const collections = ['books', 'loans', 'classLoans', 'locations', 'students', 'readingLogs'];
                for (const collectionName of collections) {
                    // Create a placeholder document to initialize the collection
                    await setDoc(doc(db, 'users', user.uid, collectionName, '_placeholder'), {
                        _placeholder: true,
                        createdAt: new Date().toISOString()
                    });
                }

                showMessage('គណនីត្រូវបានបង្កើតដោយជោគជ័យ! កំពុងបញ្ជូនទៅកាន់ទំព័រចូលប្រើ...', false);
                
                // Redirect to login page after 2 seconds
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'ការចុះឈ្មោះបានបរាជ័យ';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'អ៊ីមែលនេះត្រូវបានប្រើប្រាស់រួចហើយ';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'អ៊ីមែលមិនត្រឹមត្រូវ';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'ពាក្យសម្ងាត់ខ្សោយពេក';
                        break;
                    default:
                        errorMessage += ': ' + error.message;
                }
                
                showMessage(errorMessage, true);
            } finally {
                loading.classList.add('hidden');
                registerBtn.disabled = false;
            }
        });

        // Check if user is already logged in
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, redirect to main app
                window.location.href = 'index.html';
            }
        });

        // Load users on page load
        loadExistingUsers();
    </script>
</body>
</html>