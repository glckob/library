<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>បណ្ណាល័យខ្ញុំ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&family=Moul&family=Noto+Sans+Khmer:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Barcode Generation Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Excel Export Library (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Link to the external CSS file -->
    <link rel="stylesheet" href="./styles.css?v=1.1">
</head>
<body class="bg-gray-100">
    <!-- Print Header (Only visible for printing reports) -->
    <div id="print-header">
         <div class="print-header-content">
            <div class="motto">
                <p>ព្រះរាជាណាចក្រកម្ពុជា</p>
                <p>ជាតិ សាសនា ព្រះមហាក្សត្រ</p>
            </div>
            <div class="school-name">
                <span id="print-school-name"></span>
            </div>
            <div class="report-title">
                <span id="print-report-title"></span>
            </div>
            <!-- NEW: Print Subtitle (for class loan report) -->
            <div class="text-xs text-gray-700 font-semibold mt-2 hidden print-only" id="class-loan-report-subtitle"></div>
         </div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="fixed inset-0 bg-gray-200 flex items-center justify-center z-50">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-lg">
            <!-- Login Form -->
            <div id="login-form-container">
                <h2 class="text-3xl font-bold text-center mb-6 font-koulen">ចូលប្រើប្រាស់</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 mb-1">អ៊ីមែល</label>
                        <input type="email" id="login-email" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 mb-1">ពាក្យសម្ងាត់</label>
                        <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition-colors">ចូលប្រើ</button>
                    <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
                </form>
                <p class="text-center mt-4 text-gray-600">
                    មិនទាន់មានគណនី? <a href="#" id="show-register" class="text-blue-500 hover:underline">ចុះឈ្មោះនៅទីនេះ</a>
                </p>
            </div>
            <!-- Register Form -->
            <div id="register-form-container" class="hidden">
                <h2 class="text-3xl font-bold text-center mb-6 font-koulen">បង្កើតគណនីថ្មី</h2>
                <form id="register-form">
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 mb-1">អ៊ីមែល</label>
                        <input type="email" id="register-email" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-700 mb-1">ពាក្យសម្ងាត់</label>
                        <input type="password" id="register-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600 transition-colors">ចុះឈ្មោះ</button>
                    <p id="register-error" class="text-red-500 text-sm text-center mt-4"></p>
                </form>
                <p class="text-center mt-4 text-gray-600">
                    មានគណនីហើយ? <a href="#" id="show-login" class="text-blue-500 hover:underline">ចូលប្រើនៅទីនេះ</a>
                </p>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden">
        <div class="flex h-screen bg-gray-200">
            <!-- Sidebar -->
            <div id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col no-print">
                <div class="p-4 border-b border-gray-700">
                    <h1 class="text-2xl font-bold text-center font-moul">បណ្ណាល័យខ្ញុំ</h1>
                    <p id="sidebar-school-name" class="text-sm text-center font-moul text-gray-300 mt-1"></p>
                </div>
                <nav class="flex-1 px-2 py-4 space-y-2">
                    <a href="#" data-page="home" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-home mr-3"></i> ទំព័រដើម
                    </a>
                    <a href="#" data-page="books" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-book mr-3"></i> គ្រប់គ្រងសៀវភៅ
                    </a>
                    <a href="#" data-page="loans" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-user mr-3"></i> ខ្ចី-សង បុគ្គល
                    </a>
                     <a href="#" data-page="class-loans" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-users mr-3"></i> ខ្ចី-សង តាមថ្នាក់
                    </a>
                    <a href="#" data-page="reading-log" class="nav-link flex items-center px-4 py-2 text-gray-100 bg-gray-900 rounded-md">
                        <i class="fas fa-book-open mr-3"></i> ចូលអាន
                    </a>
                    <a href="#" data-page="locations" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-map-marker-alt mr-3"></i> ទីតាំងរក្សាទុក
                    </a>
                    <a href="#" data-page="students" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-user-graduate mr-3"></i> ទិន្នន័យសិស្ស
                    </a>
                    <a href="stcard.html" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-id-card mr-3"></i> កាតសិស្ស
                    </a>
                    <a href="#" data-page="settings" class="nav-link flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                        <i class="fas fa-cog mr-3"></i> ការកំណត់
                    </a>
                </nav>
                <!-- Credits Section -->
                <div class="p-2 border-t border-gray-700 text-center text-xs text-gray-400 no-print">
                    <p>កម្មវិធីនេះសរសេរដោយ លោកគ្រូ វង្ស សាណូវុទ្ធ</p>
                    <p class="mt-1">ឧបត្ថម្ភការផលិតដោយ៖ អង្គការហ្គូដណេប៊ឺសកម្ពុជា</p>
                </div>
                <div class="p-2 border-t border-gray-700 text-center text-xs text-gray-400 no-print">
                    <p id="user-email" class="truncate"></p>
                    <button id="logout-btn" class="w-full mt-2 bg-red-500 text-white py-1 rounded hover:bg-red-600">ចាកចេញ</button>
                </div>
            </div>

            <!-- Main content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                    <!-- Home Page -->
                    <div id="page-home" class="page hidden">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">ផ្ទាំងគ្រប់គ្រង</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                                <i class="fas fa-book text-5xl text-blue-500 mr-6"></i>
                                <div>
                                    <p class="text-lg text-gray-600">ប្រភេទសៀវភៅសរុប</p>
                                    <p id="total-books" class="text-4xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                                <i class="fas fa-layer-group text-5xl text-purple-500 mr-6"></i>
                                <div>
                                    <p class="text-lg text-gray-600">ចំនួនសៀវភៅសរុប</p>
                                    <p id="total-quantity" class="text-4xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                                <i class="fas fa-hand-holding-hand text-5xl text-green-500 mr-6"></i>
                                <div>
                                    <p class="text-lg text-gray-600">កំពុងខ្ចី</p>
                                    <p id="total-loans" class="text-4xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Book Management Page -->
                    <div id="page-books" class="page hidden">
                         <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-3xl font-bold text-gray-800 no-print">បញ្ជីសៀវភៅ</h2>
                            <div class="flex items-center">
                                <input type="text" id="search-books" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md mr-4 no-print" placeholder="ស្វែងរកសៀវភៅ...">
                                <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 mr-2 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                                <button onclick="window.openBookModal()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 no-print"><i class="fas fa-plus mr-2"></i>បន្ថែម</button>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                            <div id="books-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left whitespace-no-wrap">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">ល.រ</th>
                                            <th class="p-3">ចំណងជើង</th>
                                            <th class="p-3">អ្នកនិពន្ធ</th>
                                            <th class="p-3">ISBN</th>
                                            <th class="p-3">ចំនួនសរុប</th>
                                            <th class="p-3">ចំនួននៅសល់</th>
                                            <th class="p-3">ទីតាំង</th>
                                            <th class="p-3">ប្រភព</th>
                                            <th class="p-3 no-print">សកម្មភាព</th>
                                        </tr>
                                    </thead>
                                    <tbody id="book-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Individual Loan Management Page -->
                    <div id="page-loans" class="page hidden">
                        <!-- Section for creating new individual loans -->
                        <h2 class="text-3xl font-bold text-gray-800 mb-4 no-print">បង្កើតកំណត់ត្រាខ្ចី-សង បុគ្គល</h2>
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6 no-print">
                            <form id="loan-form">
                                <input type="hidden" id="loan-borrower-gender">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-start">
                                    <!-- ISBN Input -->
                                    <div>
                                        <label for="loan-isbn-input" class="block text-gray-700 mb-1 font-medium">វាយបញ្ចូល/ស្កេន ISBN</label>
                                        <input type="text" id="loan-isbn-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ស្កេន Barcode..." autocomplete="off" required>
                                        <p id="loan-book-error" class="text-xs text-red-500 mt-1"></p>
                                    </div>
                                    <!-- Book Title Display -->
                                    <div>
                                        <label for="loan-book-title-display" class="block text-gray-700 mb-1 font-medium">ឈ្មោះសៀវភៅ</label>
                                        <input type="text" id="loan-book-title-display" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                                        <input type="hidden" id="loan-book-id">
                                    </div>
                                    <!-- Student ID Input -->
                                    <div>
                                        <label for="loan-student-id-input" class="block text-gray-700 mb-1 font-medium">វាយបញ្ចូល/ស្កេន អត្តលេខសិស្ស</label>
                                        <input type="text" id="loan-student-id-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ស្កេនកាតសិស្ស..." autocomplete="off" required>
                                        <p id="loan-student-error" class="text-xs text-red-500 mt-1"></p>
                                    </div>
                                    <!-- Borrower Name Display -->
                                    <div>
                                        <label for="loan-borrower-name-display" class="block text-gray-700 mb-1 font-medium">ឈ្មោះអ្នកខ្ចី</label>
                                        <input type="text" id="loan-borrower-name-display" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <button type="submit" class="w-full md:w-auto bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600"><i class="fas fa-plus mr-2"></i>បង្កើតការខ្ចី</button>
                                </div>
                            </form>
                        </div>

                        <!-- Section for loan history -->
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h3 class="text-xl font-bold text-gray-800 no-print">ប្រវត្តិនៃការខ្ចី-សង បុគ្គល</h3>
                            <div class="flex items-center">
                                <input type="text" id="search-loans" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md mr-4 no-print" placeholder="ស្វែងរកការខ្ចី...">
                                <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                            </div>
                        </div>
                        
                        <!-- Filter and Summary Section -->
                        <div class="bg-white p-4 rounded-lg shadow-md mb-6 no-print">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="loan-filter-start-date" class="block text-sm font-medium text-gray-700">ពីថ្ងៃ</label>
                                    <input type="date" id="loan-filter-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="loan-filter-end-date" class="block text-sm font-medium text-gray-700">ដល់ថ្ងៃ</label>
                                    <input type="date" id="loan-filter-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div class="flex space-x-2">
                                    <button id="loan-filter-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 w-full">ត្រង</button>
                                    <button id="loan-reset-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 w-full">សម្អាត</button>
                                </div>
                            </div>
                            <div id="loan-summary" class="mt-4 text-center font-semibold text-gray-700"></div>
                        </div>
                        
                        <!-- Loan List Table -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <div id="loans-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">ល.រ</th>
                                            <th class="p-3">ចំណងជើងសៀវភៅ</th>
                                            <th class="p-3">ឈ្មោះអ្នកខ្ចី</th>
                                            <th class="p-3">ថ្ងៃខ្ចី</th>
                                            <th class="p-3">ថ្ងៃសង</th>
                                            <th class="p-3">ស្ថានភាព</th>
                                            <th class="p-3 no-print">សកម្មភាព</th>
                                        </tr>
                                    </thead>
                                    <tbody id="loan-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Class Loan Management Page -->
                    <div id="page-class-loans" class="page hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4 no-print">បង្កើតកំណត់ត្រាខ្ចី-សង តាមថ្នាក់</h2>
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6 no-print">
                            <form id="class-loan-form">
                                <!-- START: MODIFIED FORM LAYOUT -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                                    <!-- ISBN Input -->
                                    <div>
                                        <label for="class-loan-isbn-input" class="block text-gray-700 mb-1 font-medium">វាយបញ្ចូល/ស្កេន ISBN</label>
                                        <input type="text" id="class-loan-isbn-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ស្កេន Barcode..." autocomplete="off" required>
                                    </div>
                                    <!-- Book Title Display -->
                                    <div>
                                        <label for="class-loan-book-title-display" class="block text-gray-700 mb-1 font-medium">ឈ្មោះសៀវភៅ</label>
                                        <input type="text" id="class-loan-book-title-display" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                                        <input type="hidden" id="class-loan-book-id">
                                        <p id="class-loan-book-error" class="text-xs text-red-500 mt-1"></p>
                                    </div>
                                    <!-- Class Select with Student Count -->
                                    <div class="flex items-end gap-2">
                                        <div class="flex-grow">
                                            <label for="class-loan-class-select" class="block text-gray-700 mb-1 font-medium">ជ្រើសរើសថ្នាក់</label>
                                            <select id="class-loan-class-select" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></select>
                                        </div>
                                        <p id="class-info-text" class="text-sm text-blue-600 font-semibold pb-2 whitespace-nowrap"></p>
                                    </div>
                                </div>

                                <!-- Student List Container -->
                                <div id="class-loan-student-list-container" class="mt-4 bg-gray-50 p-4 rounded-md border hidden max-h-60 overflow-y-auto">
                                    <!-- Student list with checkboxes will be dynamically inserted here -->
                                </div>

                                <!-- Loan Quantity Display & Submit Button -->
                                <div class="mt-4 flex flex-wrap items-center justify-between gap-4">
                                    <div>
                                        <label for="class-loan-quantity" class="block text-gray-700 mb-1 font-medium">ចំនួនខ្ចី</label>
                                        <input type="number" id="class-loan-quantity" class="w-32 px-3 py-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                                    </div>
                                    <button type="submit" class="bg-cyan-500 text-white px-6 py-2 rounded-md hover:bg-cyan-600"><i class="fas fa-users mr-2"></i>បង្កើតការខ្ចី</button>
                                </div>
                                <!-- END: MODIFIED FORM LAYOUT -->
                            </form>
                        </div>
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h3 class="text-xl font-bold text-gray-800 no-print">ប្រវត្តិនៃការខ្ចីតាមថ្នាក់</h3>
                            <div class="flex items-center">
                                <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 no-print mr-2"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                                <!-- NEW: Button to print student list for class loans -->
                                <button id="print-class-loan-list-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ពបញ្ជីខ្ចី</button>
                            </div>
                        </div>
                        <!-- Filter Section -->
                        <div class="bg-white p-4 rounded-lg shadow-md mb-6 no-print">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div class="md:col-span-2">
                                    <label for="class-loan-filter-select" class="block text-sm font-medium text-gray-700">ត្រងតាមថ្នាក់</label>
                                    <select id="class-loan-filter-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                                </div>
                                <div>
                                    <button id="class-loan-reset-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 w-full">បង្ហាញទាំងអស់</button>
                                </div>
                            </div>
                        </div>
                         <div class="bg-white p-4 rounded-lg shadow-md">
                            <div id="class-loans-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">#</th>
                                            <th class="p-3">សៀវភៅ</th>
                                            <th class="p-3">ថ្នាក់</th>
                                            <th class="p-3">ថ្ងៃខ្ចី</th>
                                            <th class="p-3">ស្ថានភាពសង</th>
                                            <th class="p-3 no-print">សកម្មភាព</th>
                                        </tr>
                                    </thead>
                                    <tbody id="class-loan-list"></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- NEW: Print Area for Class Loan Students -->
                        <div id="class-loan-students-print-area" class="print-area">
                             <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                             <div id="class-loan-students-table-container"></div>
                        </div>
                    </div>
                    
                    <!-- Reading Log Page -->
                    <div id="page-reading-log" class="page">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4 no-print">កត់ត្រាការចូលអាន</h2>
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6 no-print">
                            <form id="reading-log-form">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label for="reading-log-student-id" class="block text-gray-700 mb-1 font-medium">ស្កេនអត្តលេខសិស្ស</label>
                                        <input type="text" id="reading-log-student-id" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ស្កេនកាតសិស្ស..." autocomplete="off" required>
                                        <p id="reading-log-student-error" class="text-xs text-red-500 mt-1"></p>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="reading-log-student-name" class="block text-gray-700 mb-1 font-medium">ឈ្មោះសិស្ស</label>
                                        <input type="text" id="reading-log-student-name" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                                        <input type="hidden" id="reading-log-student-obj-id">
                                    </div>
                                    <div class="md:col-span-3">
                                        <label for="reading-log-isbn-input" class="block text-gray-700 mb-1 font-medium">ស្កេន ISBN សៀវភៅ</label>
                                        <input type="text" id="reading-log-isbn-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ស្កេនសៀវភៅម្តងមួយ..." autocomplete="off">
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <h4 class="font-medium">សៀវភៅបានស្កេន៖</h4>
                                    <ul id="scanned-books-list" class="list-disc list-inside mt-2 text-gray-700">
                                        <!-- Scanned books will appear here -->
                                    </ul>
                                </div>
                                <div class="flex justify-end mt-6">
                                    <button type="button" onclick="window.clearReadingLogForm()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">សម្អាត</button>
                                    <button type="submit" class="bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600">រក្សាទុកការចូលអាន</button>
                                </div>
                            </form>
                        </div>
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h3 class="text-xl font-bold text-gray-800 no-print">ប្រវត្តិនៃការចូលអាន</h3>
                             <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                        </div>
                        <!-- Filter and Summary Section -->
                        <div class="bg-white p-4 rounded-lg shadow-md mb-6 no-print">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="reading-log-filter-start-date" class="block text-sm font-medium text-gray-700">ពីថ្ងៃ</label>
                                    <input type="date" id="reading-log-filter-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label for="reading-log-filter-end-date" class="block text-sm font-medium text-gray-700">ដល់ថ្ងៃ</label>
                                    <input type="date" id="reading-log-filter-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div class="flex space-x-2">
                                    <button id="reading-log-filter-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 w-full">ត្រង</button>
                                    <button id="reading-log-reset-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 w-full">សម្អាត</button>
                                </div>
                            </div>
                             <div id="reading-log-summary" class="mt-4 text-center font-semibold text-gray-700"></div>
                        </div>
                         <div class="bg-white p-4 rounded-lg shadow-md">
                            <div id="reading-log-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">#</th>
                                            <th class="p-3">កាលបរិច្ឆេទ</th>
                                            <th class="p-3">ឈ្មោះសិស្ស</th>
                                            <th class="p-3">សៀវភៅបានអាន</th>
                                            <th class="p-3 no-print">សកម្មភាព</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reading-log-history"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Location Management Page -->
                    <div id="page-locations" class="page hidden">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-3xl font-bold text-gray-800 no-print">គ្រប់គ្រងទីតាំងរក្សាទុក</h2>
                            <div class="flex items-center">
                                <input type="text" id="search-locations" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md mr-4 no-print" placeholder="ស្វែងរកទីតាំង...">
                                <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 mr-2 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                                <button onclick="window.openLocationModal()" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 no-print"><i class="fas fa-plus mr-2"></i>បន្ថែម</button>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <div id="locations-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3">#</th>
                                            <th class="p-3">ឈ្មោះទីតាំង</th>
                                            <th class="p-3">ប្រភពធ្នើ</th>
                                            <th class="p-3">ឆ្នាំ</th>
                                            <th class="p-3 no-print">សកម្មភាព</th>
                                        </tr>
                                    </thead>
                                    <tbody id="location-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Student Data Page -->
                    <div id="page-students" class="page hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4 no-print">ទិន្នន័យសិស្ស</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md mb-6 no-print">
                            <h3 class="text-xl font-bold mb-2">តំណភ្ជាប់ Google Sheet</h3>
                            <div class="flex flex-wrap items-center gap-2">
                                <input type="url" id="google-sheet-url" class="flex-grow px-3 py-2 border border-gray-300 rounded-md" placeholder="ដាក់ Link Google Sheet CSV នៅទីនេះ...">
                                <button id="save-url-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600"><i class="fas fa-save mr-2"></i>រក្សាទុក Link</button>
                                <button id="fetch-data-btn" class="bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600"><i class="fas fa-download mr-2"></i>ទាញយកទិន្នន័យ</button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">**សំគាល់:** សូមប្រាកដថា Link របស់អ្នកបាន Publish to the web ជាទម្រង់ CSV។ (File > Share > Publish to web > CSV)</p>
                        </div>

                        <div class="flex flex-wrap justify-between items-start mb-6 gap-4">
                            <div class="flex items-start">
                                <h3 class="text-xl font-bold text-gray-800 no-print">បញ្ជីសិស្ស</h3>
                                <div id="duplicate-student-list" class="text-red-500 text-sm ml-6"></div>
                            </div>
                            <div class="flex items-center">
                                <!-- START: NEW CLASS FILTER DROPDOWN -->
                                <select id="student-class-filter" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md mr-4 no-print"></select>
                                <!-- END: NEW CLASS FILTER DROPDOWN -->
                                <input type="text" id="search-students" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md mr-4 no-print" placeholder="ស្វែងរកសិស្ស...">
                                <button onclick="window.printReport()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 mr-2 no-print"><i class="fas fa-print mr-2"></i>បោះពុម្ព</button>
                                <button onclick="window.openStudentModal()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 no-print"><i class="fas fa-plus mr-2"></i>បន្ថែមសិស្ស</button>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                            <div id="students-print-area">
                                <h2 class="print-area text-2xl font-bold mb-4 text-center"></h2>
                                <table class="w-full text-left whitespace-no-wrap">
                                    <thead class="bg-gray-200">
                                        <tr id="student-list-header">
                                            <!-- Headers will be generated dynamically -->
                                        </tr>
                                    </thead>
                                    <tbody id="student-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>



                    <!-- Settings Page -->
                    <div id="page-settings" class="page hidden">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">ការកំណត់</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column: Settings -->
                            <div class="space-y-8">
                                <!-- General Info Section -->
                                <div class="bg-white p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ព័ត៌មានទូទៅ</h3>
                                    <div class="space-y-4">
                                        <!-- School Name -->
                                        <div>
                                            <label for="school-name-input" class="block text-sm font-medium text-gray-700">ឈ្មោះសាលា</label>
                                            <div id="school-name-container" class="mt-1 flex items-center gap-2">
                                                <input type="text" id="school-name-input" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm">
                                                <p id="school-name-display" class="hidden flex-grow font-semibold text-lg"></p>
                                                <button id="save-school-name-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">រក្សាទុក</button>
                                                <button id="edit-school-name-btn" class="hidden bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600">កែប្រែ</button>
                                                <button id="delete-school-name-btn" class="hidden bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">លុប</button>
                                            </div>
                                        </div>
                                        <!-- Academic Year -->
                                        <div>
                                            <label for="academic-year-input" class="block text-sm font-medium text-gray-700">ឆ្នាំសិក្សា</label>
                                            <div id="academic-year-container" class="mt-1 flex items-center gap-2">
                                                <input type="text" id="academic-year-input" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm" placeholder="YYYY-YYYY">
                                                <p id="academic-year-display" class="hidden flex-grow font-semibold text-lg"></p>
                                                <button id="save-academic-year-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">រក្សាទុក</button>
                                                <button id="edit-academic-year-btn" class="hidden bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600">កែប្រែ</button>
                                                <button id="delete-academic-year-btn" class="hidden bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">លុប</button>
                                            </div>
                                        </div>
                                        <!-- Principal Seal -->
                                        <div>
                                            <label for="seal-image-url" class="block text-sm font-medium text-gray-700">ត្រានាយកសាលា (URL)</label>
                                            <div class="mt-1 flex items-center gap-4">
                                                <div class="flex-grow">
                                                    <input type="url" id="seal-image-url" class="block w-full rounded-md border-gray-300 shadow-sm" placeholder="https://example.com/seal.png">
                                                    <button id="save-seal-url-btn" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">រក្សាទុក URL</button>
                                                </div>
                                                <img id="seal-image-preview" src="https://placehold.co/100x100/e2e8f0/e2e8f0?text=Preview" alt="Seal Preview" class="w-24 h-24 object-contain border rounded-md bg-gray-100">
                                            </div>
                                        </div>
                                        <!-- Card Background -->
                                        <div>
                                            <label for="card-bg-url" class="block text-sm font-medium text-gray-700">ផ្ទៃខាងក្រោយកាត (URL)</label>
                                            <div class="mt-1 flex items-center gap-4">
                                                <div class="flex-grow">
                                                    <input type="url" id="card-bg-url" class="block w-full rounded-md border-gray-300 shadow-sm" placeholder="https://example.com/background.png">
                                                    <button id="save-card-bg-btn" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">រក្សាទុក URL</button>
                                                </div>
                                                <img id="card-bg-preview" src="https://placehold.co/100x100/e2e8f0/e2e8f0?text=Preview" alt="Card BG Preview" class="w-24 h-24 object-contain border rounded-md bg-gray-100">
                                            </div>
                                        </div>
                                        <!-- Default Page Dropdown -->
                                        <div>
                                            <label for="default-page-select" class="block text-sm font-medium text-gray-700">ជ្រើសរើសទំព័រលំនាំដើម</label>
                                            <select id="default-page-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                                        </div>
                                    </div>
                                </div>
                                <!-- Change Password Section -->
                                <div class="bg-white p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ផ្លាស់ប្តូរពាក្យសម្ងាត់</h3>
                                    <form id="change-password-form" class="space-y-4">
                                        <div>
                                            <label for="current-password" class="block text-sm font-medium text-gray-700">ពាក្យសម្ងាត់បច្ចុប្បន្ន</label>
                                            <input type="password" id="current-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                        </div>
                                        <div>
                                            <label for="new-password" class="block text-sm font-medium text-gray-700">ពាក្យសម្ងាត់ថ្មី</label>
                                            <input type="password" id="new-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                        </div>
                                        <div>
                                            <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">ยืนยันពាក្យសម្ងាត់ថ្មី</label>
                                            <input type="password" id="confirm-new-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                        </div>
                                        <p id="change-password-error" class="text-red-500 text-sm"></p>
                                        <p id="change-password-success" class="text-green-500 text-sm"></p>
                                        <button type="submit" class="w-full bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600">ផ្លាស់ប្តូរពាក្យសម្ងាត់</button>
                                    </form>
                                </div>
                            </div>
                            <!-- Right Column: Data & Danger Zone -->
                            <div class="space-y-8">
                                <!-- START: NEW EXPORT SECTION -->
                                <div class="bg-white p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">នាំចេញទិន្នន័យ</h3>
                                    <p class="text-gray-600 mb-4">ជ្រើសរើសប្រភេទទិន្នន័យ រួចចុចប៊ូតុងដើម្បីទាញយកជាไฟล์ Excel (.xlsx)។</p>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="export-data-select" class="block text-sm font-medium text-gray-700">ជ្រើសរើសទិន្នន័យ</label>
                                            <select id="export-data-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                                <option value="" disabled selected>-- សូមជ្រើសរើស --</option>
                                                <option value="books">បញ្ជីសៀវភៅ</option>
                                                <option value="loans">ប្រវត្តិនៃការខ្ចី-សង បុគ្គល</option>
                                                <option value="class-loans">ប្រវត្តិនៃការខ្ចីតាមថ្នាក់</option>
                                                <option value="reading-logs">ប្រវត្តិនៃការចូលអាន</option>
                                                <option value="locations">ទីតាំងរក្សាទុក</option>
                                                <option value="students">បញ្ជីសិស្ស</option>
                                                <option value="settings">ព័ត៌មានទូទៅ</option>
                                            </select>
                                        </div>
                                        <button id="export-excel-btn" class="w-full bg-emerald-500 text-white px-4 py-2 rounded-md hover:bg-emerald-600 flex items-center justify-center">
                                            <i class="fas fa-file-excel mr-2"></i> នាំចេញជា Excel
                                        </button>
                                    </div>
                                </div>
                                <!-- END: NEW EXPORT SECTION -->

                                <div class="bg-white p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-bold text-red-600 mb-4 border-b pb-2">តំបន់គ្រោះថ្នាក់</h3>
                                    <p class="text-gray-600 mb-6">ការดำเนินการខាងក្រោមនឹងលុបទិន្នន័យជាអចិន្ត្រៃយ៍ ហើយមិនអាចមិនធ្វើវិញបានទេ។ សូមប្រើដោយប្រុងប្រយត្នបំផុត។</p>
                                    
                                    <div class="space-y-6">
                                        <!-- Delete Buttons -->
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបបញ្ជីសៀវភៅទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបទិន្នន័យសៀវភៅទាំងអស់ចេញពីប្រព័ន្ធ។</p>
                                            <button onclick="window.openPasswordConfirmModal('books')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបកំណត់ត្រាខ្ចី-សង បុគ្គលទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបប្រវត្តិខ្ចី-សងរបស់បុគ្គលទាំងអស់។</p>
                                            <button onclick="window.openPasswordConfirmModal('loans')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបប្រវត្តិនៃការខ្ចីតាមថ្នាក់ទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបប្រវត្តិខ្ចី-សងតាមថ្នាក់ទាំងអស់។</p>
                                            <button onclick="window.openPasswordConfirmModal('classLoans')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបប្រវត្តិនៃការចូលអានទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបកំណត់ត្រាការចូលអានទាំងអស់។</p>
                                            <button onclick="window.openPasswordConfirmModal('readingLogs')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបទីតាំងរក្សាទុកទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបទីតាំងធ្នើសៀវភៅទាំងអស់។</p>
                                            <button onclick="window.openPasswordConfirmModal('locations')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                        <div class="p-4 border rounded-lg">
                                            <h4 class="font-semibold">លុបបញ្ជីទិន្នន័យសិស្សទាំងអស់</h4>
                                            <p class="text-sm text-gray-500 mb-2">លុបข้อมูลសិស្សទាំងអស់ចេញពីប្រព័ន្ធ។</p>
                                            <button onclick="window.openPasswordConfirmModal('students')" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-700">លុបទាំងអស់</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="book-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-20">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 id="book-modal-title" class="text-2xl font-bold mb-6">បន្ថែមសៀវភៅថ្មី</h3>
            <form id="book-form">
                <input type="hidden" id="book-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="title" class="block text-gray-700 mb-1">ចំណងជើង</label>
                        <input type="text" id="title" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="author" class="block text-gray-700 mb-1">អ្នកនិពន្ធ</label>
                        <input type="text" id="author" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                     <div>
                        <label for="isbn" class="block text-gray-700 mb-1">លេខ ISBN</label>
                        <input type="text" id="isbn" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="quantity" class="block text-gray-700 mb-1">ចំនួន</label>
                        <input type="number" id="quantity" class="w-full px-3 py-2 border border-gray-300 rounded-md" required min="0">
                    </div>
                    <div>
                        <label for="book-location-id" class="block text-gray-700 mb-1">ទីតាំងរក្សាទុក</label>
                        <select id="book-location-id" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></select>
                    </div>
                    <div>
                        <label for="source" class="block text-gray-700 mb-1">ប្រភពសៀវភៅ</label>
                        <input type="text" id="source" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.closeBookModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">បោះបង់</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="location-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-20">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 id="location-modal-title" class="text-2xl font-bold mb-6">បន្ថែមទីតាំងថ្មី</h3>
            <form id="location-form">
                <input type="hidden" id="location-id">
                <div class="mb-4">
                    <label for="location-name" class="block text-gray-700 mb-1">ឈ្មោះទីតាំង</label>
                    <input type="text" id="location-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="location-source" class="block text-gray-700 mb-1">ប្រភពធ្នើ</label>
                    <input type="text" id="location-source" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="location-year" class="block text-gray-700 mb-1">ឆ្នាំ</label>
                    <input type="number" id="location-year" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.closeLocationModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">បោះបង់</button>
                    <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded-md">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>
    <div id="class-return-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-20">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6">សងសៀវភៅសម្រាប់ថ្នាក់</h3>
            <form id="class-return-form">
                <input type="hidden" id="class-return-loan-id">
                <div class="mb-4">
                    <p><strong>សៀវភៅ:</strong> <span id="class-return-book-title"></span></p>
                    <p><strong>ថ្នាក់:</strong> <span id="class-return-class-name"></span></p>
                    <p><strong>ចំនួនខ្ចីសរុប:</strong> <span id="class-return-total-students"></span></p>
                    <p><strong>បានសងរួច:</strong> <span id="class-return-already-returned"></span></p>
                </div>
                <div class="mb-4">
                    <label for="number-to-return" class="block text-gray-700 mb-1">បញ្ចូលចំនួនសងបន្ថែម</label>
                    <input type="number" id="number-to-return" class="w-full px-3 py-2 border border-gray-300 rounded-md" required min="1">
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.closeClassReturnModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">បោះបង់</button>
                    <button type="submit" class="bg-teal-500 text-white px-4 py-2 rounded-md">រក្សាទុកការសង</button>
                </div>
            </form>
        </div>
    </div>
     <div id="class-loan-edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-20">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6">កែប្រែការខ្ចីតាមថ្នាក់</h3>
            <form id="class-loan-edit-form">
                <input type="hidden" id="class-loan-edit-id">
                <div class="mb-4">
                    <p><strong>សៀវភៅ:</strong> <span id="class-loan-edit-book-title"></span></p>
                    <p><strong>ថ្នាក់:</strong> <span id="class-loan-edit-class-name"></span></p>
                </div>
                <div class="mb-4">
                    <label for="class-loan-edit-date" class="block text-gray-700 mb-1">កាលបរិច្ឆេទខ្ចី</label>
                    <input type="date" id="class-loan-edit-date" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.closeClassLoanEditModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">បោះបង់</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">រក្សាទុកការផ្លាស់ប្តូរ</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Student Modal -->
    <div id="student-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-20">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
            <h3 id="student-modal-title" class="text-2xl font-bold mb-6">បន្ថែមសិស្សថ្មី</h3>
            <form id="student-form">
                <input type="hidden" id="student-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="student-no" class="block text-gray-700 mb-1">ល.រ</label>
                        <input type="text" id="student-no" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="student-code" class="block text-gray-700 mb-1">អត្តលេខ</label>
                        <input type="text" id="student-code" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="student-lastname" class="block text-gray-700 mb-1">នាមត្រកូល</label>
                        <input type="text" id="student-lastname" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="student-firstname" class="block text-gray-700 mb-1">នាមខ្លួន</label>
                        <input type="text" id="student-firstname" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="student-gender" class="block text-gray-700 mb-1">ភេទ</label>
                        <select id="student-gender" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="ប្រុស">ប្រុស</option>
                            <option value="ស្រី">ស្រី</option>
                        </select>
                    </div>
                    <div>
                        <label for="student-dob" class="block text-gray-700 mb-1">ថ្ងៃខែឆ្នាំកំណើត</label>
                        <input type="text" id="student-dob" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="student-class" class="block text-gray-700 mb-1">ថ្នាក់</label>
                        <input type="text" id="student-class" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="student-photo-url" class="block text-gray-700 mb-1">រូបថត URL</label>
                        <input type="url" id="student-photo-url" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.closeStudentModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md mr-2">បោះបង់</button>
                    <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-md">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Password Confirmation Modal -->
    <div id="password-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden no-print z-30">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">ยืนยันการลบ</h3>
            <p class="text-gray-600 mb-4">ដើម្បីยืนយ័ន សូមវាយបញ្ចូលรหัสผ่านរបស់អ្នក រួចចុចប៊ូតុង "ยืนยัน"។</p>
            <form id="password-confirm-form">
                <input type="hidden" id="collection-to-delete">
                <div>
                    <label for="user-password" class="block text-gray-700 mb-1">ពាក្យសម្ងាត់</label>
                    <input type="password" id="user-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    <p id="password-error" class="text-red-500 text-sm mt-1"></p>
                </div>
                <div class="flex justify-end mt-6 space-x-2">
                    <button type="button" onclick="window.closePasswordConfirmModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md">បោះបង់</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md">ยืนยัน</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex-col items-center justify-center z-40 hidden">
        <i class="fas fa-spinner fa-spin text-white text-5xl"></i>
        <p class="text-white text-xl mt-4">កំពុងដំណើរការ...</p>
    </div>
    
    <!-- Link to the external JavaScript file -->
    <script type="module" src="./app.js"></script>
</body>
</html>
