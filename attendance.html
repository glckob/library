<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- (UPDATED V14.23) -->
    <title>វត្តមានខ្ញុំ</title>
    <!-- 1. ភ្ជាប់ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ភ្ជាប់ Dexie.js (Database Offline) -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>

    <!-- (NEW V14.19) 3. ភ្ជាប់ SheetJS (Excel Library) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- 4. ភ្ជាប់ Khmer Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&family=Moul&display=swap" rel="stylesheet">


    <style>
        /* (NEW) អនុវត្ត Font */
        body {
            font-family: 'Kantumruy Pro', 'Khmer Os Siemreap', sans-serif;
        }
        h1, h2, h3, h4, h5, h6, .font-title {
            font-family: 'Moul', 'Khmer OS Muol Light', cursive;
        }

        .page-content { display: none; }
        #page-scan { display: block; }
        .section-divider { border-bottom: 2px dashed #cbd5e1; margin-top: 1.5rem; margin-bottom: 1.5rem; }
        
        /* (UPDATED) រចនាបថ VB.NET សម្រាប់ Form Elements (ស៊ុមពណ៌ខៀវ + លិចចូល) */
        input[type="text"],
        input[type="url"],
        input[type="date"],
        input[type="time"],
        input[type="file"],
        select {
            @apply block w-full px-4 py-3 border-2 border-blue-500 rounded-lg shadow-inner bg-white; /* (UPDATED) shadow-sm -> shadow-inner */
            @apply transition duration-150 ease-in-out;
            @apply focus:outline-none focus:ring-2 focus:ring-blue-500;
        }

        /* (UPDATED) រចនាបថ VB.NET 3D សម្រាប់ Buttons */
        .btn {
            @apply px-5 py-3 rounded-lg font-semibold text-white shadow-md;
            @apply transition-all duration-150 ease-in-out; /* (UPDATED) duration-300 -> 150 */
            @apply focus:outline-none focus:ring-2 focus:ring-opacity-75;
            @apply active:shadow-none active:translate-y-1; /* (NEW) 3D Press Effect */
        }
        .btn-blue {
            @apply bg-blue-600 border-b-4 border-blue-800 focus:ring-blue-500;
            @apply active:border-b-0;
        }
        .btn-green {
            @apply bg-green-600 border-b-4 border-green-800 focus:ring-green-500;
            @apply active:border-b-0;
        }
        .btn-red {
            @apply bg-red-600 border-b-4 border-red-800 focus:ring-red-500;
            @apply active:border-b-0;
        }
        .btn-yellow {
            @apply bg-yellow-600 border-b-4 border-yellow-800 focus:ring-yellow-500;
            @apply active:border-b-0;
        }
        .btn-purple {
            @apply bg-purple-600 border-b-4 border-purple-800 focus:ring-purple-500;
            @apply active:border-b-0;
        }
        .btn-gray {
            @apply bg-gray-500 border-b-4 border-gray-700 focus:ring-gray-400;
            @apply active:border-b-0;
        }

        /* (NEW) Animation សម្រាប់ពេលទិន្នន័យបង្ហាញ */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }

        /* (UPDATED) សម្រាប់ប៊ូតុង Nav ខាងលើ (VB.NET Style + Active Light Blue) */
        .nav-link {
            @apply px-4 py-2 rounded-lg font-semibold border-b-4 shadow-md; /* (NEW) VB.NET style */
            @apply bg-gray-200 text-gray-700 border-gray-400; /* (NEW) Default VB.NET colors */
            @apply transition-all duration-150 ease-in-out;
            @apply active:shadow-none active:translate-y-1 active:border-b-0;
        }
        .nav-link:hover {
            @apply bg-gray-300; /* (NEW) Hover */
        }
        .nav-link.nav-btn-active { /* Active state (UPDATED) */
            @apply bg-blue-300 text-blue-900 border-blue-500; /* (UPDATED) Light Blue */
            @apply transform scale-110 shadow-lg; /* (UPDATED) ទ្រុធ (Bulky) */
            @apply active:scale-110 active:translate-y-0 active:shadow-lg; /* (NEW) Prevent press effect when active */
        }
        .nav-link.nav-btn-active:hover {
            @apply bg-blue-300; /* (NEW) Keep color on hover */
        }


        /* សម្រាប់ទម្រង់បោះពុម្ព */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; }
            
            /* (UPDATED V14.2) Portrait + Narrow margin */
            @page { 
                size: A4 portrait; 
                margin: 12.7mm; /* Narrow */
            }

            /* (NEW V14.22) សម្រាប់ក្បាលទំព័របោះពុម្ព */
            .print-header {
                display: table;
                width: 100%;
                margin-bottom: 10px;
            }
            .header-left {
                display: table-cell;
                text-align: left;
                vertical-align: top;
                width: 25%; /* (UPDATED) */
            }
            .header-center {
                display: table-cell;
                text-align: center;
                vertical-align: top;
            }
            .header-right {
                display: table-cell;
                text-align: right;
                vertical-align: top;
                width: 25%; /* (UPDATED) */
                font-size: 12px;
                line-height: 1.5;
            }
            /* (NEW V14.22) សម្រាប់បោះពុម្ពតារាងវេនសំអាត */
            table.print-roster {
                width: 100%; 
                border-collapse: collapse; 
                margin-top: 20px; 
                table-layout: fixed; /* Equal columns */
            }
            table.print-roster th {
                font-family: 'Moul', 'Khmer OS Muol Light', cursive;
                font-size: 16px;
                padding: 10px;
                border: 1px solid black;
                background-color: #f2f2f2;
                text-align: center;
            }
            table.print-roster td { 
                border: 1px solid black; 
                padding: 10px; 
                vertical-align: top;
                font-size: 14px;
                line-height: 1.6;
            }
            table.print-roster td ol {
                margin: 0;
                padding-left: 20px;
            }

        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex flex-wrap justify-between items-center">
            <!-- (UPDATED V14.23) -->
            <div class="text-2xl font-bold text-blue-600 font-title">ប្រព័ន្ធអវត្តមាន (Offline V14.23)</div>
            <!-- (UPDATED) Nav Buttons -->
            <div class="flex flex-wrap gap-3 mt-4 md:mt-0">
                <button id="nav-scan" onclick="showPage('page-scan')" class="nav-link nav-btn-active">ស្កេន QR</button>
                <button id="nav-student" onclick="showPage('page-manage-student')" class="nav-link">គ្រប់គ្រងសិស្ស</button>
                <button id="nav-schedule" onclick="showPage('page-manage-schedule')" class="nav-link">គ្រប់គ្រងកាលវិភាគ</button>
                <button id="nav-class" onclick="showPage('page-manage-class')" class="nav-link">គ្រប់គ្រងថ្នាក់រៀន</button>
                <button id="nav-report" onclick="showPage('page-report')" class="nav-link">របាយការណ៍</button>
                <!-- (NEW V14.20) Cleaning Roster Button -->
                <button id="nav-cleaning" onclick="showPage('page-cleaning-roster')" class="nav-link">វេនសំអាត</button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-6">

        <!-- (UPDATED) Page: Scan QR (Default) -->
        <div id="page-scan" class="page-content">
            <h1 class="text-3xl mb-6 text-gray-800 font-title">ទំព័រស្កេន QR កាតសិស្ស ចេញ-ចូល </h1>
            
            <!-- (UPDATED) Layout 5 ស្ទឹង (1 ខាងឆ្វេង, 3 កណ្តាល, 1 ខាងស្តាំ) -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                
                <!-- ស្ទឹងខាងឆ្វេង: កន្លែងស្កេន (តូច) -->
                <div class="bg-white p-6 rounded-lg shadow-lg md:col-span-1">
                    <!-- USB Scan UI (Default) -->
                    <div id="usb-scan-ui">
                        <label for="usb-scanner-input" class="block text-xl font-medium text-gray-700 mb-4">ស្កេនកូដសិស្ស៖</label>
                        <!-- (UPDATED) មិនបាច់កំណត់ border នៅទីនេះទេ ព្រោះ global style គ្រប់គ្រងហើយ -->
                        <input type="text" id="usb-scanner-input" class="p-4 rounded-lg w-full text-3xl text-center focus:ring-2 focus:ring-blue-500" placeholder="...ស្កេន...">
                        <p class="text-center text-gray-500 mt-3">ចុច Enter ដើម្បីពិនិត្យ</p>
                    </div>

                    <!-- Scan Result (សម្រាប់ Error ឬ Loading) -->
                    <div id="scan-result" class="mt-6 text-center">
                        <div class="p-4 bg-blue-100 text-blue-700 rounded-lg">
                            <p class="text-lg">ត្រៀមខ្លួន...</p>
                        </div>
                    </div>
                </div>

                <!-- ស្ទឹងកណ្តាល: បង្ហាញទិន្នន័យសិស្ស (ធំ) -->
                <div id="student-info-display" class="relative md:col-span-2 md:col-start-2">
                    <!-- (UPDATED) បន្ថែម wrapper ដើម្បីកំណត់ទំហំ និងដាក់កណ្តាល -->
                    <div class="max-w-sm mx-auto">
                        <div class="bg-white p-6 rounded-lg shadow-lg h-full flex items-center justify-center">
                            <div class="text-center text-gray-400">
                                <svg class="mx-auto h-24 w-24" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A1.5 1.5 0 0 1 18 21.75H6a1.5 1.5 0 0 1-1.499-1.632Z" />
                                </svg>
                                <p class="mt-4 text-xl">ព័ត៌មានសិស្សនឹងបង្ហាញនៅទីនេះ</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- (NEW) ស្ទឹងខាងស្តាំ: សម្រាប់ពាក្យ ចូល/ចេញ -->
                <div id="scan-status-display" class="md:col-span-1 md:col-start-4 flex items-center justify-center">
                    <!-- ស្ថានភាព ចូល/ចេញ នឹងបង្ហាញនៅទីនេះ -->
                </div>

            </div>
        </div>

        <!-- Page: Manage Students -->
        <div id="page-manage-student" class="page-content">
            <h1 class="text-3xl font-bold mb-6 text-gray-800 font-title">គ្រប់គ្រងសិស្ស</h1>
            <!-- ... Form បញ្ចូលសិស្ស ... -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6" style="display: none;">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ចូលសិស្សថ្មី</h2>
                <form id="addStudentForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="studentId" placeholder="កូដសិស្ស (សម្រាប់ QR)" class="md:col-span-1" required>
                    <input type="text" id="lastName" placeholder="គោតនាម" required>
                    <input type="text" id="firstName" placeholder="នាម" required>
                    <select id="gender" required>
                        <option value="">-- ជ្រើសរើសភេទ --</option>
                        <option value="ប្រុស">ប្រុស</option>
                        <option value="ស្រី">ស្រី</option>
                    </select>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ថ្ងៃខែឆ្នាំកំណើត</label>
                        <input type="date" id="dob" required>
                    </div>
                    <select id="studentClassId" class="class-select" required>
                        <option value="">-- ជ្រើសរើសថ្នាក់ --</option>
                    </select>
                    <input type="url" id="photoUrl" placeholder="URL រូបថត (បើមាន)" class="md:col-span-2">
                    <button type="submit" class="btn btn-green md:col-span-4">បន្ថែមសិស្ស</button>
                </form>
            </div>
            <!-- (UPDATED V14.23) តារាងសិស្ស -->
            <div class="bg-white p-6 rounded-lg shadow-lg overflow-x-auto">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ជីសិស្ស</h2>
                
                <!-- (NEW V14.23) Filter, Sort, and Search Bar -->
                <div class="mb-4 space-y-4">
                    <!-- Row 1: Filters & Sort -->
                    <div class="flex flex-wrap gap-4">
                        <!-- Filter by Class -->
                        <div class="flex-grow">
                            <label for="filterStudentClass" class="block text-sm font-medium text-gray-700 mb-1">ត្រងតាមថ្នាក់៖</label>
                            <select id="filterStudentClass" class="class-select" onchange="loadStudents()">
                                <option value="all">-- គ្រប់ថ្នាក់រៀន --</option>
                                <!-- Options will be loaded by loadClassesForSelect() -->
                            </select>
                        </div>
                        <!-- Sort by -->
                        <div class="flex-grow">
                            <label for="sortStudentBy" class="block text-sm font-medium text-gray-700 mb-1">តម្រៀបតាម៖</label>
                            <select id="sortStudentBy" onchange="loadStudents()">
                                <option value="name">ឈ្មោះសិស្ស (A-Z)</option>
                                <option value="class">ថ្នាក់ (A-Z)</option>
                            </select>
                        </div>
                    </div>
                    <!-- Row 2: Search & Delete -->
                    <div class="flex flex-wrap gap-4">
                        <input type="text" id="searchStudentInput" oninput="loadStudents()" placeholder="ស្វែងរកតាម កូដ, គោតនាម, ឬ នាម..." class="w-full md:w-1/2 flex-grow">
                        <button onclick="confirmDelete('students_all', 0, 'សិស្សទាំងអស់')" class="btn btn-red">លុបសិស្សទាំងអស់</button>
                    </div>
                </div>

                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-200 text-left">
                            <th class="px-4 py-2">រូបថត</th>
                            <th class="px-4 py-2">កូដសិស្ស</th>
                            <!-- (UPDATED) ប្តូរ គោតនាម/នាម ទៅជា ឈ្មោះសិស្ស -->
                            <th class="px-4 py-2">ឈ្មោះសិស្ស</th>
                            <!-- <th class="px-4 py-2">គោតនាម</th>
                            <th class="px-4 py-2">នាម</th> -->
                            <th class="px-4 py-2">ភេទ</th>
                            <th class="px-4 py-2">អាយុ</th>
                            <th class="px-4 py-2">ថ្នាក់</th>
                            <th class="px-4 py-2">សកម្មភាព</th>
                        </tr>
                    </thead>
                    <tbody id="student-list"></tbody>
                </table>
            </div>
        </div>

        <!-- (UPDATED) Page: Manage Schedule -->
        <div id="page-manage-schedule" class="page-content">
            <h1 class="text-3xl font-bold mb-6 text-gray-800 font-title">គ្រប់គ្រងកាលវិភាគ</h1>
            <!-- ... Form បញ្ចូលកាលវិភាគ ... -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ចូលកាលវិភាគថ្មី</h2>
                <form id="addScheduleForm" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <select id="scheduleClassId" class="class-select" required>
                        <option value="">-- ជ្រើសរើសថ្នាក់ --</option>
                    </select>
                    <select id="dayOfWeek" required>
                        <option value="1">ច័ន្ទ</option>
                        <option value="2">អង្គារ</option>
                        <option value="3">ពុធ</option>
                        <option value="4">ព្រហស្បតិ៍</option>
                        <option value="5">សុក្រ</option>
                        <option value="6">សៅរ៍</option>
                        <option value="0">អាទិត្យ</option>
                    </select>
                    <input type="time" id="startTime" required title="ម៉ោងចូលរៀន">
                    <input type="time" id="endTime" required title="ម៉ោងចេញ">
                    <button type="submit" class="btn btn-green">បន្ថែមកាលវិភាគ</button>
                </form>
            </div>
            <!-- (UPDATED) តារាងកាលវិភាគ -->
            <div class="bg-white p-6 rounded-lg shadow-lg overflow-x-auto">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ជីកាលវិភាគ</h2>
                <!-- (UPDATED V14.15) Search Bar + Delete All Button -->
                <div class="mb-4 flex flex-wrap gap-4">
                    <input type="text" id="searchScheduleInput" oninput="loadSchedules()" placeholder="ស្វែងរកតាមថ្នាក់..." class="w-full md:w-1/2 flex-grow">
                    <button onclick="confirmDelete('schedule_all', 0, 'កាលវិភាគទាំងអស់')" class="btn btn-red">លុបកាលវិភាគទាំងអស់</button>
                </div>
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-200 text-left">
                            <th class="px-4 py-2">ថ្នាក់</th>
                            <th class="px-4 py-2">ថ្ងៃ</th>
                            <th class="px-4 py-2">ម៉ោងចូល</th>
                            <th class="px-4 py-2">ម៉ោងចេញ</th>
                            <th class="px-4 py-2">សកម្មភាព</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-list"></tbody>
                </table>
            </div>
        </div>

        <!-- (UPDATED) Page: Manage Classes -->
        <div id="page-manage-class" class="page-content">
            <h1 class="text-3xl font-bold mb-6 text-gray-800 font-title">គ្រប់គ្រងថ្នាក់រៀន</h1>
            <!-- ... Form បញ្ចូលថ្នាក់ ... -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ចូលថ្នាក់ថ្មី</h2>
                <form id="addClassForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="classId" placeholder="លេខកូដថ្នាក់ (VD: 12A)" required>
                    <input type="text" id="className" placeholder="ឈ្មោះថ្នាក់ (VD: ថ្នាក់ទី១២ A)" required>
                    <!-- (UPDATED V14.16) Placeholder នឹងត្រូវបានកំណត់ដោយ JS -->
                    <input type="text" id="academicYear" placeholder="ឆ្នាំសិក្សា..." required>
                    <button type="submit" class="btn btn-green">បន្ថែមថ្នាក់</button>
                </form>
            </div>
            <!-- (UPDATED V14.9) ប៊ូតុង Sync -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                <h2 class="text-xl font-semibold mb-4 font-title">ទាញយកទិន្នន័យ</h2>
                <button onclick="syncClassesFromStudents()" class="btn btn-purple">ទាញយកថ្នាក់ពីបញ្ជីសិស្ស</button>
                <p class="mt-2 text-sm text-gray-600">
                    ប្រើមុខងារនេះ ប្រសិនបើអ្នកបាននាំចូល (Import) បញ្ជីសិស្ស ហើយចង់បង្កើតថ្នាក់រៀនដោយស្វ័យប្រវត្តិ។<br>
                    វានឹងស្កេនបញ្ជីសិស្ស ហើយបន្ថែមថ្នាក់ដែលមិនទាន់មាន ចូលទៅក្នុងតារាង "បញ្ជីថ្នាក់រៀន"។<br>
                    <!-- (UPDATED V14.16) -->
                    (ឈ្មោះថ្នាក់ នឹងដូចលេខកូដថ្នាក់, ឆ្នាំសិក្សា នឹងយកពីទំព័រកំណត់)
                </p>
            </div>
            <!-- (UPDATED) តារាងថ្នាក់ -->
            <div class="bg-white p-6 rounded-lg shadow-lg overflow-x-auto">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ជីថ្នាក់រៀន</h2>
                <!-- (UPDATED V14.15) Search Bar + Delete All Button -->
                <div class="mb-4 flex flex-wrap gap-4">
                    <input type="text" id="searchClassInput" oninput="loadClassesForTable()" placeholder="ស្វែងរកតាមលេខកូដ ឬ ឈ្មោះថ្នាក់..." class="w-full md:w-1/2 flex-grow">
                    <button onclick="confirmDelete('classes_all', 0, 'ថ្នាក់រៀនទាំងអស់')" class="btn btn-red">លុបថ្នាក់ទាំងអស់</button>
                </div>
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-200 text-left">
                            <th class="px-4 py-2">លេខកូដ</th>
                            <th class="px-4 py-2">ឈ្មោះថ្នាក់</th>
                            <th class="px-4 py-2">ឆ្នាំសិក្សា</th>
                            <th class="px-4 py-2">សកម្មភាព</th>
                        </tr>
                    </thead>
                    <tbody id="class-list"></tbody>
                </table>
            </div>
        </div>

        <!-- (UPDATED) Page: Report -->
        <div id="page-report" class="page-content">
            <h1 class="text-3xl font-bold mb-6 text-gray-800 font-title">របាយការណ៍អវត្តមាន</h1>
            <!-- (UPDATED V14.11) ផ្ទាំង Filter (Auto-load) -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6 flex flex-wrap gap-4 items-center">
                <div class="flex space-x-4" id="reportTypeSelector">
                    <label class="flex items-center"><input type="radio" name="reportType" value="daily" checked class="mr-2" onchange="loadReportData()">ប្រចាំថ្ងៃ</label>
                    <label class="flex items-center"><input type="radio" name="reportType" value="weekly" class="mr-2" onchange="loadReportData()">ប្រចាំសប្តាហ៍</label>
                    <label class="flex items-center"><input type="radio" name="reportType" value="monthly" class="mr-2" onchange="loadReportData()">ប្រចាំខែ</label>
                </div>
                <!-- (UPDATED V14.11) Auto-load + "សូមជ្រើសរើស" -->
                <select id="reportFilterClass" class="class-select" onchange="loadReportData()">
                    <option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option>
                    <option value="">-- គ្រប់ថ្នាក់រៀន --</option>
                </select>
                <input type="date" id="reportFilterDate" onchange="loadReportData()">
                <!-- (NEW V14.6) Filter by Status -->
                <select id="reportFilterStatus" onchange="loadReportData()">
                    <option value="all">-- គ្រប់ស្ថានភាព --</option>
                    <option value="present">វត្តមាន</option>
                    <option value="late">មកយឺត</option>
                    <option value="absent">អវត្តមាន</option>
                    <option value="no_checkout">មិនបានស្កេនចេញ</option>
                    <option value="not_scanned">មិនទាន់បានស្កេន</option>
                    <option value="no_class">មិនមានថ្នាក់រៀន</option> <!-- (NEW V14.11) -->
                </select>
                <!-- (REMOVED V14.11) ប៊ូតុង "បង្ហាញ" -->
                <!-- (UPDATED V14.19) CSV -> XLSX -->
                <button onclick="exportReportToExcel()" class="btn btn-yellow">នាំចេញ .XLSX</button>
                <button onclick="printReport()" class="btn btn-gray">បោះពុម្ព</button>
            </div>
            <!-- (UPDATED V14.15) Search Bar for Report + Delete All Button -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6 flex flex-wrap gap-4">
                <input type="text" id="searchReportInput" oninput="loadReportData()" placeholder="ស្វែងរកសិស្សក្នុងរបាយការណ៍នេះ..." class="w-full md:w-1/2 flex-grow">
                <button onclick="confirmDelete('attendanceLog_all', 0, 'កំណត់ត្រាអវត្តមានទាំងអស់')" class="btn btn-red">លុបកំណត់ត្រាទាំងអស់</button>
            </div>
            <div id="report-date-range" class="mb-4 text-lg font-semibold text-gray-700"></div>
            <!-- (UPDATED V14.12) តារាងរបាយការណ៍ (ប្តូរ Head/Body) -->
            <div class="bg-white p-6 rounded-lg shadow-lg overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-200 text-left" id="report-table-header">
                            <!-- Header នឹងត្រូវបានបង្កើតដោយ Javascript (V14.12) -->
                        </tr>
                    </thead>
                    <tbody id="report-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- (NEW V14.20) Page: Cleaning Roster -->
        <div id="page-cleaning-roster" class="page-content">
            <h1 class="text-3xl font-bold mb-6 text-gray-800 font-title">វេនសំអាតប្រចាំថ្នាក់</h1>
            
            <!-- Filter Bar -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6 flex flex-wrap gap-4 items-center">
                <select id="rosterFilterClass" class="class-select" onchange="clearRoster()">
                    <option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option>
                    <!-- ថ្នាក់នឹងត្រូវបានផ្ទុកដោយ JS -->
                </select>
                <button onclick="generateCleaningRoster()" class="btn btn-blue">បង្កើតតារាងវេន</button>
                <button onclick="printCleaningRoster()" class="btn btn-gray">បោះពុម្ពតារាងវេន</button>
            </div>
            
            <!-- Roster Display Area -->
            <div id="roster-display-area" class="bg-white p-6 rounded-lg shadow-lg">
                <p class="text-center text-gray-500">សូមជ្រើសរើសថ្នាក់ ហើយចុច "បង្កើតតារាងវេន"។</p>
                <!-- Roster content will be injected here -->
            </div>
        </div>

    </main>

    <!-- (MODIFIED) Edit Modals (ពី V7) -->
    <!-- Edit Class Modal -->
    <div id="editClassModal" style="display: none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-20">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 font-title">កែសម្រួលថ្នាក់រៀន</h2>
            <form id="editClassForm">
                <input type="hidden" id="editClassDbId">
                <div class="mb-4">
                    <label class="block text-gray-700">លេខកូដថ្នាក់ (មិនអាចកែបាន)</label>
                    <input type="text" id="editClassId" class="bg-gray-100" readonly>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700">ឈ្មោះថ្នាក់</label>
                    <input type="text" id="editClassName" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700">ឆ្នាំសិក្សា</label>
                    <input type="text" id="editAcademicYear" required>
                </div>
                <!-- (NEW V14.22) Edit teacher name/sig in modal -->
                <div class="mb-4">
                    <label class="block text-gray-700">ឈ្មោះគ្រូបន្ទុកថ្នាក់</label>
                    <input type="text" id="editClassTeacherName">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700">URL ហត្ថលេខាគ្រូ</label>
                    <input type="url" id="editClassSignatureUrl">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeEditModal('class')" class="btn btn-gray">បោះបង់</button>
                    <button type="submit" class="btn btn-blue">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Edit Student Modal -->
    <div id="editStudentModal" style="display: none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-20">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4 font-title">កែសម្រួលព័ត៌មានសិស្ស</h2>
            <form id="editStudentForm">
                <input type="hidden" id="editStudentDbId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700">កូដសិស្ស (មិនអាចកែបាន)</label>
                        <input type="text" id="editStudentId" class="bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-gray-700">ថ្នាក់រៀន</label>
                        <select id="editStudentClassId" class="class-select" required></select>
                    </div>
                    <div>
                        <label class="block text-gray-700">គោតនាម</label>
                        <input type="text" id="editLastName" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">នាម</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">ភេទ</label>
                        <select id="editGender" required>
                            <option value="ប្រុស">ប្រុស</option>
                            <option value="ស្រី">ស្រី</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700">ថ្ងៃខែឆ្នាំកំណើត</label>
                        <input type="date" id="editDob" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700">URL រូបថត (បើមាន)</label>
                        <input type="url" id="editPhotoUrl">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="closeEditModal('student')" class="btn btn-gray">បោះបង់</button>
                    <button type="submit" class="btn btn-blue">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Edit Schedule Modal -->
    <div id="editScheduleModal" style="display: none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-20">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4 font-title">កែសម្រួលកាលវិភាគ</h2>
            <form id="editScheduleForm">
                <input type="hidden" id="editScheduleDbId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700">ថ្នាក់រៀន</label>
                        <select id="editScheduleClassId" class="class-select" required></select>
                    </div>
                    <div>
                        <label class="block text-gray-700">ថ្ងៃ</label>
                        <select id="editDayOfWeek" required>
                            <option value="1">ច័ន្ទ</option>
                            <option value="2">អង្គារ</option>
                            <option value="3">ពុធ</option>
                            <option value="4">ព្រហស្បតិ៍</option>
                            <option value="5">សុក្រ</option>
                            <option value="6">សៅរ៍</option>
                            <option value="0">អាទិត្យ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700">ម៉ោងចូល</label>
                        <input type="time" id="editStartTime" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">ម៉ោងចេញ</label>
                        <input type="time" id="editEndTime" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="closeEditModal('schedule')" class="btn btn-gray">បោះបង់</button>
                    <button type="submit" class="btn btn-blue">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>

    <!-- (NEW) Delete Confirmation Modal -->
    <div id="confirmDeleteModal" style="display: none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-30">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-red-600 font-title">បញ្ជាក់ការលុប</h2>
            <p id="confirm-message" class="mb-4 text-gray-700">តើអ្នកពិតជាចង់លុបទិន្នន័យនេះមែនទេ?</p>
            <p id="confirm-warning" class="mb-6 text-sm text-red-700"></p>
            <div class="flex justify-end space-x-4">
                <button type="button" onclick="closeDeleteModal()" class="btn btn-gray">បោះបង់</button>
                <button type="button" onclick="executeDelete()" class="btn btn-red">យល់ព្រម លុប</button>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" style="display: none;" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white z-50"></div>

    <script>
        // --- 1. ការរៀបចំ Database (Offline) ជាមួយ Dexie.js ---
        const db = new Dexie("AttendanceDB");
        // (UPDATED V14.22) Bump version to 3 for new class fields
        db.version(3).stores({
            classes: "++id, &classId, academicYear, teacherName, signatureUrl", // (UPDATED)
            students: "++id, &studentId, classId, lastName, firstName, dob, gender, photoUrl",
            schedule: "++id, classId, dayOfWeek",
            attendanceLog: "++id, [studentId+scheduleId+attendanceDate], attendanceDate, classId, studentName"
        }).upgrade(tx => {
            // This upgrade function will only run when upgrading from a version < 3
            // It ensures new fields 'teacherName' and 'signatureUrl' are added to 'classes'
            return tx.table('classes').toCollection().modify(cls => {
                if (cls.teacherName === undefined) {
                    cls.teacherName = ""; // Add new field with default value
                }
                if (cls.signatureUrl === undefined) {
                    cls.signatureUrl = ""; // Add new field with default value
                }
            });
        });

        // --- Cache សម្រាប់ទិន្នន័យ ---
        let allClasses = [];
        let allSchedules = [];
        let currentReportData = []; // សម្រាប់ផ្ទុកទិន្នន័យរបាយការណ៍ដែលបានត្រង (V14.12)
        const khmerMonths = ["មករា", "កុម្ភៈ", "មីនា", "មេសា", "ឧសភា", "មិថុនា", "កក្កដា", "សីហា", "កញ្ញា", "តុលា", "វិច្ឆិកា", "ធ្នូ"];
        const PLACEHOLDER_IMG = "https://placehold.co/400x400/eee/ccc?text=%E1%9E%9A%E1%9E%BC%E1%9E%94%E1%9E%90%E1%9E%B6";

        // --- 2. ការគ្រប់គ្រងទំព័រ (Page Navigation) ---
        // (REMOVED) currentScanner, availableCameras

        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
            
            // (UPDATED) Handle Nav Button Active State
            document.querySelectorAll('.nav-link').forEach(btn => {
                btn.classList.remove('nav-btn-active');
            });
            const navIdMap = {
                'page-scan': 'nav-scan',
                'page-manage-student': 'nav-student',
                'page-manage-schedule': 'nav-schedule',
                'page-manage-class': 'nav-class',
                'page-report': 'nav-report',
                'page-cleaning-roster': 'nav-cleaning' // (NEW V14.20)
            };
            if (navIdMap[pageId]) {
                document.getElementById(navIdMap[pageId]).classList.add('nav-btn-active');
            }
            
            // (UPDATED V14.20)
            if (pageId.startsWith('page-manage-') || pageId === 'page-report' || pageId === 'page-cleaning-roster' || pageId === 'page-manage-student') {
                if (window.loadClassesForSelect) window.loadClassesForSelect();
            }
            if (pageId === 'page-manage-student' && window.loadStudents) window.loadStudents();
            if (pageId === 'page-manage-schedule' && window.loadSchedules) window.loadSchedules();
            if (pageId === 'page-manage-class' && window.loadClassesForTable) window.loadClassesForTable();
            // (REMOVED V14.11) មិនចាំបាច់ load report នៅពេលប្តូរទំព័រទេ
            // if (pageId === 'page-report') loadReportData(); 
            
            // (NEW) Auto-focus scan input
            if (pageId === 'page-scan') {
                // Use setTimeout to ensure element is visible before focusing
                setTimeout(() => {
                    document.getElementById('usb-scanner-input').focus();
                }, 100);
            }
        }

        // --- 3. មុខងារគ្រប់គ្រងថ្នាក់ (Manage Classes) ---
        async function loadClassesForSelect() {
            try {
                allClasses = await db.classes.toArray();
                const classSelects = document.querySelectorAll('.class-select');
                classSelects.forEach(sel => {
                    const firstOption = sel.options[0] ? sel.options[0].outerHTML : '<option value="">-- ជ្រើសរើសថ្នាក់ --</option>';
                    // (UPDATED V14.11) រក្សាជម្រើសទីមួយ (ប្រសិនបើមាន)
                    sel.innerHTML = firstOption; 
                    
                    // (NEW V14.11) បន្ថែម "គ្រប់ថ្នាក់រៀន" សម្រាប់តែទំព័រ Report
                    if (sel.id === 'reportFilterClass') {
                        sel.innerHTML += '<option value="">-- គ្រប់ថ្នាក់រៀន --</option>';
                    }

                    allClasses.sort((a,b) => a.classId.localeCompare(b.classId, 'km')).forEach(cls => {
                        sel.innerHTML += `<option value="${cls.classId}">${cls.className} (${cls.academicYear})</option>`;
                    });
                });
            } catch (error) { console.error("Error loading classes for select: ", error); }
        }
        async function loadClassesForTable() {
            try {
                const classList = document.getElementById('class-list');
                classList.innerHTML = '<tr><td colspan="4" class="text-center p-4">កំពុងទាញយក...</td></tr>';
                allClasses = await db.classes.toArray();
                
                // (NEW V14.14) Filter logic
                const searchTerm = document.getElementById('searchClassInput').value.toLowerCase();
                const filteredClasses = allClasses.filter(cls => 
                    cls.classId.toLowerCase().includes(searchTerm) ||
                    cls.className.toLowerCase().includes(searchTerm)
                );

                if (filteredClasses.length === 0) {
                    classList.innerHTML = '<tr><td colspan="4" class="text-center p-4">មិនមានទិន្នន័យទេ។</td></tr>';
                    return;
                }

                let rows = '';
                filteredClasses.sort((a,b) => a.classId.localeCompare(b.classId, 'km')).forEach(cls => {
                    const name = cls.className.replace(/'/g, "\\'"); // Escape quotes for JS
                    rows += `<tr>
                        <td class="border px-4 py-2">${cls.classId}</td>
                        <td class="border px-4 py-2">${cls.className}</td>
                        <td class="border px-4 py-2">${cls.academicYear}</td>
                        <td class="border px-4 py-2 whitespace-nowrap">
                            <button onclick="openEditModal('class', ${cls.id})" class="text-blue-600 hover:underline mr-2">កែ</button>
                            <button onclick="confirmDelete('classes', ${cls.id}, '${name}')" class="text-red-600 hover:underline">លុប</button>
                        </td>
                    </tr>`;
                });
                classList.innerHTML = rows;
            } catch (error) { 
                console.error("Error loading classes for table: ", error); 
                classList.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">Error!</td></tr>';
            }
        }
        document.getElementById('addClassForm').onsubmit = async (event) => {
            event.preventDefault();
            const classId = document.getElementById('classId').value;
            const className = document.getElementById('className').value;
            const academicYear = document.getElementById('academicYear').value;
            try {
                // (NEW V14.22) Add default empty fields for teacher/sig
                await db.classes.add({ 
                    classId, 
                    className, 
                    academicYear,
                    teacherName: "",
                    signatureUrl: ""
                });
                event.target.reset();
                showToast("បានបន្ថែមថ្នាក់រៀនថ្មី។");
                loadClassesForTable();
                loadClassesForSelect();
            } catch (error) {
                console.error("Error adding class: ", error);
                showToast("Error: លេខកូដថ្នាក់អាចជាន់គ្នា។", true);
            }
        };

        // (NEW V14.9) Sync classes from students table
        async function syncClassesFromStudents() {
            try {
                showToast("កំពុងស្កេនបញ្ជីសិស្ស...");
                const allStudents = await db.students.toArray();
                if (allStudents.length === 0) {
                    return showToast("មិនមានទិន្នន័យសិស្សសម្រាប់ទាញយកទេ។", true);
                }
                
                const uniqueClassIds = [...new Set(allStudents.map(s => s.classId))];
                if (allClasses.length === 0) {
                    await loadClassesForTable(); // ផ្ទុក allClasses
                }
                
                const existingClassIds = new Set(allClasses.map(c => c.classId));
                const newClasses = [];
                
                // (NEW V14.16) យកឆ្នាំសិក្សាលំនាំដើម
                const defaultYear = localStorage.getItem('settingAcademicYear') || 'N/A';
                
                for (const classId of uniqueClassIds) {
                    if (classId && !existingClassIds.has(classId)) {
                        newClasses.push({
                            classId: classId,
                            className: classId, // (UPDATED V14.16)
                            academicYear: defaultYear, // (UPDATED V14.16)
                            teacherName: "", // (NEW V14.22)
                            signatureUrl: "" // (NEW V14.22)
                        });
                    }
                }
                
                if (newClasses.length > 0) {
                    await db.classes.bulkAdd(newClasses);
                    showToast(`បានបន្ថែមថ្នាក់ថ្មី ${newClasses.length}។`);
                    await loadClassesForTable();
                    await loadClassesForSelect();
                } else {
                    showToast("ថ្នាក់រៀនទាំងអស់ មានទិន្នន័យរួចហើយ។");
                }
            } catch (error) {
                console.error("Error syncing classes: ", error);
                showToast(`មានបញ្ហា៖ ${error.message}`, true);
            }
        }


        // --- 4. មុខងារគ្រប់គ្រងសិស្ស (Manage Students) ---
        function calculateAge(dobString) {
            if (!dobString) return "N/A";
            try {
                const dob = new Date(dobString);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) { age--; }
                return age;
            } catch (e) { return "N/A"; }
    }

    // --- Helpers ---
    const fmtTimeHHMM = (d) => String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    const todayISO = () => new Date().toISOString().slice(0,10);

    // Fetchers
    async function fetchClasses() {
        const { data, error } = await supabase.from('classes').select('*').eq('user_id', currentUserId).order('class_id');
        if (error) throw error; return data || [];
    }
    async function fetchStudents(classId = null) {
        let q = supabase.from('students').select('*').eq('user_id', currentUserId);
        if (classId) q = q.eq('class_id', classId);
        const { data, error } = await q.order('last_name');
        if (error) throw error; return data || [];
    }
    async function fetchSchedules(classId = null) {
        let q = supabase.from('schedules').select('*').eq('user_id', currentUserId);
        if (classId) q = q.eq('class_id', classId);
        const { data, error } = await q.order('class_id');
        if (error) throw error; return data || [];
    }

    // Populate selects and tables using Supabase
    window.loadClassesForSelect = async function loadClassesForSelect() {
        if (!(await ensureAuth())) return;
        let classes = await fetchClasses();
        // Fallback: derive classes from students if classes table is empty
        if (!classes || classes.length === 0) {
            const { data: sdata, error: sErr } = await supabase
                .from('students').select('class_id').eq('user_id', currentUserId);
            if (!sErr) {
                const defaultYear = localStorage.getItem('settingAcademicYear') || '';
                const uniq = [...new Set((sdata||[]).map(s => s.class_id).filter(Boolean))];
                classes = uniq.map(id => ({ class_id: id, class_name: id, academic_year: defaultYear }));
            }
        }
        window.allClasses = classes; // keep cache used elsewhere in page

        // class selects
        const selects = document.querySelectorAll('.class-select');
        selects.forEach(sel => {
            const prev = sel.value;
            const firstOption = sel.options[0] ? sel.options[0].outerHTML : '<option value="">-- ជ្រើសរើសថ្នាក់ --</option>';
            sel.innerHTML = firstOption;
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.class_id; // store class_id
                opt.textContent = c.class_name + (c.academic_year ? ` (${c.academic_year})` : '');
                sel.appendChild(opt);
            });

            if (prev) sel.value = prev;
        });
        // report/class filters
        const repSel = document.getElementById('reportFilterClass');
        if (repSel) {
            const prev = repSel.value;
            repSel.innerHTML = '<option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option><option value="">-- គ្រប់ថ្នាក់រៀន --</option>';
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.class_id; opt.textContent = c.class_name;
                repSel.appendChild(opt);
            });
            if (prev) repSel.value = prev;
        }
        const rosterSel = document.getElementById('rosterFilterClass');
        if (rosterSel) {
            const prev = rosterSel.value;
            rosterSel.innerHTML = '<option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option>';
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.class_id; opt.textContent = c.class_name;
                rosterSel.appendChild(opt);
            });
            if (prev) rosterSel.value = prev;
        }
    }

    // Table renderer for Classes (with fallback derived from students)
    window.loadClassesForTable = async function loadClassesForTable() {
        if (!(await ensureAuth())) return;
        const classList = document.getElementById('class-list');
        if (!classList) return;
        classList.innerHTML = '<tr><td colspan="4" class="text-center p-4">កំពុងទាញយក...</td></tr>';
        // Load classes (or derive from students)
        let classes = await fetchClasses();
        if (!classes || classes.length === 0) {
            const { data: sdata, error: sErr } = await supabase
                .from('students').select('class_id').eq('user_id', currentUserId);
            if (!sErr) {
                const defaultYear = localStorage.getItem('settingAcademicYear') || '';
                const uniq = [...new Set((sdata||[]).map(s => s.class_id).filter(Boolean))];
                classes = uniq.map(id => ({ class_id: id, class_name: id, academic_year: defaultYear }));
            }
        }
        // Cache for other consumers
        window.allClasses = classes;
        // Filter by search
        const search = (document.getElementById('searchClassInput')?.value || '').toLowerCase();
        const filtered = (classes || []).filter(c => (
            (c.class_id||'').toLowerCase().includes(search) || (c.class_name||'').toLowerCase().includes(search)
        ));
        if (filtered.length === 0) {
            classList.innerHTML = '<tr><td colspan="4" class="text-center p-4">មិនមានទិន្នន័យទេ។</td></tr>';
            return;
        }
        // Sort by class_id
        filtered.sort((a,b) => (a.class_id||'').localeCompare(b.class_id||''));
        // Render rows (leave action column empty for now)
        classList.innerHTML = filtered.map(cls => `
            <tr>
                <td class="border px-4 py-2">${cls.class_id||''}</td>
                <td class="border px-4 py-2">${cls.class_name||''}</td>
                <td class="border px-4 py-2">${cls.academic_year||''}</td>
                <td class="border px-4 py-2 whitespace-nowrap"></td>
            </tr>
        `).join('');
    }

    window.loadStudents = async function loadStudents() {
        if (!(await ensureAuth())) return;
        const classFilter = document.getElementById('filterStudentClass')?.value || 'all';
        const search = (document.getElementById('searchStudentInput')?.value || '').toLowerCase().trim();
        const sortBy = document.getElementById('sortStudentBy')?.value || 'name';
        const listEl = document.getElementById('student-list');
        if (!listEl) return;
        let students = await fetchStudents(classFilter === 'all' ? null : classFilter);
        if (search) {
            students = students.filter(s => `${s.student_id} ${s.last_name} ${s.first_name}`.toLowerCase().includes(search));
        }
        students.sort((a,b) => sortBy === 'class' ? a.class_id.localeCompare(b.class_id) : `${a.last_name} ${a.first_name}`.localeCompare(`${b.last_name} ${b.first_name}`));
        listEl.innerHTML = '';
        // Map class_id -> class_name for display
        const classNameById = new Map((window.allClasses||[]).map(c => [c.class_id, c.class_name]));
        for (const s of students) {
            const tr = document.createElement('tr'); tr.className='border-b';
            const photo = s.photo_url ? `<img src="${s.photo_url}" class="h-10 w-10 object-cover rounded"/>` : '';
            const age = (typeof window.calculateAge === 'function' && s.dob) ? window.calculateAge(s.dob) : '';
            const classLabel = classNameById.get(s.class_id) || s.class_id || '';
            tr.innerHTML = `
                <td class="px-4 py-2">${photo}</td>
                <td class="px-4 py-2">${s.student_id}</td>
                <td class="px-4 py-2">${s.last_name} ${s.first_name}</td>
                <td class="px-4 py-2">${s.gender || ''}</td>
                <td class="px-4 py-2">${age}</td>
                <td class="px-4 py-2">${classLabel}</td>
                <td class="px-4 py-2"><button class="btn btn-blue" onclick="openEditModal('student', ${s.id})">កែសម្រួល</button></td>`;
            listEl.appendChild(tr);
        }
    }

    window.loadSchedules = async function loadSchedules() {
        if (!(await ensureAuth())) return;
        const listEl = document.getElementById('schedule-list');
        if (!listEl) return;
        const search = (document.getElementById('searchScheduleInput')?.value || '').toLowerCase().trim();
        let items = await fetchSchedules();
        if (search) items = items.filter(x => x.class_id.toLowerCase().includes(search));
        listEl.innerHTML='';
        const dayMap = {0:'អាទិត្យ',1:'ច័ន្ទ',2:'អង្គារ',3:'ពុធ',4:'ព្រហស្បតិ៍',5:'សុក្រ',6:'សៅរ៍'};
        for (const sc of items) {
            const tr = document.createElement('tr'); tr.className='border-b';
            tr.innerHTML = `
                <td class="px-4 py-2">${sc.class_id}</td>
                <td class="px-4 py-2">${dayMap[sc.day_of_week]}</td>
                <td class="px-4 py-2">${sc.start_time}</td>
                <td class="px-4 py-2">${sc.end_time}</td>
                <td class="px-4 py-2"><button class="btn btn-blue" onclick="openEditModal('schedule', ${sc.id})">កែសម្រួល</button></td>`;
            listEl.appendChild(tr);
        }
    }
    async function processScan(code) {
        if (!(await ensureAuth())) return;
        const input = document.getElementById('usb-scanner-input');
        const statusBox = document.getElementById('scan-result');
        const show = (msg, ok=false) => { if(statusBox){ statusBox.innerHTML = `<div class="p-4 ${ok?'bg-green-100 text-green-700':'bg-red-100 text-red-700'} rounded-lg"><p class="text-lg">${msg}</p></div>`; } };
        try {
            const sid = (code||'').trim(); if (!sid) return;
            // find student
            const { data: stList, error: e1 } = await supabase.from('students').select('*').eq('user_id', currentUserId).eq('student_id', sid).limit(1);
            if (e1) throw e1;
            const student = (stList||[])[0];
            if (!student) { show('រកមិនឃើញសិស្សដោយកូដនេះ'); return; }

            // find active schedule for class now
            const now = new Date();
            const dow = now.getDay();
            const hhmm = fmtTimeHHMM(now);
            const { data: scheds, error: e2 } = await supabase.from('schedules').select('*')
                .eq('user_id', currentUserId).eq('class_id', student.class_id).eq('day_of_week', dow);
            if (e2) throw e2;
            const active = (scheds||[]).find(s => s.start_time <= hhmm && hhmm <= s.end_time);
            if (!active) { show('ថ្ងៃ/ម៉ោងនេះមិនមានថ្នាក់ (no class)'); return; }

            // existing open log for today?
            const today = todayISO();
            const { data: logs, error: e3 } = await supabase.from('attendance_logs')
                .select('id, scan_time_in, scan_time_out')
                .eq('user_id', currentUserId).eq('student_id', student.student_id)
                .eq('class_id', student.class_id).eq('schedule_id', active.id)
                .eq('attendance_date', today).is('scan_time_out', null).order('created_at', { ascending: false }).limit(1);
            if (e3) throw e3;
            if (logs && logs.length) {
                // set time out
                const { error: uerr } = await supabase.from('attendance_logs').update({ scan_time_out: new Date().toISOString() }).eq('id', logs[0].id);
                if (uerr) throw uerr;
                show('បានស្កេនចេញជោគជ័យ!', true);
            } else {
                // create new log (time in)
                const { error: ierr } = await supabase.from('attendance_logs').insert({
                    user_id: currentUserId,
                    student_id: student.student_id,
                    student_name: `${student.last_name} ${student.first_name}`,
                    class_id: student.class_id,
                    schedule_id: active.id,
                    attendance_date: today,
                    scan_time_in: new Date().toISOString(),
                });
                if (ierr) throw ierr;
                show('បានស្កេនចូលជោគជ័យ!', true);
            }
            input.value = '';
        } catch (err) {
            console.error(err);
            show('មានបញ្ហាក្នុងការកំណត់វត្តមាន');
        }
    }

    // Bind Enter key on scan input
    (function bindScan() {
        const input = document.getElementById('usb-scanner-input');
        if (!input) return;
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); processScan(input.value); }
        });
    })();

    // Report loader using agreed status logic
    window.loadReportData = async function loadReportData() {
        if (!(await ensureAuth())) return;
        const repType = (document.querySelector('input[name="reportType"]:checked')?.value) || 'daily';
        const classVal = document.getElementById('reportFilterClass')?.value || '';
        const statusVal = document.getElementById('reportFilterStatus')?.value || 'all';
        const dateInput = document.getElementById('reportFilterDate');
        let start, end;
        const d = new Date(dateInput?.value || new Date());
        if (repType === 'daily') {
            start = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            end = new Date(start); end.setDate(start.getDate()+1);
        } else if (repType === 'weekly') {
            const day = d.getDay(); const diff = (day+6)%7; // Monday-based
            start = new Date(d); start.setDate(d.getDate()-diff); start.setHours(0,0,0,0);
            end = new Date(start); end.setDate(start.getDate()+7);
        } else { // monthly
            start = new Date(d.getFullYear(), d.getMonth(), 1);
            end = new Date(d.getFullYear(), d.getMonth()+1, 1);
        }
        const startISO = start.toISOString().slice(0,10);
        const endISO = end.toISOString().slice(0,10);

        // Fetch logs
        let q = supabase.from('attendance_logs').select('*').eq('user_id', currentUserId).gte('attendance_date', startISO).lt('attendance_date', endISO);
        if (classVal) q = q.eq('class_id', classVal);
        const { data: logs, error } = await q.order('attendance_date');
        if (error) { console.error(error); return; }
        // Fetch students for absent/not_scanned
        const students = classVal ? await fetchStudents(classVal) : await fetchStudents();
        // Fetch schedules for late determination
        const schedules = await fetchSchedules(classVal || null);
        const scById = new Map(schedules.map(s => [s.id, s]));

        // Build rows
        const headerEl = document.getElementById('report-table-header');
        const bodyEl = document.getElementById('report-table-body');
        if (!headerEl || !bodyEl) return;
        headerEl.innerHTML = '<th class="px-4 py-2">កាលបរិច្ឆេទ</th><th class="px-4 py-2">សិស្ស</th><th class="px-4 py-2">ថ្នាក់</th><th class="px-4 py-2">ស្ថានភាព</th><th class="px-4 py-2">ចូល</th><th class="px-4 py-2">ចេញ</th>';
        bodyEl.innerHTML = '';

        // Index logs by student/date for faster lookup
        const byKey = new Map();
        for (const lg of logs) {
            const k = `${lg.student_id}|${lg.attendance_date}`;
            if (!byKey.has(k)) byKey.set(k, []);
            byKey.get(k).push(lg);
        }
        const addRow = (date, s, status, inT, outT) => {
            const tr = document.createElement('tr'); tr.className='border-b';
            tr.innerHTML = `<td class="px-4 py-2">${date}</td><td class="px-4 py-2">${s.last_name} ${s.first_name}</td><td class="px-4 py-2">${s.class_id}</td><td class="px-4 py-2">${status}</td><td class="px-4 py-2">${inT||''}</td><td class="px-4 py-2">${outT||''}</td>`;
            bodyEl.appendChild(tr);
        };

        // For each student and each day in range, compute status (basic)
        const dayCount = Math.ceil((end - start)/(24*3600*1000));
        for (const s of students) {
            for (let i=0;i<dayCount;i++) {
                const dt = new Date(start); dt.setDate(start.getDate()+i);
                const dateISO = dt.toISOString().slice(0,10);
                const key = `${s.student_id}|${dateISO}`;
                const entries = byKey.get(key) || [];
                if (entries.length === 0) {
                    if (statusVal === 'all' || statusVal === 'not_scanned' || statusVal === 'absent') {
                        addRow(dateISO, s, statusVal==='absent'?'អវត្តមាន':'មិនទាន់បានស្កេន');
                    }
                    continue;
                }
                // Merge to single row: use earliest in and latest out
                const inTimes = entries.map(e => e.scan_time_in).filter(Boolean).sort();
                const outTimes = entries.map(e => e.scan_time_out).filter(Boolean).sort();
                const inISO = inTimes[0] || null; const outISO = outTimes[outTimes.length-1] || null;
                // Status rules
                let status = 'វត្តមាន';
                const sch = scById.get(entries[0].schedule_id);
                if (inISO && sch) {
                    const t = new Date(inISO); const hhmm = fmtTimeHHMM(t);
                    if (hhmm > sch.start_time) status = 'មកយឺត';
                }
                if (inISO && !outISO) status = 'មិនបានស្កេនចេញ';
                // Filter
                const mapVal = {present:'វត្តមាន', late:'មកយឺត', no_checkout:'មិនបានស្កេនចេញ'}[statusVal] || null;
                if (statusVal !== 'all' && mapVal && status !== mapVal) continue;
                addRow(dateISO, s, status, inISO?.substring(11,16), outISO?.substring(11,16));
            }
        }
    }

    // Kick off initial auth + data load if page already initialized
    (async () => {
        if (await ensureAuth()) {
            await loadClassesForSelect();
            await loadStudents();
            await loadSchedules();
        }
    })();
    </script>
</body>
</html>

<script>
(function(){
  function offline(){ return !window.currentUserId; }
  if (!offline() || typeof db === 'undefined') return;
  // Dexie-based fallback for class selects
  window.loadClassesForSelect = async function(){
    try {
      const classes = await db.classes.toArray();
      window.allClasses = (classes||[]).map(c => ({ class_id: c.classId, class_name: c.className, academic_year: c.academicYear }));
      const selects = document.querySelectorAll('.class-select');
      selects.forEach(sel => {
        const prev = sel.value;
        const firstOption = sel.options[0] ? sel.options[0].outerHTML : '<option value="">-- ជ្រើសរើសថ្នាក់ --</option>';
        sel.innerHTML = firstOption;
        (window.allClasses||[]).forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.class_id;
          opt.textContent = c.class_name + (c.academic_year ? ' ('+c.academic_year+')' : '');
          sel.appendChild(opt);
        });
        if (prev) sel.value = prev;
      });
      const repSel = document.getElementById('reportFilterClass');
      if (repSel) {
        const prev = repSel.value;
        repSel.innerHTML = '<option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option><option value="">-- គ្រប់ថ្នាក់រៀន --</option>';
        (window.allClasses||[]).forEach(c => { const opt = document.createElement('option'); opt.value = c.class_id; opt.textContent = c.class_name; repSel.appendChild(opt); });
        if (prev) repSel.value = prev;
      }
      const rosterSel = document.getElementById('rosterFilterClass');
      if (rosterSel) {
        const prev = rosterSel.value;
        rosterSel.innerHTML = '<option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option>';
        (window.allClasses||[]).forEach(c => { const opt = document.createElement('option'); opt.value = c.class_id; opt.textContent = c.class_name; rosterSel.appendChild(opt); });
        if (prev) rosterSel.value = prev;
      }
    } catch (e) { return "N/A"; }
  };
  // Dexie-based fallback for students
  window.loadStudents = async function(){
    const classFilter = (document.getElementById('filterStudentClass')||{}).value || 'all';
    const search = ((document.getElementById('searchStudentInput')||{}).value || '').toLowerCase().trim();
    const sortBy = (document.getElementById('sortStudentBy')||{}).value || 'name';
    const listEl = document.getElementById('student-list'); if (!listEl) return;
    let students = await db.students.toArray();
    if (classFilter !== 'all') students = students.filter(s => s.classId === classFilter);
    if (search) students = students.filter(s => (s.studentId+' '+s.lastName+' '+s.firstName).toLowerCase().includes(search));
    students.sort((a,b) => sortBy==='class' ? (a.classId||'').localeCompare(b.classId||'') : (a.lastName+' '+a.firstName).localeCompare(b.lastName+' '+b.firstName));
    listEl.innerHTML = '';
    const classNameById = new Map(((window.allClasses)||[]).map(c => [c.class_id, c.class_name]));
    students.forEach(s => {
      const tr = document.createElement('tr'); tr.className='border-b';
      const photo = s.photoUrl ? '<img src="'+s.photoUrl+'" class="h-10 w-10 object-cover rounded"/>' : '';
      const age = (typeof window.calculateAge==='function' && s.dob) ? window.calculateAge(s.dob) : '';
      const classLabel = classNameById.get(s.classId) || s.classId || '';
      tr.innerHTML = '<td class="px-4 py-2">'+photo+'</td>'+
                     '<td class="px-4 py-2">'+s.studentId+'</td>'+
                     '<td class="px-4 py-2">'+s.lastName+' '+s.firstName+'</td>'+
                     '<td class="px-4 py-2">'+(s.gender||'')+'</td>'+
                     '<td class="px-4 py-2">'+age+'</td>'+
                     '<td class="px-4 py-2">'+classLabel+'</td>'+
                     '<td class="px-4 py-2"><button class="btn btn-blue" onclick="openEditModal(\'student\', '+s.id+')">កែសម្រួល</button></td>';
      listEl.appendChild(tr);
    });
  };
  // Dexie-based fallback for schedules
  window.loadSchedules = async function(){
    const listEl = document.getElementById('schedule-list'); if (!listEl) return;
    const search = ((document.getElementById('searchScheduleInput')||{}).value || '').toLowerCase().trim();
    let items = await db.schedule.toArray();
    if (search) items = items.filter(x => (x.classId||'').toLowerCase().includes(search));
    listEl.innerHTML='';
    const dayMap = {0:'អាទិត្យ',1:'ច័ន្ទ',2:'អង្គារ',3:'ពុធ',4:'ព្រហស្បតិ៍',5:'សុក្រ',6:'សៅរ៍'};
    items.forEach(sc => {
      const tr = document.createElement('tr'); tr.className='border-b';
      tr.innerHTML = '<td class="px-4 py-2">'+(sc.classId||'')+'</td>'+
                     '<td class="px-4 py-2">'+dayMap[sc.dayOfWeek]+'</td>'+
                     '<td class="px-4 py-2">'+sc.startTime+'</td>'+
                     '<td class="px-4 py-2">'+sc.endTime+'</td>'+
                     '<td class="px-4 py-2"><button class="btn btn-blue" onclick="openEditModal(\'schedule\', '+sc.id+')">កែសម្រួល</button></td>';
      listEl.appendChild(tr);
    });
  };
  // Bind scan input to Dexie handler (onScanSuccess) if present
  const input = document.getElementById('usb-scanner-input');
  if (input && typeof window.onScanSuccess === 'function') {
    input.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); window.onScanSuccess(input.value); input.value=''; }});
  }
})();
</script>



