<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- (UPDATED V14.23) -->
    <title>វត្តមានខ្ញុំ</title>
    <!-- 1. ភ្ជាប់ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ភ្ជាប់ Dexie.js (Database Offline) -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>

    <!-- (NEW V14.19) 3. ភ្ជាប់ SheetJS (Excel Library) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- 4. ភ្ជាប់ Khmer Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&family=Moul&display=swap" rel="stylesheet">


    <style>
        /* (NEW) អនុវត្ត Font */
        body {
            font-family: 'Kantumruy Pro', 'Khmer Os Siemreap', sans-serif;
        }
        h1, h2, h3, h4, h5, h6, .font-title {
            font-family: 'Moul', 'Khmer OS Muol Light', cursive;
        }

        .page-content { display: none; }
        #page-scan { display: block; }
        .section-divider { border-bottom: 2px dashed #cbd5e1; margin-top: 1.5rem; margin-bottom: 1.5rem; }
        
        /* (UPDATED) រចនាបថ VB.NET សម្រាប់ Form Elements (ស៊ុមពណ៌ខៀវ + លិចចូល) */
        input[type="text"],
        input[type="url"],
        input[type="date"],
        input[type="time"],
        input[type="file"],
        select {
            @apply block w-full px-4 py-3 border-2 border-blue-500 rounded-lg shadow-inner bg-white; /* (UPDATED) shadow-sm -> shadow-inner */
            @apply transition duration-150 ease-in-out;
            @apply focus:outline-none focus:ring-2 focus:ring-blue-500;
        }

        /* (UPDATED) រចនាបថ VB.NET 3D សម្រាប់ Buttons */
        .btn {
            @apply px-5 py-3 rounded-lg font-semibold text-white shadow-md;
            @apply transition-all duration-150 ease-in-out; /* (UPDATED) duration-300 -> 150 */
            @apply focus:outline-none focus:ring-2 focus:ring-opacity-75;
            @apply active:shadow-none active:translate-y-1; /* (NEW) 3D Press Effect */
        }
        .btn-blue {
            @apply bg-blue-600 border-b-4 border-blue-800 focus:ring-blue-500;
            @apply active:border-b-0;
        }
        .btn-green {
            @apply bg-green-600 border-b-4 border-green-800 focus:ring-green-500;
            @apply active:border-b-0;
        }
        .btn-red {
            @apply bg-red-600 border-b-4 border-red-800 focus:ring-red-500;
            @apply active:border-b-0;
        }
        .btn-yellow {
            @apply bg-yellow-600 border-b-4 border-yellow-800 focus:ring-yellow-500;
            @apply active:border-b-0;
        }
        .btn-purple {
            @apply bg-purple-600 border-b-4 border-purple-800 focus:ring-purple-500;
            @apply active:border-b-0;
        }
        .btn-gray {
            @apply bg-gray-500 border-b-4 border-gray-700 focus:ring-gray-400;
            @apply active:border-b-0;
        }

        /* (NEW) Animation សម្រាប់ពេលទិន្នន័យបង្ហាញ */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }

        /* (UPDATED) សម្រាប់ប៊ូតុង Nav ខាងលើ (VB.NET Style + Active Light Blue) */
        .nav-link {
            @apply px-4 py-2 rounded-lg font-semibold border-b-4 shadow-md; /* (NEW) VB.NET style */
            @apply bg-gray-200 text-gray-700 border-gray-400; /* (NEW) Default VB.NET colors */
            @apply transition-all duration-150 ease-in-out;
            @apply active:shadow-none active:translate-y-1 active:border-b-0;
        }
        .nav-link:hover {
            @apply bg-gray-300; /* (NEW) Hover */
        }
        .nav-link.nav-btn-active { /* Active state (UPDATED) */
            @apply bg-blue-300 text-blue-900 border-blue-500; /* (UPDATED) Light Blue */
            @apply transform scale-110 shadow-lg; /* (UPDATED) ទ្រុធ (Bulky) */
            @apply active:scale-110 active:translate-y-0 active:shadow-lg; /* (NEW) Prevent press effect when active */
        }
        .nav-link.nav-btn-active:hover {
            @apply bg-blue-300; /* (NEW) Keep color on hover */
        }


        /* សម្រាប់ទម្រង់បោះពុម្ព */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; }
            
            /* (UPDATED V14.2) Portrait + Narrow margin */
            @page { 
                size: A4 portrait; 
                margin: 12.7mm; /* Narrow */
            }

            /* (NEW V14.22) សម្រាប់ក្បាលទំព័របោះពុម្ព */
            .print-header {
                display: table;
                width: 100%;
                margin-bottom: 10px;
            }
            .header-left {
                display: table-cell;
                text-align: left;
                vertical-align: top;
                width: 25%; /* (UPDATED) */
            }
            .header-center {
                display: table-cell;
                text-align: center;
                vertical-align: top;
            }
            .header-right {
                display: table-cell;
                text-align: right;
                vertical-align: top;
                width: 25%; /* (UPDATED) */
                font-size: 12px;
                line-height: 1.5;
            }
            /* (NEW V14.22) សម្រាប់បោះពុម្ពតារាងវេនសំអាត */
            table.print-roster {
                width: 100%; 
                border-collapse: collapse; 
                margin-top: 20px; 
                table-layout: fixed; /* Equal columns */
            }
            table.print-roster th {
                font-family: 'Moul', 'Khmer OS Muol Light', cursive;
                font-size: 16px;
                padding: 10px;
                border: 1px solid black;
                background-color: #f2f2f2;
                text-align: center;
            }
            table.print-roster td { 
                border: 1px solid black; 
                padding: 10px; 
                vertical-align: top;
                font-size: 14px;
                line-height: 1.6;
            }
            table.print-roster td ol {
                margin: 0;
                padding-left: 20px;
            }

        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex flex-wrap justify-between items-center">
            <!-- (UPDATED V14.23) -->
            <div class="text-2xl font-bold text-blue-600 font-title">ប្រព័ន្ធអវត្តមាន (Offline V14.23)</div>
            <!-- (UPDATED) Nav Buttons -->
            <div class="flex flex-wrap gap-3 mt-4 md:mt-0">
                <button id="nav-scan" onclick="showPage('page-scan')" class="nav-link nav-btn-active">ស្កេន QR</button>
                <button id="nav-student" onclick="showPage('page-manage-student')" class="nav-link">គ្រប់គ្រងសិស្ស</button>
                <button id="nav-schedule" onclick="showPage('page-manage-schedule')" class="nav-link">គ្រប់គ្រងកាលវិភាគ</button>
                <button id="nav-class" onclick="showPage('page-manage-class')" class="nav-link">គ្រប់គ្រងថ្នាក់រៀន</button>
                <button id="nav-report" onclick="showPage('page-report')" class="nav-link">របាយការណ៍</button>
                <!-- (NEW V14.20) Cleaning Roster Button -->
                <button id="nav-cleaning" onclick="showPage('page-cleaning-roster')" class="nav-link">វេនសំអាត</button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-6">

        <!-- (UPDATED) Page: Scan QR (Default) -->
        <div id="page-scan" class="page-content">
            <h1 class="text-3xl mb-6 text-gray-800 font-title">ទំព័រស្កេន QR កាតសិស្ស ចេញ-ចូល </h1>
            
            <!-- (UPDATED) Layout 5 ស្ទឹង (1 ខាងឆ្វេង, 3 កណ្តាល, 1 ខាងស្តាំ) -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                
                <!-- ស្ទឹងខាងឆ្វេង: កន្លែងស្កេន (តូច) -->
                <div class="bg-white p-6 rounded-lg shadow-lg md:col-span-1">
                    <!-- USB Scan UI (Default) -->
                    <div id="usb-scan-ui">
                        <label for="usb-scanner-input" class="block text-xl font-medium text-gray-700 mb-4">ស្កេនកូដសិស្ស៖</label>
                        <!-- (UPDATED) មិនបាច់កំណត់ border នៅទីនេះទេ ព្រោះ global style គ្រប់គ្រងហើយ -->
                        <input type="text" id="usb-scanner-input" class="p-4 rounded-lg w-full text-3xl text-center focus:ring-2 focus:ring-blue-500" placeholder="...ស្កេន...">
                        <p class="text-center text-gray-500 mt-3">ចុច Enter ដើម្បីពិនិត្យ</p>
                    </div>

                    <!-- Scan Result (សម្រាប់ Error ឬ Loading) -->
                    <div id="scan-result" class="mt-6 text-center">
                        <div class="p-4 bg-blue-100 text-blue-700 rounded-lg">
                            <p class="text-lg">ត្រៀមខ្លួន...</p>
                        </div>
                    </div>
                </div>

                <!-- ស្ទឹងកណ្តាល: បង្ហាញទិន្នន័យសិស្ស (ធំ) -->
                <div id="student-info-display" class="relative md:col-span-2 md:col-start-2">
                    <!-- (UPDATED) បន្ថែម wrapper ដើម្បីកំណត់ទំហំ និងដាក់កណ្តាល -->
                    <div class="max-w-sm mx-auto">
                        <div class="bg-white p-6 rounded-lg shadow-lg h-full flex items-center justify-center">
                            <div class="text-center text-gray-400">
                                <svg class="mx-auto h-24 w-24" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A1.5 1.5 0 0 1 18 21.75H6a1.5 1.5 0 0 1-1.499-1.632Z" />
                                </svg>
                                <p class="mt-4 text-xl">ព័ត៌មានសិស្សនឹងបង្ហាញនៅទីនេះ</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- (NEW) ស្ទឹងខាងស្តាំ: សម្រាប់ពាក្យ ចូល/ចេញ -->
                <div id="scan-status-display" class="md:col-span-1 md:col-start-4 flex items-center justify-center">
                    <!-- ស្ថានភាព ចូល/ចេញ នឹងបង្ហាញនៅទីនេះ -->
                </div>

            </div>
        </div>

        <!-- Page: Manage Students -->
        <div id="page-manage-student" class="page-content">
            <h1 class="text-3xl font-bold mb-6 text-gray-800 font-title">គ្រប់គ្រងសិស្ស</h1>
            <!-- ... Form បញ្ចូលសិស្ស ... -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6" style="display: none;">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ចូលសិស្សថ្មី</h2>
                <form id="addStudentForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="studentId" placeholder="កូដសិស្ស (សម្រាប់ QR)" class="md:col-span-1" required>
                    <input type="text" id="lastName" placeholder="គោតនាម" required>
                    <input type="text" id="firstName" placeholder="នាម" required>
                    <select id="gender" required>
                        <option value="">-- ជ្រើសរើសភេទ --</option>
                        <option value="ប្រុស">ប្រុស</option>
                        <option value="ស្រី">ស្រី</option>
                    </select>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ថ្ងៃខែឆ្នាំកំណើត</label>
                        <input type="date" id="dob" required>
                    </div>
                    <select id="studentClassId" class="class-select" required>
                        <option value="">-- ជ្រើសរើសថ្នាក់ --</option>
                    </select>
                    <input type="url" id="photoUrl" placeholder="URL រូបថត (បើមាន)" class="md:col-span-2">
                    <button type="submit" class="btn btn-green md:col-span-4">បន្ថែមសិស្ស</button>
                </form>
            </div>
            <!-- (UPDATED V14.23) តារាងសិស្ស -->
            <div class="bg-white p-6 rounded-lg shadow-lg overflow-x-auto">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ជីសិស្ស</h2>
                
                <!-- (NEW V14.23) Filter, Sort, and Search Bar -->
                <div class="mb-4 space-y-4">
                    <!-- Row 1: Filters & Sort -->
                    <div class="flex flex-wrap gap-4">
                        <!-- Filter by Class -->
                        <div class="flex-grow">
                            <label for="filterStudentClass" class="block text-sm font-medium text-gray-700 mb-1">ត្រងតាមថ្នាក់៖</label>
                            <select id="filterStudentClass" class="class-select" onchange="loadStudents()">
                                <option value="all">-- គ្រប់ថ្នាក់រៀន --</option>
                                <!-- Options will be loaded by loadClassesForSelect() -->
                            </select>
                        </div>
                        <!-- Sort by -->
                        <div class="flex-grow">
                            <label for="sortStudentBy" class="block text-sm font-medium text-gray-700 mb-1">តម្រៀបតាម៖</label>
                            <select id="sortStudentBy" onchange="loadStudents()">
                                <option value="name">ឈ្មោះសិស្ស (A-Z)</option>
                                <option value="class">ថ្នាក់ (A-Z)</option>
                            </select>
                        </div>
                    </div>
                    <!-- Row 2: Search & Delete -->
                    <div class="flex flex-wrap gap-4">
                        <input type="text" id="searchStudentInput" oninput="loadStudents()" placeholder="ស្វែងរកតាម កូដ, គោតនាម, ឬ នាម..." class="w-full md:w-1/2 flex-grow">
                        <button onclick="confirmDelete('students_all', 0, 'សិស្សទាំងអស់')" class="btn btn-red">លុបសិស្សទាំងអស់</button>
                    </div>
                </div>

                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-200 text-left">
                            <th class="px-4 py-2">រូបថត</th>
                            <th class="px-4 py-2">កូដសិស្ស</th>
                            <!-- (UPDATED) ប្តូរ គោតនាម/នាម ទៅជា ឈ្មោះសិស្ស -->
                            <th class="px-4 py-2">ឈ្មោះសិស្ស</th>
                            <!-- <th class="px-4 py-2">គោតនាម</th>
                            <th class="px-4 py-2">នាម</th> -->
                            <th class="px-4 py-2">ភេទ</th>
                            <th class="px-4 py-2">អាយុ</th>
                            <th class="px-4 py-2">ថ្នាក់</th>
                            <th class="px-4 py-2">សកម្មភាព</th>
                        </tr>
                    </thead>
                    <tbody id="student-list"></tbody>
                </table>
            </div>
        </div>

        <!-- (UPDATED) Page: Manage Schedule -->
        <div id="page-manage-schedule" class="page-content">
            <h1 class="text-3xl font-bold mb-6 text-gray-800 font-title">គ្រប់គ្រងកាលវិភាគ</h1>
            <!-- ... Form បញ្ចូលកាលវិភាគ ... -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ចូលកាលវិភាគថ្មី</h2>
                <form id="addScheduleForm" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <select id="scheduleClassId" class="class-select" required>
                        <option value="">-- ជ្រើសរើសថ្នាក់ --</option>
                    </select>
                    <select id="dayOfWeek" required>
                        <option value="1">ច័ន្ទ</option>
                        <option value="2">អង្គារ</option>
                        <option value="3">ពុធ</option>
                        <option value="4">ព្រហស្បតិ៍</option>
                        <option value="5">សុក្រ</option>
                        <option value="6">សៅរ៍</option>
                        <option value="0">អាទិត្យ</option>
                    </select>
                    <input type="time" id="startTime" required title="ម៉ោងចូលរៀន">
                    <input type="time" id="endTime" required title="ម៉ោងចេញ">
                    <button type="submit" class="btn btn-green">បន្ថែមកាលវិភាគ</button>
                </form>
            </div>
            <!-- (UPDATED) តារាងកាលវិភាគ -->
            <div class="bg-white p-6 rounded-lg shadow-lg overflow-x-auto">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ជីកាលវិភាគ</h2>
                <!-- (UPDATED V14.15) Search Bar + Delete All Button -->
                <div class="mb-4 flex flex-wrap gap-4">
                    <input type="text" id="searchScheduleInput" oninput="loadSchedules()" placeholder="ស្វែងរកតាមថ្នាក់..." class="w-full md:w-1/2 flex-grow">
                    <button onclick="confirmDelete('schedule_all', 0, 'កាលវិភាគទាំងអស់')" class="btn btn-red">លុបកាលវិភាគទាំងអស់</button>
                </div>
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-200 text-left">
                            <th class="px-4 py-2">ថ្នាក់</th>
                            <th class="px-4 py-2">ថ្ងៃ</th>
                            <th class="px-4 py-2">ម៉ោងចូល</th>
                            <th class="px-4 py-2">ម៉ោងចេញ</th>
                            <th class="px-4 py-2">សកម្មភាព</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-list"></tbody>
                </table>
            </div>
        </div>

        <!-- (UPDATED) Page: Manage Classes -->
        <div id="page-manage-class" class="page-content">
            <h1 class="text-3xl font-bold mb-6 text-gray-800 font-title">គ្រប់គ្រងថ្នាក់រៀន</h1>
            <!-- ... Form បញ្ចូលថ្នាក់ ... -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ចូលថ្នាក់ថ្មី</h2>
                <form id="addClassForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="classId" placeholder="លេខកូដថ្នាក់ (VD: 12A)" required>
                    <input type="text" id="className" placeholder="ឈ្មោះថ្នាក់ (VD: ថ្នាក់ទី១២ A)" required>
                    <!-- (UPDATED V14.16) Placeholder នឹងត្រូវបានកំណត់ដោយ JS -->
                    <input type="text" id="academicYear" placeholder="ឆ្នាំសិក្សា..." required>
                    <button type="submit" class="btn btn-green">បន្ថែមថ្នាក់</button>
                </form>
            </div>
            <!-- (UPDATED V14.9) ប៊ូតុង Sync -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                <h2 class="text-xl font-semibold mb-4 font-title">ទាញយកទិន្នន័យ</h2>
                <button onclick="syncClassesFromStudents()" class="btn btn-purple">ទាញយកថ្នាក់ពីបញ្ជីសិស្ស</button>
                <p class="mt-2 text-sm text-gray-600">
                    ប្រើមុខងារនេះ ប្រសិនបើអ្នកបាននាំចូល (Import) បញ្ជីសិស្ស ហើយចង់បង្កើតថ្នាក់រៀនដោយស្វ័យប្រវត្តិ។<br>
                    វានឹងស្កេនបញ្ជីសិស្ស ហើយបន្ថែមថ្នាក់ដែលមិនទាន់មាន ចូលទៅក្នុងតារាង "បញ្ជីថ្នាក់រៀន"។<br>
                    <!-- (UPDATED V14.16) -->
                    (ឈ្មោះថ្នាក់ នឹងដូចលេខកូដថ្នាក់, ឆ្នាំសិក្សា នឹងយកពីទំព័រកំណត់)
                </p>
            </div>
            <!-- (UPDATED) តារាងថ្នាក់ -->
            <div class="bg-white p-6 rounded-lg shadow-lg overflow-x-auto">
                <h2 class="text-xl font-semibold mb-4 font-title">បញ្ជីថ្នាក់រៀន</h2>
                <!-- (UPDATED V14.15) Search Bar + Delete All Button -->
                <div class="mb-4 flex flex-wrap gap-4">
                    <input type="text" id="searchClassInput" oninput="loadClassesForTable()" placeholder="ស្វែងរកតាមលេខកូដ ឬ ឈ្មោះថ្នាក់..." class="w-full md:w-1/2 flex-grow">
                    <button onclick="confirmDelete('classes_all', 0, 'ថ្នាក់រៀនទាំងអស់')" class="btn btn-red">លុបថ្នាក់ទាំងអស់</button>
                </div>
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-200 text-left">
                            <th class="px-4 py-2">លេខកូដ</th>
                            <th class="px-4 py-2">ឈ្មោះថ្នាក់</th>
                            <th class="px-4 py-2">ឆ្នាំសិក្សា</th>
                            <th class="px-4 py-2">សកម្មភាព</th>
                        </tr>
                    </thead>
                    <tbody id="class-list"></tbody>
                </table>
            </div>
        </div>

        <!-- (UPDATED) Page: Report -->
        <div id="page-report" class="page-content">
            <h1 class="text-3xl font-bold mb-6 text-gray-800 font-title">របាយការណ៍អវត្តមាន</h1>
            <!-- (UPDATED V14.11) ផ្ទាំង Filter (Auto-load) -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6 flex flex-wrap gap-4 items-center">
                <div class="flex space-x-4" id="reportTypeSelector">
                    <label class="flex items-center"><input type="radio" name="reportType" value="daily" checked class="mr-2" onchange="loadReportData()">ប្រចាំថ្ងៃ</label>
                    <label class="flex items-center"><input type="radio" name="reportType" value="weekly" class="mr-2" onchange="loadReportData()">ប្រចាំសប្តាហ៍</label>
                    <label class="flex items-center"><input type="radio" name="reportType" value="monthly" class="mr-2" onchange="loadReportData()">ប្រចាំខែ</label>
                </div>
                <!-- (UPDATED V14.11) Auto-load + "សូមជ្រើសរើស" -->
                <select id="reportFilterClass" class="class-select" onchange="loadReportData()">
                    <option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option>
                    <option value="">-- គ្រប់ថ្នាក់រៀន --</option>
                </select>
                <input type="date" id="reportFilterDate" onchange="loadReportData()">
                <!-- (NEW V14.6) Filter by Status -->
                <select id="reportFilterStatus" onchange="loadReportData()">
                    <option value="all">-- គ្រប់ស្ថានភាព --</option>
                    <option value="present">វត្តមាន</option>
                    <option value="late">មកយឺត</option>
                    <option value="absent">អវត្តមាន</option>
                    <option value="no_checkout">មិនបានស្កេនចេញ</option>
                    <option value="not_scanned">មិនទាន់បានស្កេន</option>
                    <option value="no_class">មិនមានថ្នាក់រៀន</option> <!-- (NEW V14.11) -->
                </select>
                <!-- (REMOVED V14.11) ប៊ូតុង "បង្ហាញ" -->
                <!-- (UPDATED V14.19) CSV -> XLSX -->
                <button onclick="exportReportToExcel()" class="btn btn-yellow">នាំចេញ .XLSX</button>
                <button onclick="printReport()" class="btn btn-gray">បោះពុម្ព</button>
            </div>
            <!-- (UPDATED V14.15) Search Bar for Report + Delete All Button -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6 flex flex-wrap gap-4">
                <input type="text" id="searchReportInput" oninput="loadReportData()" placeholder="ស្វែងរកសិស្សក្នុងរបាយការណ៍នេះ..." class="w-full md:w-1/2 flex-grow">
                <button onclick="confirmDelete('attendanceLog_all', 0, 'កំណត់ត្រាអវត្តមានទាំងអស់')" class="btn btn-red">លុបកំណត់ត្រាទាំងអស់</button>
            </div>
            <div id="report-date-range" class="mb-4 text-lg font-semibold text-gray-700"></div>
            <!-- (UPDATED V14.12) តារាងរបាយការណ៍ (ប្តូរ Head/Body) -->
            <div class="bg-white p-6 rounded-lg shadow-lg overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-200 text-left" id="report-table-header">
                            <!-- Header នឹងត្រូវបានបង្កើតដោយ Javascript (V14.12) -->
                        </tr>
                    </thead>
                    <tbody id="report-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- (NEW V14.20) Page: Cleaning Roster -->
        <div id="page-cleaning-roster" class="page-content">
            <h1 class="text-3xl font-bold mb-6 text-gray-800 font-title">វេនសំអាតប្រចាំថ្នាក់</h1>
            
            <!-- Filter Bar -->
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6 flex flex-wrap gap-4 items-center">
                <select id="rosterFilterClass" class="class-select" onchange="clearRoster()">
                    <option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option>
                    <!-- ថ្នាក់នឹងត្រូវបានផ្ទុកដោយ JS -->
                </select>
                <button onclick="generateCleaningRoster()" class="btn btn-blue">បង្កើតតារាងវេន</button>
                <button onclick="printCleaningRoster()" class="btn btn-gray">បោះពុម្ពតារាងវេន</button>
            </div>
            
            <!-- Roster Display Area -->
            <div id="roster-display-area" class="bg-white p-6 rounded-lg shadow-lg">
                <p class="text-center text-gray-500">សូមជ្រើសរើសថ្នាក់ ហើយចុច "បង្កើតតារាងវេន"។</p>
                <!-- Roster content will be injected here -->
            </div>
        </div>

    </main>

    <!-- (MODIFIED) Edit Modals (ពី V7) -->
    <!-- Edit Class Modal -->
    <div id="editClassModal" style="display: none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-20">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 font-title">កែសម្រួលថ្នាក់រៀន</h2>
            <form id="editClassForm">
                <input type="hidden" id="editClassDbId">
                <div class="mb-4">
                    <label class="block text-gray-700">លេខកូដថ្នាក់ (មិនអាចកែបាន)</label>
                    <input type="text" id="editClassId" class="bg-gray-100" readonly>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700">ឈ្មោះថ្នាក់</label>
                    <input type="text" id="editClassName" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700">ឆ្នាំសិក្សា</label>
                    <input type="text" id="editAcademicYear" required>
                </div>
                <!-- (NEW V14.22) Edit teacher name/sig in modal -->
                <div class="mb-4">
                    <label class="block text-gray-700">ឈ្មោះគ្រូបន្ទុកថ្នាក់</label>
                    <input type="text" id="editClassTeacherName">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700">URL ហត្ថលេខាគ្រូ</label>
                    <input type="url" id="editClassSignatureUrl">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeEditModal('class')" class="btn btn-gray">បោះបង់</button>
                    <button type="submit" class="btn btn-blue">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Edit Student Modal -->
    <div id="editStudentModal" style="display: none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-20">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4 font-title">កែសម្រួលព័ត៌មានសិស្ស</h2>
            <form id="editStudentForm">
                <input type="hidden" id="editStudentDbId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700">កូដសិស្ស (មិនអាចកែបាន)</label>
                        <input type="text" id="editStudentId" class="bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-gray-700">ថ្នាក់រៀន</label>
                        <select id="editStudentClassId" class="class-select" required></select>
                    </div>
                    <div>
                        <label class="block text-gray-700">គោតនាម</label>
                        <input type="text" id="editLastName" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">នាម</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">ភេទ</label>
                        <select id="editGender" required>
                            <option value="ប្រុស">ប្រុស</option>
                            <option value="ស្រី">ស្រី</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700">ថ្ងៃខែឆ្នាំកំណើត</label>
                        <input type="date" id="editDob" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700">URL រូបថត (បើមាន)</label>
                        <input type="url" id="editPhotoUrl">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="closeEditModal('student')" class="btn btn-gray">បោះបង់</button>
                    <button type="submit" class="btn btn-blue">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Edit Schedule Modal -->
    <div id="editScheduleModal" style="display: none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-20">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4 font-title">កែសម្រួលកាលវិភាគ</h2>
            <form id="editScheduleForm">
                <input type="hidden" id="editScheduleDbId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700">ថ្នាក់រៀន</label>
                        <select id="editScheduleClassId" class="class-select" required></select>
                    </div>
                    <div>
                        <label class="block text-gray-700">ថ្ងៃ</label>
                        <select id="editDayOfWeek" required>
                            <option value="1">ច័ន្ទ</option>
                            <option value="2">អង្គារ</option>
                            <option value="3">ពុធ</option>
                            <option value="4">ព្រហស្បតិ៍</option>
                            <option value="5">សុក្រ</option>
                            <option value="6">សៅរ៍</option>
                            <option value="0">អាទិត្យ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700">ម៉ោងចូល</label>
                        <input type="time" id="editStartTime" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">ម៉ោងចេញ</label>
                        <input type="time" id="editEndTime" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="closeEditModal('schedule')" class="btn btn-gray">បោះបង់</button>
                    <button type="submit" class="btn btn-blue">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>

    <!-- (NEW) Delete Confirmation Modal -->
    <div id="confirmDeleteModal" style="display: none;" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-30">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-red-600 font-title">បញ្ជាក់ការលុប</h2>
            <p id="confirm-message" class="mb-4 text-gray-700">តើអ្នកពិតជាចង់លុបទិន្នន័យនេះមែនទេ?</p>
            <p id="confirm-warning" class="mb-6 text-sm text-red-700"></p>
            <div class="flex justify-end space-x-4">
                <button type="button" onclick="closeDeleteModal()" class="btn btn-gray">បោះបង់</button>
                <button type="button" onclick="executeDelete()" class="btn btn-red">យល់ព្រម លុប</button>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" style="display: none;" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white z-50"></div>

    <script>
        // --- 1. ការរៀបចំ Database (Offline) ជាមួយ Dexie.js ---
        const db = new Dexie("AttendanceDB");
        // (UPDATED V14.22) Bump version to 3 for new class fields
        db.version(3).stores({
            classes: "++id, &classId, academicYear, teacherName, signatureUrl", // (UPDATED)
            students: "++id, &studentId, classId, lastName, firstName, dob, gender, photoUrl",
            schedule: "++id, classId, dayOfWeek",
            attendanceLog: "++id, [studentId+scheduleId+attendanceDate], attendanceDate, classId, studentName"
        }).upgrade(tx => {
            // This upgrade function will only run when upgrading from a version < 3
            // It ensures new fields 'teacherName' and 'signatureUrl' are added to 'classes'
            return tx.table('classes').toCollection().modify(cls => {
                if (cls.teacherName === undefined) {
                    cls.teacherName = ""; // Add new field with default value
                }
                if (cls.signatureUrl === undefined) {
                    cls.signatureUrl = ""; // Add new field with default value
                }
            });
        });

        // --- Cache សម្រាប់ទិន្នន័យ ---
        let allClasses = [];
        let allSchedules = [];
        let currentReportData = []; // សម្រាប់ផ្ទុកទិន្នន័យរបាយការណ៍ដែលបានត្រង (V14.12)
        const khmerMonths = ["មករា", "កុម្ភៈ", "មីនា", "មេសា", "ឧសភា", "មិថុនា", "កក្កដា", "សីហា", "កញ្ញា", "តុលា", "វិច្ឆិកា", "ធ្នូ"];
        const PLACEHOLDER_IMG = "https://placehold.co/400x400/eee/ccc?text=%E1%9E%9A%E1%9E%BC%E1%9E%94%E1%9E%90%E1%9E%B6";

        // --- 2. ការគ្រប់គ្រងទំព័រ (Page Navigation) ---
        // (REMOVED) currentScanner, availableCameras

        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
            
            // (UPDATED) Handle Nav Button Active State
            document.querySelectorAll('.nav-link').forEach(btn => {
                btn.classList.remove('nav-btn-active');
            });
            const navIdMap = {
                'page-scan': 'nav-scan',
                'page-manage-student': 'nav-student',
                'page-manage-schedule': 'nav-schedule',
                'page-manage-class': 'nav-class',
                'page-report': 'nav-report',
                'page-cleaning-roster': 'nav-cleaning' // (NEW V14.20)
            };
            if (navIdMap[pageId]) {
                document.getElementById(navIdMap[pageId]).classList.add('nav-btn-active');
            }
            
            // (UPDATED V14.20)
            if (pageId.startsWith('page-manage-') || pageId === 'page-report' || pageId === 'page-cleaning-roster' || pageId === 'page-manage-student') {
                if (window.loadClassesForSelect) window.loadClassesForSelect();
            }
            if (pageId === 'page-manage-student' && window.loadStudents) window.loadStudents();
            if (pageId === 'page-manage-schedule' && window.loadSchedules) window.loadSchedules();
            if (pageId === 'page-manage-class' && window.loadClassesForTable) window.loadClassesForTable();
            // (REMOVED V14.11) មិនចាំបាច់ load report នៅពេលប្តូរទំព័រទេ
            // if (pageId === 'page-report') loadReportData(); 
            
            // (NEW) Auto-focus scan input
            if (pageId === 'page-scan') {
                // Use setTimeout to ensure element is visible before focusing
                setTimeout(() => {
                    document.getElementById('usb-scanner-input').focus();
                }, 100);
            }
        }

        // --- 3. មុខងារគ្រប់គ្រងថ្នាក់ (Manage Classes) ---
        async function loadClassesForSelect() {
            try {
                allClasses = await db.classes.toArray();
                const classSelects = document.querySelectorAll('.class-select');
                classSelects.forEach(sel => {
                    const firstOption = sel.options[0] ? sel.options[0].outerHTML : '<option value="">-- ជ្រើសរើសថ្នាក់ --</option>';
                    // (UPDATED V14.11) រក្សាជម្រើសទីមួយ (ប្រសិនបើមាន)
                    sel.innerHTML = firstOption; 
                    
                    // (NEW V14.11) បន្ថែម "គ្រប់ថ្នាក់រៀន" សម្រាប់តែទំព័រ Report
                    if (sel.id === 'reportFilterClass') {
                        sel.innerHTML += '<option value="">-- គ្រប់ថ្នាក់រៀន --</option>';
                    }

                    allClasses.sort((a,b) => a.classId.localeCompare(b.classId, 'km')).forEach(cls => {
                        sel.innerHTML += `<option value="${cls.classId}">${cls.className} (${cls.academicYear})</option>`;
                    });
                });
            } catch (error) { console.error("Error loading classes for select: ", error); }
        }
        async function loadClassesForTable() {
            try {
                const classList = document.getElementById('class-list');
                classList.innerHTML = '<tr><td colspan="4" class="text-center p-4">កំពុងទាញយក...</td></tr>';
                allClasses = await db.classes.toArray();
                
                // (NEW V14.14) Filter logic
                const searchTerm = document.getElementById('searchClassInput').value.toLowerCase();
                const filteredClasses = allClasses.filter(cls => 
                    cls.classId.toLowerCase().includes(searchTerm) ||
                    cls.className.toLowerCase().includes(searchTerm)
                );

                if (filteredClasses.length === 0) {
                    classList.innerHTML = '<tr><td colspan="4" class="text-center p-4">មិនមានទិន្នន័យទេ។</td></tr>';
                    return;
                }

                let rows = '';
                filteredClasses.sort((a,b) => a.classId.localeCompare(b.classId, 'km')).forEach(cls => {
                    const name = cls.className.replace(/'/g, "\\'"); // Escape quotes for JS
                    rows += `<tr>
                        <td class="border px-4 py-2">${cls.classId}</td>
                        <td class="border px-4 py-2">${cls.className}</td>
                        <td class="border px-4 py-2">${cls.academicYear}</td>
                        <td class="border px-4 py-2 whitespace-nowrap">
                            <button onclick="openEditModal('class', ${cls.id})" class="text-blue-600 hover:underline mr-2">កែ</button>
                            <button onclick="confirmDelete('classes', ${cls.id}, '${name}')" class="text-red-600 hover:underline">លុប</button>
                        </td>
                    </tr>`;
                });
                classList.innerHTML = rows;
            } catch (error) { 
                console.error("Error loading classes for table: ", error); 
                classList.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">Error!</td></tr>';
            }
        }
        document.getElementById('addClassForm').onsubmit = async (event) => {
            event.preventDefault();
            const classId = document.getElementById('classId').value;
            const className = document.getElementById('className').value;
            const academicYear = document.getElementById('academicYear').value;
            try {
                // (NEW V14.22) Add default empty fields for teacher/sig
                await db.classes.add({ 
                    classId, 
                    className, 
                    academicYear,
                    teacherName: "",
                    signatureUrl: ""
                });
                event.target.reset();
                showToast("បានបន្ថែមថ្នាក់រៀនថ្មី។");
                loadClassesForTable();
                loadClassesForSelect();
            } catch (error) {
                console.error("Error adding class: ", error);
                showToast("Error: លេខកូដថ្នាក់អាចជាន់គ្នា។", true);
            }
        };

        // (NEW V14.9) Sync classes from students table
        async function syncClassesFromStudents() {
            try {
                showToast("កំពុងស្កេនបញ្ជីសិស្ស...");
                const allStudents = await db.students.toArray();
                if (allStudents.length === 0) {
                    return showToast("មិនមានទិន្នន័យសិស្សសម្រាប់ទាញយកទេ។", true);
                }
                
                const uniqueClassIds = [...new Set(allStudents.map(s => s.classId))];
                if (allClasses.length === 0) {
                    await loadClassesForTable(); // ផ្ទុក allClasses
                }
                
                const existingClassIds = new Set(allClasses.map(c => c.classId));
                const newClasses = [];
                
                // (NEW V14.16) យកឆ្នាំសិក្សាលំនាំដើម
                const defaultYear = localStorage.getItem('settingAcademicYear') || 'N/A';
                
                for (const classId of uniqueClassIds) {
                    if (classId && !existingClassIds.has(classId)) {
                        newClasses.push({
                            classId: classId,
                            className: classId, // (UPDATED V14.16)
                            academicYear: defaultYear, // (UPDATED V14.16)
                            teacherName: "", // (NEW V14.22)
                            signatureUrl: "" // (NEW V14.22)
                        });
                    }
                }
                
                if (newClasses.length > 0) {
                    await db.classes.bulkAdd(newClasses);
                    showToast(`បានបន្ថែមថ្នាក់ថ្មី ${newClasses.length}។`);
                    await loadClassesForTable();
                    await loadClassesForSelect();
                } else {
                    showToast("ថ្នាក់រៀនទាំងអស់ មានទិន្នន័យរួចហើយ។");
                }
            } catch (error) {
                console.error("Error syncing classes: ", error);
                showToast(`មានបញ្ហា៖ ${error.message}`, true);
            }
        }


        // --- 4. មុខងារគ្រប់គ្រងសិស្ស (Manage Students) ---
        function calculateAge(dobString) {
            if (!dobString) return "N/A";
            try {
                const dob = new Date(dobString);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) { age--; }
                return age;
            } catch (e) { return "N/A"; }
        }
        
        // (UPDATED V14.23) Optimized loading with Sort and Filter
        async function loadStudents() {
            const studentList = document.getElementById('student-list');
            studentList.innerHTML = '<tr><td colspan="7" class="text-center p-4">កំពុងទាញយកទិន្នន័យ...</td></tr>';
            try {
                // (NEW V14.23) Get filter and sort values
                const searchTerm = document.getElementById('searchStudentInput').value.toLowerCase();
                const filterClassId = document.getElementById('filterStudentClass').value;
                const sortBy = document.getElementById('sortStudentBy').value;

                const allStudents = await db.students.toArray();

                // (UPDATED V14.14) Filter logic
                let filteredStudents = allStudents.filter(student => 
                    student.studentId.toLowerCase().includes(searchTerm) ||
                    student.lastName.toLowerCase().includes(searchTerm) ||
                    student.firstName.toLowerCase().includes(searchTerm)
                );
                
                // (NEW V14.23) Apply class filter
                if (filterClassId !== 'all') {
                    filteredStudents = filteredStudents.filter(student => student.classId === filterClassId);
                }
                
                if (filteredStudents.length === 0) {
                    studentList.innerHTML = '<tr><td colspan="7" class="text-center p-4">មិនមានទិន្នន័យទេ។</td></tr>';
                    return;
                }

                if (allClasses.length === 0) { await loadClassesForSelect(); }
                const classMap = new Map(allClasses.map(c => [c.classId, c.className]));
                
                let studentRows = []; // (UPDATED V14.10) Build array first

                // (NEW V14.23) Apply sorting
                filteredStudents.sort((a, b) => {
                    const nameA = `${a.lastName} ${a.firstName}`;
                    const nameB = `${b.lastName} ${b.firstName}`;
                    
                    if (sortBy === 'class') {
                        const classNameA = classMap.get(a.classId) || a.classId;
                        const classNameB = classMap.get(b.classId) || b.classId;
                        
                        const classCompare = classNameA.localeCompare(classNameB, 'km');
                        if (classCompare !== 0) {
                            return classCompare;
                        }
                        // If classes are same, sort by name
                        return nameA.localeCompare(nameB, 'km');
                    } else {
                        // Default sort by name
                        return nameA.localeCompare(nameB, 'km'); // 'km' for Khmer-specific sorting
                    }
                });

                filteredStudents.forEach(student => {
                    const className = classMap.get(student.classId) || student.classId;
                    const age = calculateAge(student.dob);
                    const photo = student.photoUrl || PLACEHOLDER_IMG;
                    
                    // (UPDATED) បន្ថែម "ក. " សម្រាប់សិស្សស្រី និងពង្រីកអក្សរ
                    const studentNamePrefix = (student.gender === 'ស្រី') ? 'ក. ' : '';
                    const fullName = `${student.lastName} ${student.firstName}`;
                    const name = fullName.replace(/'/g, "\\'"); // Use full name for delete confirm
                    
                    studentRows.push(`<tr>
                        <td class="border px-4 py-2"><img src="${photo}" alt="រូបថត" class="w-12 h-12 object-cover rounded" onerror="this.src='${PLACEHOLDER_IMG}'"></td>
                        <td class="border px-4 py-2">${student.studentId}</td>
                        <td class="border px-4 py-2">${studentNamePrefix}${fullName}</td>
                        <td class="border px-4 py-2">${student.gender}</td>
                        <td class="border px-4 py-2">${age}</td>
                        <td class="border px-4 py-2">${className}</td>
                        <td class="border px-4 py-2 whitespace-nowrap">
                            <button onclick="openEditModal('student', ${student.id})" class="text-blue-600 hover:underline mr-2">កែ</button>
                            <button onclick="confirmDelete('students', ${student.id}, '${name}')" class="text-red-600 hover:underline">លុប</button>
                        </td>
                    </tr>`);
                });
                
                studentList.innerHTML = studentRows.join(''); // (UPDATED V14.10) Set HTML once
                
            } catch (error) { 
                console.error("Error loading students: ", error); 
                // (UPDATED) Colspan 8 -> 7
                studentList.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-red-500">Error!</td></tr>';
            }
        }
        document.getElementById('addStudentForm').onsubmit = async (event) => {
            event.preventDefault();
            const studentData = {
                studentId: document.getElementById('studentId').value,
                lastName: document.getElementById('lastName').value,
                firstName: document.getElementById('firstName').value,
                gender: document.getElementById('gender').value,
                dob: document.getElementById('dob').value,
                classId: document.getElementById('studentClassId').value,
                photoUrl: document.getElementById('photoUrl').value || null
            };
            if (!studentData.studentId || !studentData.lastName || !studentData.firstName || !studentData.gender || !studentData.dob || !studentData.classId) {
                return showToast("សូមបំពេញគ្រប់ប្រអប់ (លើកលែងតែរូបថត)។", true);
            }
            try {
                await db.students.add(studentData);
                event.target.reset();
                showToast("បានបន្ថែមសិស្សថ្មី។");
                loadStudents();
            } catch (error) {
                console.error("Error adding student: ", error);
                showToast("Error: លេខសម្គាល់សិស្សអាចជាន់គ្នា។", true);
            }
        };

        // --- 5. មុខងារគ្រប់គ្រងកាលវិភាគ (Manage Schedule) ---
        async function loadSchedules() {
            try {
                allSchedules = await db.schedule.toArray();
                const scheduleList = document.getElementById('schedule-list');
                
                // (NEW V14.14) Filter logic
                const searchTerm = document.getElementById('searchScheduleInput').value.toLowerCase();
                const classMap = new Map(allClasses.map(c => [c.classId, c.className]));
                
                const filteredSchedules = allSchedules.filter(schedule => {
                    const className = classMap.get(schedule.classId) || schedule.classId;
                    return className.toLowerCase().includes(searchTerm);
                });

                if (filteredSchedules.length === 0) {
                    scheduleList.innerHTML = '<tr><td colspan="5" class="text-center p-4">មិនមានទិន្នន័យទេ។</td></tr>';
                    return;
                }

                scheduleList.innerHTML = ''; // Clear
                const days = ["អាទិត្យ", "ច័ន្ទ", "អង្គារ", "ពុធ", "ព្រហស្បតិ៍", "សុក្រ", "សៅរ៍"];
                
                filteredSchedules.forEach(schedule => {
                    const className = classMap.get(schedule.classId) || schedule.classId;
                    const name = `${days[schedule.dayOfWeek]} (${schedule.startTime}-${schedule.endTime})`.replace(/'/g, "\\'");
                    scheduleList.innerHTML += `<tr>
                        <td class="border px-4 py-2">${className}</td>
                        <td class="border px-4 py-2">${days[schedule.dayOfWeek]}</td>
                        <td class="border px-4 py-2">${schedule.startTime}</td>
                        <td class="border px-4 py-2">${schedule.endTime}</td>
                        <td class="border px-4 py-2 whitespace-nowrap">
                            <button onclick="openEditModal('schedule', ${schedule.id})" class="text-blue-600 hover:underline mr-2">កែ</button>
                            <button onclick="confirmDelete('schedule', ${schedule.id}, '${name}')" class="text-red-600 hover:underline">លុប</button>
                        </td>
                    </tr>`;
                });
            } catch (error) { 
                console.error("Error loading schedules: ", error); 
                document.getElementById('schedule-list').innerHTML = '<tr><td colspan="5" class="text-center p-4 text-red-500">Error!</td></tr>';
            }
        }
        document.getElementById('addScheduleForm').onsubmit = async (event) => {
            event.preventDefault();
            const scheduleClassId = document.getElementById('scheduleClassId').value;
            const dayOfWeek = parseInt(document.getElementById('dayOfWeek').value);
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            if (!scheduleClassId || !startTime || !endTime) return showToast("សូមបំពេញគ្រប់ប្រអប់។", true);
            try {
                await db.schedule.add({ classId: scheduleClassId, dayOfWeek, startTime, endTime });
                if (window.currentUserId -and  -ne ) {}
                if (window.currentUserId && window.supabase) {
                    try {
                        const { error: sErr } = await window.supabase.from('schedules').insert({ user_id: window.currentUserId, class_id: scheduleClassId, day_of_week: dayOfWeek, start_time: startTime, end_time: endTime });
                        if (sErr) { /* ignore to keep UX smooth */ }
                    } catch {}
                }
                event.target.reset();
                showToast("បានបន្ថែម កាលវិភាគថ្មី។");
                loadSchedules();
            } catch (error) { console.error("Error adding schedule: ", error); }
        };

        // --- 6. មុខងារស្កេន (Scanner Logic) (UPDATED for V14) ---
        
        // (UPDATED) សម្រាប់ USB Scanner
        document.getElementById('usb-scanner-input').onkeyup = async (event) => {
            if (event.key === 'Enter' || event.keyCode === 13) {
                const decodedText = event.target.value.trim();
                if (decodedText) {
                    await onScanSuccess(decodedText); // ហៅមុខងារ onScanSuccess
                }
                event.target.value = ''; // សម្អាតប្រអប់
                document.getElementById('usb-scanner-input').focus(); // Focus ត្រឡប់ទៅប្រអប់វិញ
            }
        };

        let isProcessingScan = false;
        async function onScanSuccess(decodedText) {
            if (isProcessingScan) return;
            isProcessingScan = true;
            
            const studentId = decodedText;
            const scanTime = new Date();
            
            const scanResultEl = document.getElementById('scan-result'); // ខាងឆ្វេង (សម្រាប់ Error/Loading)
            const studentInfoEl = document.getElementById('student-info-display'); // ខាងស្តាំ (សម្រាប់ Success)
            const scanStatusEl = document.getElementById('scan-status-display'); // (NEW) ស្ទឹងខាងស្តាំ

            scanResultEl.innerHTML = `<div class="p-4 bg-gray-100 text-gray-700 rounded-lg"><p>កំពុងពិនិត្យ... (${studentId})</p></div>`;
            studentInfoEl.innerHTML = ''; // សម្អាតទិន្នន័យចាស់ (បើមាន)
            scanStatusEl.innerHTML = ''; // (NEW) សម្អាតស្ថានភាពចាស់

            try {
                const student = await db.students.get({ studentId: studentId });
                if (!student) throw new Error(`មិនស្គាល់សិស្ស! (ID: ${studentId})`);

                // (UPDATED) បន្ថែម "ក. " សម្រាប់សិស្សស្រី
                const studentNamePrefix = (student.gender === 'ស្រី') ? 'ក. ' : '';
                const fullName = `${studentNamePrefix}${student.lastName || ''} ${student.firstName || ''}`.trim();
                
                const currentDay = scanTime.getDay();
                
                if (allClasses.length === 0) { await loadClassesForSelect(); }
                const classMap = new Map(allClasses.map(c => [c.classId, c.className]));
                const className = classMap.get(student.classId) || student.classId;

                const studentSchedules = await db.schedule.where({ classId: student.classId, dayOfWeek: currentDay }).toArray();
                if (studentSchedules.length === 0) throw new Error(`សិស្ស ${fullName} មិនមានថ្នាក់រៀននៅថ្ងៃនេះទេ។`);
                
                let activeSchedule = null;
                // (UPDATED V14.1) បង្កើន Buffer សម្រាប់ស្កេនចេញ
                const checkInBuffer = 15 * 60 * 1000; // 15 នាទី មុនម៉ោងចូល
                const checkOutBuffer = 60 * 60 * 1000; // 60 នាទី ក្រោយម៉ោងចេញ

                for (const schedule of studentSchedules) {
                    const [startH, startM] = schedule.startTime.split(':').map(Number);
                    const [endH, endM] = schedule.endTime.split(':').map(Number);
                    const startTime = new Date(scanTime); startTime.setHours(startH, startM, 0, 0);
                    const endTime = new Date(scanTime); endTime.setHours(endH, endM, 0, 0);
                    
                    const checkInStart = new Date(startTime.getTime() - checkInBuffer);
                    const checkOutEnd = new Date(endTime.getTime() + checkOutBuffer);
                    
                    if (scanTime >= checkInStart && scanTime <= checkOutEnd) {
                        activeSchedule = schedule;
                        break;
                    }
                }
                if (!activeSchedule) throw new Error(`សិស្ស ${fullName} មិនមានម៉ោងរៀននៅពេលនេះទេ។ (ម៉ោងស្កេន៖ ${scanTime.toLocaleTimeString()})`);
                
                const logDate = scanTime.toISOString().split('T')[0];
                const existingLog = await db.attendanceLog.where("[studentId+scheduleId+attendanceDate]").equals([studentId, activeSchedule.id, logDate]).first();
                
                let statusText = "";
                let statusColor = "";

                if (!existingLog) {
                    await db.attendanceLog.add({
                        studentId, studentName: fullName, classId: student.classId,
                        scheduleId: activeSchedule.id, attendanceDate: logDate,
                        scanTimeIn: scanTime, scanTimeOut: null
                    });
                    statusText = "បានស្កេនចូលជោគជ័យ!";
                    statusColor = "text-green-600";
                } else {
                    if (existingLog.scanTimeOut) throw new Error(`សិស្ស ${fullName} បានស្កេនចេញរួចរាល់ហើយ។`);
                    await db.attendanceLog.update(existingLog.id, { scanTimeOut: scanTime });
                    statusText = "បានស្កេនចេញជោគជ័យ!";
                    statusColor = "text-yellow-600";
                }

                // (UPDATED V14.3) បង្ហាញលទ្ធផលនៅស្ទឹងកណ្តាល (បន្ថយទំហំរូបថត)
                const successHtml = `
                    <!-- (UPDATED) Wrapper ដើម្បីកំណត់ទំហំ និងដាក់កណ្តាល -->
                    <div class="max-w-sm mx-auto"> 
                        <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                            <div class="relative">
                                <img src="${student.photoUrl || PLACEHOLDER_IMG}" alt="រូបថតសិស្ស" class="w-full h-auto object-cover rounded-lg shadow-md" style="aspect-ratio: 1/1;" onerror="this.src='${PLACEHOLDER_IMG}'">
                                <!-- (REMOVED) ស្ថានភាពស្កេន ពីលើរូបថត -->
                            </div>
                            <!-- (UPDATED) បន្ថែម text-center និងពង្រីកអក្សរ -->
                            <div class="text-center">
                                <h2 class="text-3xl font-bold text-gray-800 mt-4 font-title">${fullName}</h2>
                                <p class="text-xl text-gray-700 font-semibold mt-1">ID: ${student.studentId}</p>
                                <p class="text-xl text-gray-600">${className}</p>
                                <p class="text-lg text-gray-500 mt-2">ម៉ោង: ${scanTime.toLocaleTimeString('km-KH')}</p>
                            </div>
                        </div>
                    </div>`;
                studentInfoEl.innerHTML = successHtml;

                // (NEW) បង្ហាញស្ថានភាពនៅស្ទឹងខាងស្តាំ
                scanStatusEl.innerHTML = `<div class="text-4xl font-bold ${statusColor} transform rotate-15 animate-fade-in whitespace-nowrap">${statusText}</div>`;
                
                scanResultEl.innerHTML = ''; // សម្អាតផ្ទះ Loading/Error

            } catch (error) {
                console.error("Scan Error:", error);
                // (NEW) បង្ហាញ Error នៅស្ទឹងខាងឆ្វេង
                scanResultEl.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg"><p class="font-bold">ស្កេនបរាជ័យ!</p><p>${error.message}</p></div>`;
                
                // (UPDATED V14.3) បង្ហាញ Error នៅស្ទឹងកណ្តាល (ក្នុង Wrapper) - ធំៗ
                studentInfoEl.innerHTML = `
                    <div class="max-w-sm mx-auto h-full flex items-center justify-center"> <!-- (NEW) Wrapper -->
                        <div class="text-center text-red-500 animate-fade-in">
                            <h2 class="text-5xl font-title">ស្កេនបរាជ័យ!</h2>
                            <p class="mt-4 text-xl">${error.message}</p>
                        </div>
                    </div>`;
                scanStatusEl.innerHTML = ''; // (NEW) សម្អាតស្ទឹងខាងស្តាំ
            } finally {
                // (UPDATED) មិនលាក់លទ្ធផលទេ គ្រាន់តែអនុញ្ញាតឲ្យស្កេនថ្មី
                setTimeout(() => { 
                    isProcessingScan = false; 
                }, 1000); // បន្ថយ Timeout ព្រោះមិនបាច់រង់ចាំអាន
            }
        }

        // --- 7. មុខងាររបាយការណ៍ (Report Logic) (UPDATED for V14.11/12) ---
        function formatDate(date) { return date.toISOString().split('T')[0]; }
        function getWeekRange(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diffToMonday = (day === 0) ? -6 : (1 - day);
            const monday = new Date(d.setDate(d.getDate() + diffToMonday));
            monday.setHours(0, 0, 0, 0);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23, 59, 59, 999);
            return { start: formatDate(monday), end: formatDate(sunday) };
        }
        function getMonthRange(yearMonth) {
            const [year, month] = yearMonth.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);
            return { 
                start: formatDate(startDate), 
                end: formatDate(endDate),
                monthName: khmerMonths[month - 1],
                year: year
            };
        }
        
        // (UPDATED V14.12) Toggles header based on report type
        function setReportHeader(reportType) {
            const header = document.getElementById('report-table-header');
            if (reportType === 'daily') {
                header.innerHTML = `
                    <th class="px-4 py-2">សិស្ស</th>
                    <th class="px-4 py-2">ថ្នាក់</th>
                    <th class="px-4 py-2">កាលបរិច្ឆេទ (ម៉ោង)</th>
                    <th class="px-4 py-2">ម៉ោងចូល</th>
                    <th class="px-4 py-2">ម៉ោងចេញ</th>
                    <th class="px-4 py-2">រយៈពេល</th>
                    <th class="px-4 py-2">ស្ថានភាព</th>
                    <th class="px-4 py-2">លុប</th>
                `;
            } else {
                // (Weekly/Monthly)
                header.innerHTML = `
                    <th class="px-4 py-2">សិស្ស</th>
                    <th class="px-4 py-2">ថ្នាក់</th>
                    <th class="px-4 py-2">កាលបរិច្ឆេទ</th>
                    <th class="px-4 py-2">ម៉ោងចូល</th>
                    <th class="px-4 py-2">ម៉ោងចេញ</th>
                    <th class="px-4 py-2">រយៈពេល</th>
                    <th class="px-4 py-2">ស្ថានភាព</th>
                    <th class="px-4 py-2">លុប</th>
                `;
            }
        }
        
        // (HEAVILY UPDATED V14.11)
        async function loadReportData() {
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            const filterClassId = document.getElementById('reportFilterClass').value;
            const filterDateInput = document.getElementById('reportFilterDate');
            const filterStatus = document.getElementById('reportFilterStatus').value; // (NEW V14.6)
            const searchReportInput = document.getElementById('searchReportInput').value.toLowerCase(); // (NEW V14.14)
            const reportDateRangeEl = document.getElementById('report-date-range');
            const reportTableBody = document.getElementById('report-table-body');
            
            reportTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4">កំពុងទាញយក...</td></tr>';
            setReportHeader(reportType); // (NEW V14.12)
            currentReportData = []; // Clear global report data

            // (NEW V14.11) Check if class is selected
            if (filterClassId === 'none') {
                reportTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4">សូមជ្រើសរើសថ្នាក់រៀន ដើម្បីបង្ហាញរបាយការណ៍។</td></tr>';
                reportDateRangeEl.textContent = '';
                return;
            }

            // Load helpers
            if (allClasses.length === 0) await loadClassesForSelect();
            // (UPDATED V14.11) Load all schedules, not just from map
            allSchedules = await db.schedule.toArray(); 
            const schedulesMap = new Map(allSchedules.map(s => [s.id, s]));
            const classMap = new Map(allClasses.map(c => [c.classId, c.className]));

            let startDate, endDate;
            let finalReportList = []; 
            const today = new Date();
            const now = today.getTime();
            today.setHours(0,0,0,0); // For date comparison

            // --- (UPDATED V14.11 - Daily Report Logic) ---
            if (reportType === 'daily') {
                const selectedDateStr = filterDateInput.value;
                const selectedDate = new Date(selectedDateStr + 'T00:00:00'); // Ensure local time
                const selectedDayOfWeek = selectedDate.getDay();
                
                startDate = selectedDateStr;
                endDate = selectedDateStr;
                reportDateRangeEl.textContent = `របាយការណ៍សម្រាប់ថ្ងៃទី៖ ${startDate}`;

                // 1. Get all students for the filter
                let studentQuery = db.students;
                if (filterClassId) {
                    studentQuery = studentQuery.where('classId').equals(filterClassId);
                }
                const allStudentsInFilter = await studentQuery.toArray();

                // 2. Get all logs for that *one day*
                const logsForDay = await db.attendanceLog.where('attendanceDate').equals(startDate).toArray();
                const logMap = new Map(logsForDay.map(log => [`${log.studentId}-${log.scheduleId}`, log])); // (UPDATED V14.12) Key by student+schedule

                // 3. Process the list (Iterate STUDENTS, not logs)
                for (const student of allStudentsInFilter) {
                    
                    const studentSchedules = allSchedules.filter(s => s.classId === student.classId && s.dayOfWeek === selectedDayOfWeek);
                    const studentName = `${student.lastName} ${student.firstName}`;
                    const className = classMap.get(student.classId) || student.classId;

                    // (NEW V14.11) Check if student has class today
                    if (studentSchedules.length === 0) {
                        finalReportList.push({
                            studentId: student.studentId,
                            studentName: studentName,
                            classId: student.classId,
                            className: className,
                            gender: student.gender, // (NEW V14.4)
                            attendanceDate: startDate,
                            scheduleTimeStr: 'N/A', // (NEW V14.12)
                            statusText: "មិនមានថ្នាក់រៀន",
                            statusHtml: '<span class="text-blue-600 font-bold">មិនមានថ្នាក់រៀន</span>',
                            statusCode: "no_class", // (NEW V14.6)
                            timeInString: 'N/A',
                            timeOutString: 'N/A',
                            durationString: 'N/A',
                            deleteId: null 
                        });
                        continue; // Go to next student
                    }

                    // (UPDATED V14.12) Loop through all schedules student has today
                    for (const schedule of studentSchedules) {
                        const log = logMap.get(`${student.studentId}-${schedule.id}`);
                        const scheduleTimeStr = `(${schedule.startTime}-${schedule.endTime})`; // (NEW V14.12)

                        if (log) {
                            // (Student is PRESENT)
                            let status = '<span class="text-green-600">មានវត្តមាន</span>';
                            let statusText = "មានវត្តមាន";
                            let statusCode = "present";
                            
                            if (schedule && log.scanTimeIn) {
                                const [startH, startM] = schedule.startTime.split(':').map(Number);
                                const classStartTime = new Date(log.scanTimeIn);
                                classStartTime.setHours(startH, startM, 0, 0);
                                const diffMs = log.scanTimeIn - classStartTime;
                                if (diffMs > (1 * 60 * 1000)) { // 1 minute buffer
                                    const lateMinutes = Math.round(diffMs / 60000);
                                    status = `<span class="text-yellow-600">មកយឺត (${lateMinutes} នាទី)</span>`;
                                    statusText = `មកយឺត (${lateMinutes} នាទី)`;
                                    statusCode = "late";
                                }
                            }
                            
                            let durationString = 'N/A';
                            if (log.scanTimeIn && log.scanTimeOut) {
                                const durationMs = log.scanTimeOut - log.scanTimeIn;
                                const totalMinutes = Math.floor(durationMs / 60000);
                                const hours = Math.floor(totalMinutes / 60);
                                const minutes = totalMinutes % 60;
                                durationString = `${hours} ម៉ោង ${minutes} នាទី`;
                            }

                            if (schedule && log.scanTimeOut) {
                                const [endH, endM] = schedule.endTime.split(':').map(Number);
                                const classEndTime = new Date(log.scanTimeOut);
                                classEndTime.setHours(endH, endM, 0, 0);
                                if (log.scanTimeOut < classEndTime) {
                                    const diffMsEarly = classEndTime - log.scanTimeOut;
                                    const earlyMinutes = Math.round(diffMsEarly / 60000);
                                    status += ` / <span class="text-blue-600">ចេញមុន (${earlyMinutes} នាទី)</span>`;
                                    statusText += ` / ចេញមុន (${earlyMinutes} នាទី)`;
                                    // statusCode remains 'present' or 'late'
                                }
                            } else if (log.scanTimeIn && !log.scanTimeOut) {
                                status += ' / <span class="text-red-600">មិនបានស្កេនចេញ</span>';
                                statusText += " / មិនបានស្កេនចេញ";
                                statusCode = "no_checkout";
                            }

                            const timeInString = log.scanTimeIn ? log.scanTimeIn.toLocaleTimeString('km-KH') : 'N/A';
                            const timeOutString = log.scanTimeOut ? log.scanTimeOut.toLocaleTimeString('km-KH') : 'N/A';

                            finalReportList.push({
                                ...log,
                                studentName: studentName,
                                gender: student.gender, // (NEW V14.4)
                                className: className,
                                scheduleTimeStr: scheduleTimeStr, // (NEW V14.12)
                                statusText: statusText,
                                statusHtml: status,
                                statusCode: statusCode, // (NEW V14.6)
                                timeInString: timeInString,
                                timeOutString: timeOutString,
                                durationString: durationString,
                                deleteId: log.id // ID for deletion
                            });

                        } else {
                            // (Student is ABSENT or NOT SCANNED YET) - New logic V14.1
                            // (UPDATED V14.11) - Check V14.1 logic
                            let [endH, endM] = schedule.endTime.split(':').map(Number);
                            let scanValidityEnd = new Date(selectedDate);
                            scanValidityEnd.setHours(endH, endM, 0, 0);
                            scanValidityEnd = new Date(scanValidityEnd.getTime() + (60 * 60 * 1000)); // (V14.1) 60 min buffer

                            let statusText, statusHtml, statusCode;

                            if (selectedDate.getTime() > today.getTime()) {
                                // Future date
                                statusText = "មិនទាន់បានស្កេន";
                                statusHtml = '<span class="text-gray-500">មិនទាន់បានស្កេន</span>';
                                statusCode = "not_scanned";
                            } else if (selectedDate.getTime() < today.getTime() || now > scanValidityEnd.getTime()) {
                                // Past date OR Today but scan time has passed
                                statusText = "អវត្តមាន";
                                statusHtml = '<span class="text-red-600 font-bold">អវត្តមាន</span>';
                                statusCode = "absent";
                            } else {
                                // Today and scan time not yet passed
                                statusText = "មិនទាន់បានស្កេន";
                                statusHtml = '<span class="text-gray-500">មិនទាន់បានស្កេន</span>';
                                statusCode = "not_scanned";
                            }

                            finalReportList.push({
                                studentId: student.studentId,
                                studentName: studentName,
                                classId: student.classId,
                                className: className,
                                gender: student.gender, // (NEW V14.4)
                                attendanceDate: startDate,
                                scheduleTimeStr: scheduleTimeStr, // (NEW V14.12)
                                statusText: statusText,
                                statusHtml: statusHtml,
                                statusCode: statusCode, // (NEW V14.6)
                                timeInString: 'N/A',
                                timeOutString: 'N/A',
                                durationString: 'N/A',
                                deleteId: null // Cannot delete an absence
                            });
                        }
                    } // End loop schedules
                } // End loop students
            
            // --- (OLD LOGIC for Weekly/Monthly) ---
            } else {
                if (reportType === 'weekly') {
                    const week = getWeekRange(new Date(filterDateInput.value));
                    startDate = week.start;
                    endDate = week.end;
                    reportDateRangeEl.textContent = `របាយការណ៍សប្តាហ៍៖ ពី ${startDate} ដល់ ${endDate}`;
                } else { // monthly
                    const month = getMonthRange(filterDateInput.value);
                    startDate = month.start;
                    endDate = month.end;
                    reportDateRangeEl.textContent = `របាយការណ៍សម្រាប់ខែ៖ ${month.monthName} ឆ្នាំ ${month.year}`;
                }
                
                let query = db.attendanceLog.where('attendanceDate').between(startDate, endDate, true, true);
                if (filterClassId) {
                    query = query.and(log => log.classId === filterClassId);
                }
                const logs = await query.toArray();
                
                // (NEW V14.4) We need student data (gender) even for weekly/monthly
                const allStudents = await db.students.toArray();
                const studentMap = new Map(allStudents.map(s => [s.studentId, s]));

                // (MODIFIED) Process logs into finalReportList
                for (const log of logs) {
                    const schedule = schedulesMap.get(log.scheduleId);
                    const className = classMap.get(log.classId) || log.classId;
                    const student = studentMap.get(log.studentId); // (NEW V14.4)
                    
                    let status = '<span class="text-green-600">មានវត្តមាន</span>';
                    let statusText = "មានវត្តមាន";
                    let statusCode = "present";
                    
                    if (schedule && log.scanTimeIn) {
                        const [startH, startM] = schedule.startTime.split(':').map(Number);
                        const classStartTime = new Date(log.scanTimeIn);
                        classStartTime.setHours(startH, startM, 0, 0);
                        const diffMs = log.scanTimeIn - classStartTime;
                        if (diffMs > (1 * 60 * 1000)) { // 1 min buffer
                            const lateMinutes = Math.round(diffMs / 60000);
                            status = `<span class="text-yellow-600">មកយឺត (${lateMinutes} នាទី)</span>`;
                            statusText = `មកយឺត (${lateMinutes} នាទី)`;
                            statusCode = "late";
                        }
                    }
                    
                    let durationString = 'N/A';
                    if (log.scanTimeIn && log.scanTimeOut) {
                        const durationMs = log.scanTimeOut - log.scanTimeIn;
                        const totalMinutes = Math.floor(durationMs / 60000);
                        const hours = Math.floor(totalMinutes / 60);
                        const minutes = totalMinutes % 60;
                        durationString = `${hours} ម៉ោង ${minutes} នាទី`;
                    }

                    if (schedule && log.scanTimeOut) {
                        const [endH, endM] = schedule.endTime.split(':').map(Number);
                        const classEndTime = new Date(log.scanTimeOut);
                        classEndTime.setHours(endH, endM, 0, 0);
                        if (log.scanTimeOut < classEndTime) {
                            const diffMsEarly = classEndTime - log.scanTimeOut;
                            const earlyMinutes = Math.round(diffMsEarly / 60000);
                            status += ` / <span class="text-blue-600">ចេញមុន (${earlyMinutes} នាទី)</span>`;
                            statusText += ` / ចេញមុន (${earlyMinutes} នាទី)`;
                        }
                    } else if (log.scanTimeIn && !log.scanTimeOut) {
                        status += ' / <span class="text-red-600">មិនបានស្កេនចេញ</span>';
                        statusText += " / មិនបានស្កេនចេញ";
                        statusCode = "no_checkout";
                    }
                    
                    const timeInString = log.scanTimeIn ? log.scanTimeIn.toLocaleTimeString('km-KH') : 'N/A';
                    const timeOutString = log.scanTimeOut ? log.scanTimeOut.toLocaleTimeString('km-KH') : 'N/A';

                    finalReportList.push({
                        ...log,
                        studentName: log.studentName, // Use log's name
                        gender: student ? student.gender : 'N/A', // (NEW V14.4)
                        className: className,
                        scheduleTimeStr: 'N/A', // (NEW V14.12)
                        statusText: statusText,
                        statusHtml: status,
                        statusCode: statusCode, // (NEW V14.6)
                        timeInString: timeInString,
                        timeOutString: timeOutString,
                        durationString: durationString,
                        deleteId: log.id
                    });
                }
            }

            // --- (NEW V14.6) Post-processing (Filter by Status) ---
            let filteredByStatus = finalReportList;
            if (filterStatus !== 'all') {
                filteredByStatus = finalReportList.filter(item => item.statusCode === filterStatus);
            }
            
            // (NEW V14.14) Post-processing (Filter by Search)
            let filteredBySearch = filteredByStatus;
            if (searchReportInput) {
                filteredBySearch = filteredByStatus.filter(item => 
                    item.studentName.toLowerCase().includes(searchReportInput) ||
                    item.studentId.toLowerCase().includes(searchReportInput)
                );
            }

            // --- (NEW V14.12) Post-processing (Sorting A-Z) ---
            filteredBySearch.sort((a, b) => {
                if (a.attendanceDate !== b.attendanceDate) {
                    return a.attendanceDate.localeCompare(b.attendanceDate);
                }
                // (NEW V14.12) Sort by schedule time if dates are same
                if (a.scheduleTimeStr !== b.scheduleTimeStr) {
                    return a.scheduleTimeStr.localeCompare(b.scheduleTimeStr);
                }
                return a.studentName.localeCompare(b.studentName, 'km');
            });

            // --- (NEW) Render from finalReportList ---
            if (filteredBySearch.length === 0) {
                reportTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4">មិនមានទិន្នន័យទេ។</td></tr>';
                currentReportData = []; // (NEW V14.12)
                return;
            }

            // (NEW) Assign to global var *after* processing
            currentReportData = filteredBySearch; 

            let tableHtml = '';
            for (const item of currentReportData) {
                const deleteButton = item.deleteId
                    ? `<button onclick="confirmDelete('attendanceLog', ${item.deleteId}, '${item.studentName.replace(/'/g, "\\'")}')" class="text-red-600 hover:underline">លុប</button>`
                    : ''; // No delete button for "Absent" records

                // (UPDATED) បន្ថែម "ក. " សម្រាប់សិស្សស្រី
                const studentNamePrefix = (item.gender === 'ស្រី') ? 'ក. ' : '';

                // (UPDATED V14.12) Different columns for daily
                if (reportType === 'daily') {
                    tableHtml += `
                        <tr>
                            <td class="border px-4 py-2">${studentNamePrefix}${item.studentName}</td>
                            <td class="border px-4 py-2">${item.className}</td>
                            <td class="border px-4 py-2">${item.attendanceDate} <span class="text-xs text-gray-500">${item.scheduleTimeStr}</span></td>
                            <td class="border px-4 py-2">${item.timeInString}</td>
                            <td class="border px-4 py-2">${item.timeOutString}</td>
                            <td class="border px-4 py-2">${item.durationString}</td>
                            <td class="border px-4 py-2">${item.statusHtml}</td>
                            <td class="border px-4 py-2">${deleteButton}</td>
                        </tr>`;
                } else {
                     tableHtml += `
                        <tr>
                            <td class="border px-4 py-2">${studentNamePrefix}${item.studentName}</td>
                            <td class="border px-4 py-2">${item.className}</td>
                            <td class="border px-4 py-2">${item.attendanceDate}</td>
                            <td class="border px-4 py-2">${item.timeInString}</td>
                            <td class="border px-4 py-2">${item.timeOutString}</td>
                            <td class="border px-4 py-2">${item.durationString}</td>
                            <td class="border px-4 py-2">${item.statusHtml}</td>
                            <td class="border px-4 py-2">${deleteButton}</td>
                        </tr>`;
                }
            }
            reportTableBody.innerHTML = tableHtml;
        }
        
        // --- (UPDATED V14.19) 8. មុខងារនាំចេញ (Export Report to Excel) ---
        async function exportReportToExcel() {
            if (currentReportData.length === 0) {
                return showToast("មិនមានទិន្នន័យសម្រាប់នាំចេញទេ។ សូមបង្ហាញរបាយការណ៍សិន។", true);
            }
            showToast("កំពុងរៀបចំទិន្នន័យនាំចេញ...");
            
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            let exportData;
            
            if (reportType === 'daily') {
                exportData = currentReportData.map(log => ({
                    "អត្តលេខ": log.studentId,
                    "ឈ្មោះសិស្ស": log.studentName,
                    "ភេទ": log.gender,
                    "ថ្នាក់": log.className,
                    "កាលបរិច្ឆេទ": log.attendanceDate,
                    "ម៉ោងសិក្សា": log.scheduleTimeStr,
                    "ម៉ោងចូល": log.timeInString,
                    "ម៉ោងចេញ": log.timeOutString,
                    "រយៈពេល": log.durationString,
                    "ស្ថានភាព": log.statusText
                }));
            } else { // Weekly/Monthly
                exportData = currentReportData.map(log => ({
                    "អត្តលេខ": log.studentId,
                    "ឈ្មោះសិស្ស": log.studentName,
                    "ភេទ": log.gender,
                    "ថ្នាក់": log.className,
                    "កាលបរិច្ឆេទ": log.attendanceDate,
                    "ម៉ោងចូល": log.timeInString,
                    "ម៉ោងចេញ": log.timeOutString,
                    "រយៈពេល": log.durationString,
                    "ស្ថានភាព": log.statusText
                }));
            }

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendance Report");
            XLSX.writeFile(wb, `attendance_report_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showToast("ការនាំចេញទិន្នន័យជោគជ័យ!");
        }

        // --- 9. មុខងារបោះពុម្ព (Print Logic) ---
        // (HEAVILY UPDATED V14.22)
        async function printReport() {
            if (currentReportData.length === 0) {
                return showToast("មិនមានទិន្នន័យសម្រាប់បោះពុម្ពទេ។ សូមបង្ហាញរបាយការណ៍សិន។", true);
            }
            
            const classSelect = document.getElementById('reportFilterClass');
            const filterClassId = classSelect.value;
            const className = filterClassId ? classSelect.options[classSelect.selectedIndex].text : "គ្រប់ថ្នាក់រៀន";
            let dateRange = document.getElementById('report-date-range').textContent;
            
            // (NEW V14.4) Add schedule time to title for Daily reports
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            if (reportType === 'daily' && filterClassId) {
                const selectedDate = new Date(document.getElementById('reportFilterDate').value + 'T00:00:00');
                const selectedDayOfWeek = selectedDate.getDay();
                
                const classSchedules = allSchedules.filter(s => s.classId === filterClassId && s.dayOfWeek === selectedDayOfWeek);
                
                if (classSchedules.length > 0) {
                    classSchedules.sort((a, b) => a.startTime.localeCompare(b.startTime));
                    const earliestStart = classSchedules[0].startTime;
                    classSchedules.sort((a, b) => b.endTime.localeCompare(a.endTime));
                    const latestEnd = classSchedules[0].endTime;
                    dateRange += ` (ម៉ោង ${earliestStart}-${latestEnd})`;
                }
            }

            // (NEW V14.22) Teacher Name & Signature (Per Class)
            let teacherName = ".........................";
            let signatureUrl = null;
            if (filterClassId && allClasses.length > 0) {
                const currentClass = allClasses.find(c => c.classId === filterClassId);
                if (currentClass) {
                    teacherName = currentClass.teacherName || ".........................";
                    signatureUrl = currentClass.signatureUrl;
                }
            }
            const signatureImg = signatureUrl ? `<img src="${signatureUrl}" alt="ហត្ថលេខា" style="height: 50px; margin-bottom: -10px;">` : ".........................";

            // (NEW V14.22) Global Settings for Print Header
            const schoolName = localStorage.getItem('settingSchoolName') || '.........................';
            const directorSealUrl = localStorage.getItem('settingDirectorSealUrl');
            const directorSealImg = directorSealUrl ? `<img src="${directorSealUrl}" alt="ត្រាសាលា" style="height: 80px; width: 80px; object-fit: contain;">` : '';

            // (NEW V14.5) ធ្វើទ្រង់ទ្រាយកាលបរិច្ឆេទបោះពុម្ព
            const printDate = new Date();
            const printDay = printDate.getDate();
            const printMonth = khmerMonths[printDate.getMonth()];
            const printYear = printDate.getFullYear();
            const printDateKh = `ថ្ងៃ${printDay} ខែ${printMonth} ឆ្នាំ${printYear}`;

            // (NEW V14.2) Dynamic font size
            const dataLength = currentReportData.length;
            let fontSize = "10px";
            if (dataLength < 50) fontSize = "12px";
            if (dataLength < 30) fontSize = "14px";

            let printHtml = `<html><head><title>របាយការណ៍អវត្តមាន</title><meta charset="UTF-8">
            <style>
                body { 
                    font-family: 'Kantumruy Pro', 'Khmer OS', 'Helvetica Neue', Helvetica, Arial, sans-serif; 
                    margin: 0; 
                }
                h1, h2, h3 { text-align: center; font-family: 'Moul', 'Khmer OS Muol Light', cursive; margin: 5px 0; }
                h1 { font-size: 22px; }
                h2 { font-size: 18px; }
                h3 { font-size: 16px; font-weight: normal; font-family: 'Kantumruy Pro', 'Khmer OS', sans-serif; } 
                table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: ${fontSize}; } 
                th, td { border: 1px solid black; padding: 5px; text-align: left; white-space: nowrap; } 
                /* (UPDATED V14.5) Center align Header + No. column */
                th { background-color: #f2f2f2; text-align: center; }
                td:first-child { text-align: center; } 
                
                /* (NEW V14.2) Print Status Colors */
                .status-present { color: green; }
                .status-late { color: #D97706; } /* Orange */
                .status-absent { color: red; font-weight: bold; }
                .status-no_checkout { color: red; }
                .status-not_scanned { color: gray; }
                .status-no_class { color: blue; }
                
                /* (NEW V14.2) Footer for Signature */
                .signature-footer {
                    margin-top: 30px;
                    width: 100%;
                    display: table;
                }
                .footer-left {
                    display: table-cell;
                    text-align: left;
                    font-size: 12px;
                }
                .footer-right {
                    display: table-cell;
                    text-align: center;
                    width: 40%;
                    font-size: 14px;
                }

                /* (NEW V14.22) Print Header */
                .print-header { display: table; width: 100%; margin-bottom: 10px; }
                .header-left { display: table-cell; text-align: left; vertical-align: top; width: 25%; }
                .header-center { display: table-cell; text-align: center; vertical-align: top; }
                .header-right { 
                    display: table-cell; text-align: center; vertical-align: top; width: 25%; 
                    font-size: 14px; line-height: 1.5; font-family: 'Moul', 'Khmer OS Muol Light', cursive;
                }
            </style>
            </head><body>
            
            <!-- (NEW V14.22) Print Header -->
            <div class="print-header">
                <div class="header-left">
                    ${directorSealImg}
                </div>
                <div class="header-center">
                    <h1 style="margin: 0;">${schoolName}</h1> 
                    <h1>របាយការណ៍អវត្តមានសិស្ស</h1> 
                    <h2>${className}</h2> 
                    <h3>${dateRange}</h3>
                </div>
                <div class="header-center">
                    ព្រះរាជាណាចក្រកម្ពុជា <br> ជាតិ សាសនា ព្រះមហាក្សត្រ
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ល.រ</th>
                        <th>ឈ្មោះសិស្ស</th>
                        <th>ម៉ោងចូល</th>
                        <th>ម៉ោងចេញ</th>
                        <th>រយៈពេល</th>
                        <th>ស្ថានភាព</th>
                    </tr>
                </thead>
                <tbody>`;
            
            currentReportData.forEach((log, index) => {
                // (NEW V14.2) Get CSS class for status
                let statusClass = "status-present";
                if (log.statusCode === 'late') statusClass = "status-late";
                if (log.statusCode === 'absent') statusClass = "status-absent";
                if (log.statusCode === 'no_checkout') statusClass = "status-no_checkout";
                if (log.statusCode === 'not_scanned') statusClass = "status-not_scanned";
                if (log.statusCode === 'no_class') statusClass = "status-no_class";
                
                // (NEW V14.4) បន្ថែម "ក. " សម្រាប់សិស្សស្រី
                const studentNamePrefix = (log.gender === 'ស្រី') ? 'ក. ' : '';

                printHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${studentNamePrefix}${log.studentName}</td>
                        <td>${log.timeInString}</td>
                        <td>${log.timeOutString}</td>
                        <td>${log.durationString}</td>
                        <td class="${statusClass}">${log.statusText}</td>
                    </tr>`;
            });
            
            printHtml += `</tbody></table>
            
            <!-- (UPDATED V14.5) ផ្លាស់ប្តូរទីតាំង Footer -->
            <div class="signature-footer">
                <div class="footer-left">
                    <!-- (REMOVED V14.5) ថ្ងៃទីបោះពុម្ព -->
                </div>
                <div class="footer-right">
                    <p style="margin-bottom: 10px;">${printDateKh}</p>
                    <!-- (UPDATED V14.22) គ្រូមុខវិជ្ជា -> គ្រូបន្ទុកថ្នាក់ -->
                    <p style="margin: 0; font-weight: bold;">គ្រូបន្ទុកថ្នាក់</p>
                    <div style="height: 60px;">${signatureImg}</div>
                    <p style="margin: 0; font-weight: bold;">${teacherName}</p>
                </div>
            </div>
            
            </body></html>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHtml);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        // --- (UPDATED V14.19) 10. មុខងារនាំចូល/នាំចេញ ទិន្នន័យ (Excel) ---
        
        // (NEW V14.19) Export Table to Excel
        async function exportTableAsExcel(tableName) {
            if (!db[tableName]) return showToast("Table មិនត្រឹមត្រូវ។", true);
            try {
                showToast("កំពុងរៀបចំទិន្នន័យនាំចេញ...");
                const data = await db[tableName].toArray();
                if (data.length === 0) return showToast("មិនមានទិន្នន័យសម្រាប់នាំចេញទេ។", true);

                let exportData;
                
                // Map to Khmer Headers
                if (tableName === 'classes') {
                    exportData = data.map(item => ({
                        "លេខកូដ": item.classId,
                        "ឈ្មោះថ្នាក់": item.className,
                        "ឆ្នាំសិក្សា": item.academicYear,
                        "គ្រូបន្ទុកថ្នាក់": item.teacherName, // (NEW V14.22)
                        "ហត្ថលេខា URL": item.signatureUrl // (NEW V14.22)
                    }));
                } else if (tableName === 'students') {
                    exportData = data.map(item => ({
                        "អត្តលេខ": item.studentId,
                        "គោតនាម": item.lastName,
                        "នាម": item.firstName,
                        "ភេទ": item.gender,
                        "ថ្ងៃខែឆ្នាំកំណើត": item.dob,
                        "ថ្នាក់": item.classId,
                        "រូបថត URL": item.photoUrl
                    }));
                } else if (tableName === 'schedule') {
                    const days = ["អាទិត្យ", "ច័ន្ទ", "អង្គារ", "ពុធ", "ព្រហស្បតិ៍", "សុក្រ", "សៅរ៍"];
                    exportData = data.map(item => ({
                        "ថ្នាក់": item.classId,
                        "ថ្ងៃ": days[item.dayOfWeek],
                        "ម៉ោងចូល": item.startTime,
                        "ម៉ោងចេញ": item.endTime
                    }));
                } else {
                    exportData = data; // Fallback
                }

                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, tableName);
                XLSX.writeFile(wb, `${tableName}_export_${new Date().toISOString().split('T')[0]}.xlsx`);

                showToast("នាំចេញ Excel ជោគជ័យ!");
            } catch (error) {
                console.error(`Error exporting ${tableName} Excel: `, error);
                showToast(`មានបញ្ហាក្នុងការនាំចេញ Excel។ ${error.message}`, true);
            }
        }
        
        // (NEW V14.19) Import Table from Excel
        async function importDataFromExcel(tableName) {
            const fileInputIdMap = {
                'classes': 'importClassesFile', 'students': 'importStudentsFile', 'schedule': 'importScheduleFile'
            };
            const fileInput = document.getElementById(fileInputIdMap[tableName]);
            if (fileInput.files.length === 0) {
                return showToast("សូមជ្រើសរើសឯកសារ .xlsx ជាមុនសិន។", true);
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async (event) => {
                try {
                    const jsonData = JSON.parse(event.target.result);
                    if (!jsonData.data || !jsonData.data.classes || !jsonData.data.students || !jsonData.data.schedule) {
                        throw new Error("ទម្រង់ឯកសារបម្រុងទុកមិនត្រឹមត្រូវ។");
                    }
                    showToast("កំពុងនាំចូល... សូមរង់ចាំ។");
                    await db.transaction('rw', db.classes, db.students, db.schedule, async () => {
                        await db.classes.clear();
                        await db.students.clear();
                        await db.schedule.clear();
                        const classesToImport = jsonData.data.classes.map(c => { 
                            delete c.id; 
                            // (NEW V14.22) Ensure new fields exist on import
                            if (c.teacherName === undefined) c.teacherName = "";
                            if (c.signatureUrl === undefined) c.signatureUrl = "";
                            return c; 
                        });
                        const studentsToImport = jsonData.data.students.map(s => { delete s.id; return s; });
                        const scheduleToImport = jsonData.data.schedule.map(s => { delete s.id; return s; });
                        await db.classes.bulkPut(classesToImport);
                        await db.students.bulkPut(studentsToImport);
                        await db.schedule.bulkPut(scheduleToImport);
                    });
                    showToast("នាំចូលឯកសារបម្រុងទុកជោគជ័យ!", false);
                    fileInput.value = "";
                    await loadClassesForSelect();
                } catch (error) {
                    console.error("Error importing JSON backup: ", error);
                    showToast(`នាំចូលបរាជ័យ៖ ${error.message}`, true);
                }
            };
            reader.onerror = () => showToast("មិនអាចអានឯកសារបានទេ។", true);
            reader.readAsText(file);
        }

        // --- (NEW V14.20) 10.5. មុខងារវេនសំអាត (Cleaning Roster) ---
        
        // (NEW) Cache for generated roster data
        let currentRosterData = null; 
        let currentRosterClassName = "";
        let currentRosterClassId = ""; // (NEW V14.22)

        // (NEW) Clear roster when changing class
        function clearRoster() {
            document.getElementById('roster-display-area').innerHTML = '<p class="text-center text-gray-500">សូមជ្រើសរើសថ្នាក់ ហើយចុច "បង្កើតតារាងវេន"។</p>';
            currentRosterData = null;
            currentRosterClassName = "";
            currentRosterClassId = ""; // (NEW V14.22)
        }

        // (UPDATED V14.21) Generate Roster Logic (Fixed Distribution)
        async function generateCleaningRoster() {
            const classSelect = document.getElementById('rosterFilterClass');
            const classId = classSelect.value;
            const displayArea = document.getElementById('roster-display-area');

            if (classId === 'none' || !classId) {
                return showToast("សូមជ្រើសរើសថ្នាក់ជាមុនសិន។", true);
            }
            
            // (NEW V14.22) Store for printing
            currentRosterClassName = classSelect.options[classSelect.selectedIndex].text;
            currentRosterClassId = classId;

            displayArea.innerHTML = '<p class="text-center text-gray-500">កំពុងទាញយកសិស្ស...</p>';

            try {
                const studentsInClass = await db.students.where('classId').equals(classId).toArray();
                
                if (studentsInClass.length === 0) {
                    displayArea.innerHTML = '<p class="text-center text-red-500">មិនមានសិស្សនៅក្នុងថ្នាក់នេះទេ។</p>';
                    currentRosterData = null;
                    return;
                }

                // Shuffle students
                const shuffledStudents = studentsInClass.sort(() => 0.5 - Math.random());
                
                const totalStudents = shuffledStudents.length;
                
                // --- (NEW V14.21) Logic for fair distribution ---
                const baseSize = Math.floor(totalStudents / 6);
                const remainder = totalStudents % 6; // ចំនួនក្រុមដែលនឹងទទួលបានសិស្ស +1
                const days = ["ថ្ងៃច័ន្ទ", "ថ្ងៃអង្គារ", "ថ្ងៃពុធ", "ថ្ងៃព្រហស្បតិ៍", "ថ្ងៃសុក្រ", "ថ្ងៃសៅរ៍"];
                const groups = [];
                let currentIndex = 0;

                for (let i = 0; i < 6; i++) {
                    // ក្រុមទី 0 ដល់ (remainder - 1) នឹងទទួលបានសិស្សបន្ថែម
                    // ឧ. remainder = 5 (ក្រុម 0,1,2,3,4) ទទួលបាន +1
                    // ក្រុមទី 5 (ក្រុមទី៦) នឹងមិនទទួលបាន +1 ទេ
                    const currentGroupSize = baseSize + (i < remainder ? 1 : 0);
                    
                    const start = currentIndex;
                    const end = currentIndex + currentGroupSize;
                    const groupStudents = shuffledStudents.slice(start, end);
                    
                    // (UPDATED) បន្ថែម "ក. " សម្រាប់សិស្សស្រី
                    groups.push({
                        day: days[i],
                        students: groupStudents.map(s => {
                            const studentNamePrefix = (s.gender === 'ស្រី') ? 'ក. ' : '';
                            return `${studentNamePrefix}${s.lastName} ${s.firstName}`;
                        })
                    });
                    
                    currentIndex = end; // រំកិល currentIndex ទៅចុងបញ្ចប់នៃក្រុមនេះ
                }
                // --- End of V14.21 Logic ---

                
                // Store for printing
                currentRosterData = groups; 

                // Render HTML for display
                let rosterHtml = `<h2 class="text-2xl font-bold mb-4 text-center font-title">តារាងវេនសំអាត - ${currentRosterClassName}</h2>`;
                rosterHtml += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
                
                groups.forEach(group => {
                    rosterHtml += `<div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h3 class="text-lg font-semibold mb-2 text-blue-700">${group.day} (សរុប ${group.students.length} នាក់)</h3>
                        <ul class="list-decimal list-inside space-y-1">`; // (UPDATED) Use list-decimal
                    
                    if (group.students.length > 0) {
                        group.students.forEach(name => {
                            rosterHtml += `<li>${name}</li>`;
                        });
                    } else {
                        rosterHtml += `<li class="text-gray-400">(មិនមានសិស្ស)</li>`;
                    }
                    
                    rosterHtml += `</ul></div>`;
                });
                
                rosterHtml += `</div>`;
                displayArea.innerHTML = rosterHtml;
                showToast("បានបង្កើតតារាងវេនសំអាត។");

            } catch (error) {
                console.error("Error generating roster: ", error);
                showToast("មានបញ្ហាក្នុងការបង្កើតតារាងវេន។", true);
                displayArea.innerHTML = `<p class="text-center text-red-500">Error: ${error.message}</p>`;
                currentRosterData = null;
            }
        }
        
        // (UPDATED V14.22) Print Roster Logic
        async function printCleaningRoster() {
            if (!currentRosterData || currentRosterData.length === 0) {
                return showToast("សូមបង្កើតតារាងវេនជាមុនសិន មុននឹងបោះពុម្ព។", true);
            }

            // (NEW V14.22) Get per-class teacher/sig
            let teacherName = ".........................";
            let signatureUrl = null;
            if (currentRosterClassId && allClasses.length > 0) {
                const currentClass = allClasses.find(c => c.classId === currentRosterClassId);
                if (currentClass) {
                    teacherName = currentClass.teacherName || ".........................";
                    signatureUrl = currentClass.signatureUrl;
                }
            }
            const signatureImg = signatureUrl ? `<img src="${signatureUrl}" alt="ហត្ថលេខា" style="height: 50px; margin-bottom: -10px;">` : ".........................";

            // (NEW V14.22) Get global school info
            const schoolName = localStorage.getItem('settingSchoolName') || '.........................';
            const directorSealUrl = localStorage.getItem('settingDirectorSealUrl');
            const directorSealImg = directorSealUrl ? `<img src="${directorSealUrl}" alt="ត្រាសាលា" style="height: 80px; width: 80px; object-fit: contain;">` : '';

            // (NEW V14.5) Print date
            const printDate = new Date();
            const printDay = printDate.getDate();
            const printMonth = khmerMonths[printDate.getMonth()];
            const printYear = printDate.getFullYear();
            const printDateKh = `ថ្ងៃ${printDay} ខែ${printMonth} ឆ្នាំ${printYear}`;

            let printHtml = `<html><head><title>តារាងវេនសំអាត - ${currentRosterClassName}</title><meta charset="UTF-8">
            <style>
                body { 
                    font-family: 'Kantumruy Pro', 'Khmer OS', 'Helvetica Neue', Helvetica, Arial, sans-serif; 
                    margin: 0; 
                }
                h1, h2 { text-align: center; font-family: 'Moul', 'Khmer OS Muol Light', cursive; margin: 5px 0; }
                h1 { font-size: 22px; }
                h2 { font-size: 18px; font-weight: normal; font-family: 'Kantumruy Pro', 'Khmer OS', sans-serif; } 
                
                /* (NEW) Use table for robust print layout */
                table.print-roster { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 20px; 
                    table-layout: fixed; /* Equal columns */
                }
                table.print-roster th {
                    font-family: 'Moul', 'Khmer OS Muol Light', cursive;
                    font-size: 16px;
                    padding: 10px;
                    border: 1px solid black;
                    background-color: #f2f2f2;
                    text-align: center;
                }
                table.print-roster td { 
                    border: 1px solid black; 
                    padding: 10px; 
                    vertical-align: top;
                    font-size: 14px;
                    line-height: 1.6;
                }
                /* (NEW) Use <ol> for numbered list of students */
                table.print-roster td ol {
                    margin: 0;
                    padding-left: 20px;
                }
                
                .signature-footer {
                    margin-top: 30px;
                    width: 100%;
                    display: table;
                }
                .footer-left {
                    display: table-cell;
                    text-align: left;
                }
                .footer-right {
                    display: table-cell;
                    text-align: center;
                    width: 40%;
                    font-size: 14px;
                }

                /* (NEW V14.22) Print Header */
                .print-header { display: table; width: 100%; margin-bottom: 10px; }
                .header-left { display: table-cell; text-align: left; vertical-align: top; width: 25%; }
                .header-center { display: table-cell; text-align: center; vertical-align: top; }
                .header-right { 
                    display: table-cell; text-align: center; vertical-align: top; width: 25%; 
                    font-size: 14px; line-height: 1.5; font-family: 'Moul', 'Khmer OS Muol Light', cursive;
                }
            </style>
            </head><body>
            
            <!-- (NEW V14.22) Print Header -->
            <div class="print-header">
                <div class="header-left">
                    ${directorSealImg}
                </div>
                <div class="header-center">
                    <h1 style="margin: 0;">${schoolName}</h1> 
                    <h1>តារាងវេនសំអាត</h1> 
                    <h2>${currentRosterClassName}</h2> 
                </div>
                <div class="header-right">
                    ព្រះរាជាណាចក្រកម្ពុជា <br> ជាតិ សាសនា ព្រះមហាក្សត្រ
                </div>
            </div>
            
            <table class="print-roster">
                <thead>
                    <tr>
                        <th>${currentRosterData[0].day} (${currentRosterData[0].students.length}នាក់)</th>
                        <th>${currentRosterData[1].day} (${currentRosterData[1].students.length}នាក់)</th>
                        <th>${currentRosterData[2].day} (${currentRosterData[2].students.length}នាក់)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <!-- Monday -->
                        <td>
                            <ol>
                                ${currentRosterData[0].students.map(s => `<li>${s}</li>`).join('')}
                            </ol>
                        </td>
                        <!-- Tuesday -->
                        <td>
                            <ol>
                                ${currentRosterData[1].students.map(s => `<li>${s}</li>`).join('')}
                            </ol>
                        </td>
                        <!-- Wednesday -->
                        <td>
                            <ol>
                                ${currentRosterData[2].students.map(s => `<li>${s}</li>`).join('')}
                            </ol>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- (NEW) Second table for Thu-Sat -->
            <table class="print-roster" style="margin-top: 10px;">
                 <thead>
                    <tr>
                        <th>${currentRosterData[3].day} (${currentRosterData[3].students.length}នាក់)</th>
                        <th>${currentRosterData[4].day} (${currentRosterData[4].students.length}នាក់)</th>
                        <th>${currentRosterData[5].day} (${currentRosterData[5].students.length}នាក់)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <!-- Thursday -->
                        <td>
                            <ol>
                                ${currentRosterData[3].students.map(s => `<li>${s}</li>`).join('')}
                            </ol>
                        </td>
                        <!-- Friday -->
                        <td>
                            <ol>
                                ${currentRosterData[4].students.map(s => `<li>${s}</li>`).join('')}
                            </ol>
                        </td>
                        <!-- Saturday -->
                        <td>
                            <ol>
                                ${currentRosterData[5].students.map(s => `<li>${s}</li>`).join('')}
                            </ol>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div class="signature-footer">
                <div class="footer-left">
                    <!-- Left blank -->
                </div>
                <div class="footer-right">
                    <p style="margin-bottom: 10px;">${printDateKh}</p>
                    <p style="margin: 0; font-weight: bold;">គ្រូបន្ទុកថ្នាក់</p>
                    <div style="height: 60px;">${signatureImg}</div>
                    <p style="margin: 0; font-weight: bold;">${teacherName}</p>
                </div>
            </div>
            
            </body></html>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHtml);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        // --- 11. មុខងារកែសម្រួល (Edit Modals) (ពី V7) ---
        async function openEditModal(type, dbId) {
            if (allClasses.length === 0) {
                await loadClassesForSelect();
            }
            if (type === 'class') {
                try {
                    const cls = await db.classes.get(dbId);
                    document.getElementById('editClassDbId').value = cls.id;
                    document.getElementById('editClassId').value = cls.classId;
                    document.getElementById('editClassName').value = cls.className;
                    document.getElementById('editAcademicYear').value = cls.academicYear;
                    document.getElementById('editClassTeacherName').value = cls.teacherName || ''; // (NEW V14.22)
                    document.getElementById('editClassSignatureUrl').value = cls.signatureUrl || ''; // (NEW V14.22)
                    document.getElementById('editClassModal').style.display = 'flex';
                } catch (error) { showToast("រកមិនឃើញទិន្នន័យថ្នាក់", true); }
            } 
            else if (type === 'student') {
                try {
                    const student = await db.students.get(dbId);
                    document.getElementById('editStudentDbId').value = student.id;
                    document.getElementById('editStudentId').value = student.studentId;
                    document.getElementById('editLastName').value = student.lastName;
                    document.getElementById('editFirstName').value = student.firstName;
                    document.getElementById('editGender').value = student.gender;
                    document.getElementById('editDob').value = student.dob;
                    document.getElementById('editPhotoUrl').value = student.photoUrl || '';
                    const classSelect = document.getElementById('editStudentClassId');
                    classSelect.innerHTML = '<option value="">-- ជ្រើសរើសថ្នាក់ --</option>';
                    allClasses.forEach(cls => {
                        classSelect.innerHTML += `<option value="${cls.classId}">${cls.className} (${cls.academicYear})</option>`;
                    });
                    classSelect.value = student.classId;
                    document.getElementById('editStudentModal').style.display = 'flex';
                } catch (error) { showToast("រកមិនឃើញទិន្នន័យសិស្ស", true); }
            }
            else if (type === 'schedule') {
                try {
                    const schedule = await db.schedule.get(dbId);
                    document.getElementById('editScheduleDbId').value = schedule.id;
                    document.getElementById('editDayOfWeek').value = schedule.dayOfWeek;
                    document.getElementById('editStartTime').value = schedule.startTime;
                    document.getElementById('editEndTime').value = schedule.endTime;
                    const classSelect = document.getElementById('editScheduleClassId');
                    classSelect.innerHTML = '<option value="">-- ជ្រើសរើសថ្នាក់ --</option>';
                    allClasses.forEach(cls => {
                        classSelect.innerHTML += `<option value="${cls.classId}">${cls.className} (${cls.academicYear})</option>`;
                    });
                    classSelect.value = schedule.classId;
                    document.getElementById('editScheduleModal').style.display = 'flex';
                } catch (error) { showToast("រកមិនឃើញទិន្នន័យកាលវិភាគ", true); }
            }
        }

        function closeEditModal(type) {
            document.getElementById(`edit${type.charAt(0).toUpperCase() + type.slice(1)}Modal`).style.display = 'none';
        }

        // (UPDATED V14.22)
        document.getElementById('editClassForm').onsubmit = async (event) => {
            event.preventDefault();
            const dbId = parseInt(document.getElementById('editClassDbId').value);
            const data = {
                className: document.getElementById('editClassName').value,
                academicYear: document.getElementById('editAcademicYear').value,
                classId: document.getElementById('editClassId').value,
                teacherName: document.getElementById('editClassTeacherName').value, // (NEW V14.22)
                signatureUrl: document.getElementById('editClassSignatureUrl').value // (NEW V14.22)
            };
            try {
                await db.classes.update(dbId, data);
                showToast("បានរក្សាទុកការផ្លាស់ប្តូរថ្នាក់។");
                closeEditModal('class');
                await loadClassesForTable();
                await loadClassesForSelect();
            } catch (error) { showToast("Error: " + error.message, true); }
        };

        document.getElementById('editStudentForm').onsubmit = async (event) => {
            event.preventDefault();
            const dbId = parseInt(document.getElementById('editStudentDbId').value);
            const data = {
                lastName: document.getElementById('editLastName').value,
                firstName: document.getElementById('editFirstName').value,
                gender: document.getElementById('editGender').value,
                dob: document.getElementById('editDob').value,
                classId: document.getElementById('editStudentClassId').value,
                photoUrl: document.getElementById('editPhotoUrl').value || null,
                studentId: document.getElementById('editStudentId').value
            };
            try {
                await db.students.update(dbId, data);
                showToast("បានរក្សាទុកការផ្លាស់ប្តូរសិស្ស។");
                closeEditModal('student');
                await loadStudents();
            } catch (error) { showToast("Error: " + error.message, true); }
        };

        document.getElementById('editScheduleForm').onsubmit = async (event) => {
            event.preventDefault();
            const dbId = parseInt(document.getElementById('editScheduleDbId').value);
            const data = {
                classId: document.getElementById('editScheduleClassId').value,
                dayOfWeek: parseInt(document.getElementById('editDayOfWeek').value),
                startTime: document.getElementById('editStartTime').value,
                endTime: document.getElementById('editEndTime').value
            };
            try {
                await db.schedule.update(dbId, data);
                showToast("បានរក្សាទុកការផ្លាស់ប្តូរកាលវិភាគ។");
                closeEditModal('schedule');
                await loadSchedules();
            } catch (error) { showToast("Error: " + error.message, true); }
        };

        // --- (NEW) 12. មុខងារលុប (Delete Logic) ---
        let currentDeleteInfo = { type: null, id: null };
        
        function confirmDelete(type, id, name) {
            currentDeleteInfo = { type, id };
            const modal = document.getElementById('confirmDeleteModal');
            document.getElementById('confirm-message').textContent = `តើអ្នកពិតជាចង់លុប "${name}" មែនទេ?`;
            
            const warningEl = document.getElementById('confirm-warning');
            if (type === 'classes') {
                warningEl.textContent = "ការលុបថ្នាក់នេះ អាចប៉ះពាល់ដល់ទិន្នន័យសិស្ស និងកាលវិភាគដែលពាក់ព័ន្ធ។";
            } else if (type === 'students') {
                warningEl.textContent = "ការលុបសិស្សនេះ នឹងលុបកំណត់ត្រារបស់សិស្ស ប៉ុន្តែមិនលុបកំណត់ត្រាអវត្តមានចាស់ៗទេ។";
            } else if (type === 'classes_all') { // (NEW V14.15)
                warningEl.textContent = "ការលុបនេះ នឹងលុប *ថ្នាក់រៀនទាំងអស់* ចេញពីប្រព័ន្ធ។";
            } else if (type === 'students_all') { // (NEW V14.15)
                warningEl.textContent = "ការលុបនេះ នឹងលុប *សិស្សទាំងអស់* ចេញពីប្រព័ន្ធ។";
            } else if (type === 'schedule_all') { // (NEW V14.15)
                warningEl.textContent = "ការលុបនេះ នឹងលុប *កាលវិភាគទាំងអស់* ចេញពីប្រព័ន្ធ។";
            } else if (type === 'attendanceLog_all') { // (NEW V14.15)
                warningEl.textContent = "ការលុបនេះ នឹងលុប *កំណត់ត្រាអវត្តមាន (Log) ទាំងអស់* ចេញពីប្រព័ន្ធ។";
            } else {
                warningEl.textContent = "សកម្មភាពនេះ មិនអាចបកក្រោយបានទេ។";
            }
            
            modal.style.display = 'flex';
        }
        
        function closeDeleteModal() {
            document.getElementById('confirmDeleteModal').style.display = 'none';
            currentDeleteInfo = { type: null, id: null };
        }
        
        // (UPDATED V14.17/18)
        async function executeDelete() {
            const { type, id } = currentDeleteInfo;
            
            // Check ID only if not a 'delete all' action
            // This logic is correct: if id is 0, !id is true. if type is '_all', !type.endsWith is false. (true && false) is false.
            if (!type || (!id && !type.endsWith('_all'))) {
                // This condition handles cases where id is 0, null, or undefined for single deletes
                // But allows id=0 for '_all' types
                if (type && !type.endsWith('_all')) {
                    console.error("Invalid ID for deletion:", id);
                    return; // Stop if it's a single delete with no valid ID
                }
                if (!type) return; // Stop if no type
            }

            try {
                if (type === 'classes') {
                    await db.classes.delete(id);
                    await loadClassesForTable();
                    await loadClassesForSelect();
                } else if (type === 'classes_all') { // (NEW V14.15)
                    await db.classes.clear();
                    await loadClassesForTable();
                    await loadClassesForSelect();
                } else if (type === 'students') {
                    await db.students.delete(id);
                    await loadStudents();
                } else if (type === 'students_all') { // (NEW V14.15)
                    await db.students.clear();
                    await loadStudents();
                } else if (type === 'schedule') {
                    await db.schedule.delete(id);
                    await loadSchedules();
                } else if (type === 'schedule_all') { // (NEW V14.15)
                    await db.schedule.clear();
                    await loadSchedules();
                } else if (type === 'attendanceLog') {
                    await db.attendanceLog.delete(id);
                    await loadReportData(); // ផ្ទុករបាយការណ៍ឡើងវិញ
                } else if (type === 'attendanceLog_all') { // (NEW V14.15)
                    await db.attendanceLog.clear();
                    await loadReportData(); 
                }
                showToast("បានលុបទិន្នន័យជោគជ័យ។");
            } catch (error) {
                console.error("Error deleting item: ", error);
                showToast("Error: " + error.message, true);
            } finally {
                closeDeleteModal();
            }
        }

        // --- 13. មុខងារជំនួយ (Toast Notification) ---
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white z-50';
            toast.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        // --- 14. មុខងារប្តូរ Type នៃប្រអប់ Date ---
        function setupReportTypeToggle() {
            const dateInput = document.getElementById('reportFilterDate');
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayDate = `${yyyy}-${mm}-${dd}`;
            const todayMonth = `${yyyy}-${mm}`;
            dateInput.type = 'date';
            dateInput.value = todayDate;
            document.getElementById('reportTypeSelector').addEventListener('change', (e) => {
                if (e.target.value === 'monthly') {
                    dateInput.type = 'month';
                    dateInput.value = todayMonth;
                } else {
                    dateInput.type = 'date';
                    dateInput.value = todayDate;
                }
                loadReportData(); // (NEW V14.11)
            });
        }
        
        // --- (UPDATED V14.22) 15. មុខងារកំណត់ (Settings) ---
        
        // (UPDATED V14.22) Load Global Settings
        function loadSettings() {
            // Load Global Settings
            const settingSchoolNameEl = document.getElementById('settingSchoolName');
            if (settingSchoolNameEl) {
                settingSchoolNameEl.value = localStorage.getItem('settingSchoolName') || '';
            }
            const settingDirectorSealUrlEl = document.getElementById('settingDirectorSealUrl');
            if (settingDirectorSealUrlEl) {
                settingDirectorSealUrlEl.value = localStorage.getItem('settingDirectorSealUrl') || '';
            }
            const settingAcademicYearEl = document.getElementById('settingAcademicYear');
            if (settingAcademicYearEl) {
                settingAcademicYearEl.value = localStorage.getItem('settingAcademicYear') || '';
            }
        }
        
        // (UPDATED V14.22) Save Global Settings
        const settingsFormEl = document.getElementById('settingsForm');
        if (settingsFormEl) {
            settingsFormEl.onsubmit = (event) => {
                event.preventDefault();
                const schoolName = document.getElementById('settingSchoolName').value;
                const directorSealUrl = document.getElementById('settingDirectorSealUrl').value;
                const academicYear = document.getElementById('settingAcademicYear').value;
                
                localStorage.setItem('settingSchoolName', schoolName);
                localStorage.setItem('settingDirectorSealUrl', directorSealUrl);
                localStorage.setItem('settingAcademicYear', academicYear);
                
                showToast("បានរក្សាទុកការកំណត់ទូទៅ។");
                updatePlaceholders(); 
                // មិនបាច់ប្តូរទំព័រ
            };
        }

        // (NEW V14.22) Load Per-Class Settings Table
        async function loadClassSettingsTable() {
            const container = document.getElementById('class-settings-table-container');
            container.innerHTML = '<p class="text-center text-gray-500">កំពុងទាញយកបញ្ជីថ្នាក់...</p>';

            if (allClasses.length === 0) {
                await loadClassesForSelect(); // Ensure allClasses is populated
            }
            
            if (allClasses.length === 0) {
                container.innerHTML = '<p class="text-center text-red-500">មិនមានថ្នាក់រៀនទេ។ សូមបន្ថែមថ្នាក់រៀនជាមុនសិន។</p>';
                return;
            }

            const sortedClasses = [...allClasses].sort((a,b) => a.classId.localeCompare(b.classId, 'km'));
            const numClasses = sortedClasses.length;
            const useTwoColumns = numClasses > 15; // Split if more than 15 classes

            const renderTable = (classes) => {
                let tableHtml = `<table class="w-full table-auto border-collapse border border-gray-300">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-2 border border-gray-300">ថ្នាក់</th>
                            <th class="px-4 py-2 border border-gray-300">ឈ្មោះគ្រូបន្ទុកថ្នាក់</th>
                            <th class="px-4 py-2 border border-gray-300">URL ហត្ថលេខា</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                classes.forEach(cls => {
                    tableHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-300 px-4 py-2 font-semibold">${cls.className} (${cls.classId})</td>
                            <td class="border border-gray-300 px-4 py-2">
                                <input type="text" 
                                       class="class-teacher-name-input" 
                                       data-class-id="${cls.id}" 
                                       value="${cls.teacherName || ''}"
                                       placeholder="ឈ្មោះគ្រូ...">
                            </td>
                            <td class="border border-gray-300 px-4 py-2">
                                <input type="url" 
                                       class="class-signature-url-input" 
                                       data-class-id="${cls.id}" 
                                       value="${cls.signatureUrl || ''}"
                                       placeholder="https://.../sig.png">
                            </td>
                        </tr>`;
                });
                tableHtml += `</tbody></table>`;
                return tableHtml;
            };

            if (useTwoColumns) {
                const midPoint = Math.ceil(numClasses / 2);
                const col1Classes = sortedClasses.slice(0, midPoint);
                const col2Classes = sortedClasses.slice(midPoint);
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>${renderTable(col1Classes)}</div>
                        <div>${renderTable(col2Classes)}</div>
                    </div>`;
            } else {
                container.innerHTML = renderTable(sortedClasses);
            }
        }

        // (NEW V14.22) Save Per-Class Settings
        async function saveClassSettings() {
            showToast("កំពុងរក្សាទុកការកំណត់គ្រូបន្ទុកថ្នាក់...");
            
            const teacherInputs = document.querySelectorAll('.class-teacher-name-input');
            const signatureInputs = document.querySelectorAll('.class-signature-url-input');

            const updates = new Map();

            teacherInputs.forEach(input => {
                const dbId = parseInt(input.dataset.classId);
                if (!updates.has(dbId)) updates.set(dbId, {});
                updates.get(dbId).teacherName = input.value.trim();
            });

            signatureInputs.forEach(input => {
                const dbId = parseInt(input.dataset.classId);
                if (!updates.has(dbId)) updates.set(dbId, {});
                updates.get(dbId).signatureUrl = input.value.trim();
            });

            try {
                await db.transaction('rw', db.classes, async () => {
                    const updatePromises = [];
                    for (const [dbId, data] of updates.entries()) {
                        updatePromises.push(db.classes.update(dbId, data));
                    }
                    await Promise.all(updatePromises);
                });
                
                // (NEW) Refresh allClasses cache
                await loadClassesForSelect(); 
                
                showToast("រក្សាទុកការកំណត់គ្រូបន្ទុកថ្នាក់ជោគជ័យ!", false);
            } catch (error) {
                console.error("Error saving class settings: ", error);
                showToast("មានបញ្ហាក្នុងការរក្សាទុក។", true);
            }
        }
        // (NEW V14.22) Attach click handler (guarded)
        const btnSaveClassSettings = document.getElementById('btn-save-class-settings');
        if (btnSaveClassSettings) {
            btnSaveClassSettings.onclick = saveClassSettings;
        }


        // (NEW V14.16) ធ្វើបច្ចុប្បន្នភាព Placeholders
        function updatePlaceholders() {
            const defaultYear = localStorage.getItem('settingAcademicYear') || '2024-2025';
            const yearInput = document.getElementById('academicYear');
            yearInput.placeholder = `ឆ្នាំសិក្សា (VD: ${defaultYear})`;
            // (NEW V14.16) Set value if empty
            if (!yearInput.value) {
                yearInput.value = defaultYear;
            }
        }

        // --- ចាប់ផ្តើមកម្មវិធី ---
        window.onload = () => {
            loadClassesForSelect();
            setupReportTypeToggle();
            loadReportData(); // (NEW V14.12) ផ្ទុកទិន្នន័យដំបូង
            updatePlaceholders(); // (NEW V14.16)
            
            // (NEW) Auto-focus scan input
            setTimeout(() => {
                document.getElementById('usb-scanner-input').focus();
            }, 100);

            // (UPDATED) Auto-focus scan input every 1 second
            setInterval(() => {
                const scanPage = document.getElementById('page-scan');
                // Check if any modal is open
                const isModalOpen = document.getElementById('editClassModal').style.display === 'flex' ||
                                  document.getElementById('editStudentModal').style.display === 'flex' ||
                                  document.getElementById('editScheduleModal').style.display === 'flex' ||
                                  document.getElementById('confirmDeleteModal').style.display === 'flex';
                
                // Only focus if on scan page and no modals are open
                if (scanPage.style.display === 'block' && !isModalOpen) {
                    const scanInput = document.getElementById('usb-scanner-input');
                    // Only focus if it's not already focused (to avoid issues)
                    if (document.activeElement !== scanInput) {
                        scanInput.focus();
                    }
                }
            }, 1000); // Every 1 second
        };

        // ធ្វើឲ្យ Function អាចហៅពី HTML បាន
        window.showPage = showPage;
        // (REMOVED) startScanner, stopScanner
        window.loadReportData = loadReportData;
        
        // (NEW V14.23) Make loadStudents global for onchange
        window.loadStudents = loadStudents;

        // (UPDATED V14.19)
        window.exportReportToExcel = exportReportToExcel; // Replaces exportDataToCSV
        window.exportTableAsExcel = exportTableAsExcel; // Replaces exportTableAsCSV
        window.importDataFromExcel = importDataFromExcel; // Replaces importDataFromCSV

        window.printReport = printReport;
        window.calculateAge = calculateAge;
        window.exportAllDataJSON = exportAllDataJSON;
        window.importAllDataJSON = importAllDataJSON;
        
        // (NEW) V8/V9 Functions
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.confirmDelete = confirmDelete;
        window.closeDeleteModal = closeDeleteModal;
        window.executeDelete = executeDelete;
        
        // (NEW V14.9)
        window.syncClassesFromStudents = syncClassesFromStudents;

        // (NEW V14.20 for Cleaning Roster)
        window.generateCleaningRoster = generateCleaningRoster;
        window.printCleaningRoster = printCleaningRoster;
        window.clearRoster = clearRoster;

        // (REMOVED) switchScanMode, initCameraScanner

    </script>

    <script type="module">
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2'

    // Reuse same Supabase URL/key as app.js
    const supabaseUrl = 'https://bcbwrymhpjcncgiwjllr.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjYndyeW1ocGpjbmNnaXdqbGxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDA5MDEsImV4cCI6MjA3MTE3NjkwMX0.ZiU1uF9_5h2N9choQvNihTvKWfqtPlHdvQm2iPaI2jw';
    const supabase = createClient(supabaseUrl, supabaseKey);`n    window.supabase = supabase;

    let currentUserId = null;
    async function ensureAuth() {
        try {
            const { data, error } = await supabase.auth.getUser();
            if (error) throw error;
            const user = data?.user;
            if (!user) {
                currentUserId = null;`n                window.currentUserId = null;`n            window.currentUserId = null;
                return true;
            }
            currentUserId = user.id;`n            window.currentUserId = currentUserId;`n            return true;
        } catch (e) {
            currentUserId = null;`n            window.currentUserId = null;
            return true;
        }
    }

    // --- Helpers ---
    const fmtTimeHHMM = (d) => String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    const todayISO = () => new Date().toISOString().slice(0,10);

    // Fetchers
    async function fetchClasses() {
        const { data, error } = await supabase.from('classes').select('*').eq('user_id', currentUserId).order('class_id');
        if (error) throw error; return data || [];
    }
    async function fetchStudents(classId = null) {
        let q = supabase.from('students').select('*').eq('user_id', currentUserId);
        if (classId) q = q.eq('class_id', classId);
        const { data, error } = await q.order('last_name');
        if (error) throw error; return data || [];
    }
    async function fetchSchedules(classId = null) {
        let q = supabase.from('schedules').select('*').eq('user_id', currentUserId);
        if (classId) q = q.eq('class_id', classId);
        const { data, error } = await q.order('class_id');
        if (error) throw error; return data || [];
    }

    // Populate selects and tables using Supabase
    window.loadClassesForSelect = async function loadClassesForSelect() {
        if (!(await ensureAuth())) return;
        let classes = await fetchClasses();
        // Fallback: derive classes from students if classes table is empty
        if (!classes || classes.length === 0) {
            const { data: sdata, error: sErr } = await supabase
                .from('students').select('class_id').eq('user_id', currentUserId);
            if (!sErr) {
                const defaultYear = localStorage.getItem('settingAcademicYear') || '';
                const uniq = [...new Set((sdata||[]).map(s => s.class_id).filter(Boolean))];
                classes = uniq.map(id => ({ class_id: id, class_name: id, academic_year: defaultYear }));
            }
        }
        window.allClasses = classes; // keep cache used elsewhere in page

        // class selects
        const selects = document.querySelectorAll('.class-select');
        selects.forEach(sel => {
            const prev = sel.value;
            const firstOption = sel.options[0] ? sel.options[0].outerHTML : '<option value="">-- ជ្រើសរើសថ្នាក់ --</option>';
            sel.innerHTML = firstOption;
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.class_id; // store class_id
                opt.textContent = c.class_name + (c.academic_year ? ` (${c.academic_year})` : '');
                sel.appendChild(opt);
            });

            if (prev) sel.value = prev;
        });
        // report/class filters
        const repSel = document.getElementById('reportFilterClass');
        if (repSel) {
            const prev = repSel.value;
            repSel.innerHTML = '<option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option><option value="">-- គ្រប់ថ្នាក់រៀន --</option>';
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.class_id; opt.textContent = c.class_name;
                repSel.appendChild(opt);
            });
            if (prev) repSel.value = prev;
        }
        const rosterSel = document.getElementById('rosterFilterClass');
        if (rosterSel) {
            const prev = rosterSel.value;
            rosterSel.innerHTML = '<option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option>';
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.class_id; opt.textContent = c.class_name;
                rosterSel.appendChild(opt);
            });
            if (prev) rosterSel.value = prev;
        }
    }

    // Table renderer for Classes (with fallback derived from students)
    window.loadClassesForTable = async function loadClassesForTable() {
        if (!(await ensureAuth())) return;
        const classList = document.getElementById('class-list');
        if (!classList) return;
        classList.innerHTML = '<tr><td colspan="4" class="text-center p-4">កំពុងទាញយក...</td></tr>';
        // Load classes (or derive from students)
        let classes = await fetchClasses();
        if (!classes || classes.length === 0) {
            const { data: sdata, error: sErr } = await supabase
                .from('students').select('class_id').eq('user_id', currentUserId);
            if (!sErr) {
                const defaultYear = localStorage.getItem('settingAcademicYear') || '';
                const uniq = [...new Set((sdata||[]).map(s => s.class_id).filter(Boolean))];
                classes = uniq.map(id => ({ class_id: id, class_name: id, academic_year: defaultYear }));
            }
        }
        // Cache for other consumers
        window.allClasses = classes;
        // Filter by search
        const search = (document.getElementById('searchClassInput')?.value || '').toLowerCase();
        const filtered = (classes || []).filter(c => (
            (c.class_id||'').toLowerCase().includes(search) || (c.class_name||'').toLowerCase().includes(search)
        ));
        if (filtered.length === 0) {
            classList.innerHTML = '<tr><td colspan="4" class="text-center p-4">មិនមានទិន្នន័យទេ។</td></tr>';
            return;
        }
        // Sort by class_id
        filtered.sort((a,b) => (a.class_id||'').localeCompare(b.class_id||''));
        // Render rows (leave action column empty for now)
        classList.innerHTML = filtered.map(cls => `
            <tr>
                <td class="border px-4 py-2">${cls.class_id||''}</td>
                <td class="border px-4 py-2">${cls.class_name||''}</td>
                <td class="border px-4 py-2">${cls.academic_year||''}</td>
                <td class="border px-4 py-2 whitespace-nowrap"></td>
            </tr>
        `).join('');
    }

    window.loadStudents = async function loadStudents() {
        if (!(await ensureAuth())) return;
        const classFilter = document.getElementById('filterStudentClass')?.value || 'all';
        const search = (document.getElementById('searchStudentInput')?.value || '').toLowerCase().trim();
        const sortBy = document.getElementById('sortStudentBy')?.value || 'name';
        const listEl = document.getElementById('student-list');
        if (!listEl) return;
        let students = await fetchStudents(classFilter === 'all' ? null : classFilter);
        if (search) {
            students = students.filter(s => `${s.student_id} ${s.last_name} ${s.first_name}`.toLowerCase().includes(search));
        }
        students.sort((a,b) => sortBy === 'class' ? a.class_id.localeCompare(b.class_id) : `${a.last_name} ${a.first_name}`.localeCompare(`${b.last_name} ${b.first_name}`));
        listEl.innerHTML = '';
        // Map class_id -> class_name for display
        const classNameById = new Map((window.allClasses||[]).map(c => [c.class_id, c.class_name]));
        for (const s of students) {
            const tr = document.createElement('tr'); tr.className='border-b';
            const photo = s.photo_url ? `<img src="${s.photo_url}" class="h-10 w-10 object-cover rounded"/>` : '';
            const age = (typeof window.calculateAge === 'function' && s.dob) ? window.calculateAge(s.dob) : '';
            const classLabel = classNameById.get(s.class_id) || s.class_id || '';
            tr.innerHTML = `
                <td class="px-4 py-2">${photo}</td>
                <td class="px-4 py-2">${s.student_id}</td>
                <td class="px-4 py-2">${s.last_name} ${s.first_name}</td>
                <td class="px-4 py-2">${s.gender || ''}</td>
                <td class="px-4 py-2">${age}</td>
                <td class="px-4 py-2">${classLabel}</td>
                <td class="px-4 py-2"><button class="btn btn-blue" onclick="openEditModal('student', ${s.id})">កែសម្រួល</button></td>`;
            listEl.appendChild(tr);
        }
    }

    window.loadSchedules = async function loadSchedules() {
        if (!(await ensureAuth())) return;
        const listEl = document.getElementById('schedule-list');
        if (!listEl) return;
        const search = (document.getElementById('searchScheduleInput')?.value || '').toLowerCase().trim();
        let items = await fetchSchedules();
        if (search) items = items.filter(x => x.class_id.toLowerCase().includes(search));
        listEl.innerHTML='';
        const dayMap = {0:'អាទិត្យ',1:'ច័ន្ទ',2:'អង្គារ',3:'ពុធ',4:'ព្រហស្បតិ៍',5:'សុក្រ',6:'សៅរ៍'};
        for (const sc of items) {
            const tr = document.createElement('tr'); tr.className='border-b';
            tr.innerHTML = `
                <td class="px-4 py-2">${sc.class_id}</td>
                <td class="px-4 py-2">${dayMap[sc.day_of_week]}</td>
                <td class="px-4 py-2">${sc.start_time}</td>
                <td class="px-4 py-2">${sc.end_time}</td>
                <td class="px-4 py-2"><button class="btn btn-blue" onclick="openEditModal('schedule', ${sc.id})">កែសម្រួល</button></td>`;
            listEl.appendChild(tr);
        }
    }

    // Scan handler: Enter triggers upsert into attendance_logs
    
        if (!currentUserId && (window.onScanSuccess instanceof Function)) { return window.onScanSuccess(code); }
        const input = document.getElementById('usb-scanner-input');
        const statusBox = document.getElementById('scan-result');
        const show = (msg, ok=false) => { if(statusBox){ statusBox.innerHTML = `<div class="p-4 ${ok?'bg-green-100 text-green-700':'bg-red-100 text-red-700'} rounded-lg"><p class="text-lg">${msg}</p></div>`; } };
        try {
            const sid = (code||'').trim(); if (!sid) return;
            // find student
            const { data: stList, error: e1 } = await supabase.from('students').select('*').eq('user_id', currentUserId).eq('student_id', sid).limit(1);
            if (e1) throw e1;
            const student = (stList||[])[0];
            if (!student) { show('រកមិនឃើញសិស្សដោយកូដនេះ'); return; }

            // find active schedule for class now
            const now = new Date();
            const dow = now.getDay();
            const hhmm = fmtTimeHHMM(now);
            const { data: scheds, error: e2 } = await supabase.from('schedules').select('*')
                .eq('user_id', currentUserId).eq('class_id', student.class_id).eq('day_of_week', dow);
            if (e2) throw e2;
            const active = (scheds||[]).find(s => s.start_time <= hhmm && hhmm <= s.end_time);
            if (!active) { show('ថ្ងៃ/ម៉ោងនេះមិនមានថ្នាក់ (no class)'); return; }

            // existing open log for today?
            const today = todayISO();
            const { data: logs, error: e3 } = await supabase.from('attendance_logs')
                .select('id, scan_time_in, scan_time_out')
                .eq('user_id', currentUserId).eq('student_id', student.student_id)
                .eq('class_id', student.class_id).eq('schedule_id', active.id)
                .eq('attendance_date', today).is('scan_time_out', null).order('created_at', { ascending: false }).limit(1);
            if (e3) throw e3;
            if (logs && logs.length) {
                // set time out
                const { error: uerr } = await supabase.from('attendance_logs').update({ scan_time_out: new Date().toISOString() }).eq('id', logs[0].id);
                if (uerr) throw uerr;
                show('បានស្កេនចេញជោគជ័យ!', true);
            } else {
                // create new log (time in)
                const { error: ierr } = await supabase.from('attendance_logs').insert({
                    user_id: currentUserId,
                    student_id: student.student_id,
                    student_name: `${student.last_name} ${student.first_name}`,
                    class_id: student.class_id,
                    schedule_id: active.id,
                    attendance_date: today,
                    scan_time_in: new Date().toISOString(),
                });
                if (ierr) throw ierr;
                show('បានស្កេនចូលជោគជ័យ!', true);
            }
            input.value = '';
        } catch (err) {
            console.error(err);
            show('មានបញ្ហាក្នុងការកំណត់វត្តមាន');
        }
    }

    // Bind Enter key on scan input
    (function bindScan() {
        const input = document.getElementById('usb-scanner-input');
        if (!input) return;
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); processScan(input.value); }
        });
    })();

    // Report loader using agreed status logic
    window.loadReportData = async function loadReportData() {
        if (!(await ensureAuth())) return;
        const repType = (document.querySelector('input[name="reportType"]:checked')?.value) || 'daily';
        const classVal = document.getElementById('reportFilterClass')?.value || '';
        const statusVal = document.getElementById('reportFilterStatus')?.value || 'all';
        const dateInput = document.getElementById('reportFilterDate');
        let start, end;
        const d = new Date(dateInput?.value || new Date());
        if (repType === 'daily') {
            start = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            end = new Date(start); end.setDate(start.getDate()+1);
        } else if (repType === 'weekly') {
            const day = d.getDay(); const diff = (day+6)%7; // Monday-based
            start = new Date(d); start.setDate(d.getDate()-diff); start.setHours(0,0,0,0);
            end = new Date(start); end.setDate(start.getDate()+7);
        } else { // monthly
            start = new Date(d.getFullYear(), d.getMonth(), 1);
            end = new Date(d.getFullYear(), d.getMonth()+1, 1);
        }
        const startISO = start.toISOString().slice(0,10);
        const endISO = end.toISOString().slice(0,10);

        // Fetch logs
        let q = supabase.from('attendance_logs').select('*').eq('user_id', currentUserId).gte('attendance_date', startISO).lt('attendance_date', endISO);
        if (classVal) q = q.eq('class_id', classVal);
        const { data: logs, error } = await q.order('attendance_date');
        if (error) { console.error(error); return; }
        // Fetch students for absent/not_scanned
        const students = classVal ? await fetchStudents(classVal) : await fetchStudents();
        // Fetch schedules for late determination
        const schedules = await fetchSchedules(classVal || null);
        const scById = new Map(schedules.map(s => [s.id, s]));

        // Build rows
        const headerEl = document.getElementById('report-table-header');
        const bodyEl = document.getElementById('report-table-body');
        if (!headerEl || !bodyEl) return;
        headerEl.innerHTML = '<th class="px-4 py-2">កាលបរិច្ឆេទ</th><th class="px-4 py-2">សិស្ស</th><th class="px-4 py-2">ថ្នាក់</th><th class="px-4 py-2">ស្ថានភាព</th><th class="px-4 py-2">ចូល</th><th class="px-4 py-2">ចេញ</th>';
        bodyEl.innerHTML = '';

        // Index logs by student/date for faster lookup
        const byKey = new Map();
        for (const lg of logs) {
            const k = `${lg.student_id}|${lg.attendance_date}`;
            if (!byKey.has(k)) byKey.set(k, []);
            byKey.get(k).push(lg);
        }
        const addRow = (date, s, status, inT, outT) => {
            const tr = document.createElement('tr'); tr.className='border-b';
            tr.innerHTML = `<td class="px-4 py-2">${date}</td><td class="px-4 py-2">${s.last_name} ${s.first_name}</td><td class="px-4 py-2">${s.class_id}</td><td class="px-4 py-2">${status}</td><td class="px-4 py-2">${inT||''}</td><td class="px-4 py-2">${outT||''}</td>`;
            bodyEl.appendChild(tr);
        };

        // For each student and each day in range, compute status (basic)
        const dayCount = Math.ceil((end - start)/(24*3600*1000));
        for (const s of students) {
            for (let i=0;i<dayCount;i++) {
                const dt = new Date(start); dt.setDate(start.getDate()+i);
                const dateISO = dt.toISOString().slice(0,10);
                const key = `${s.student_id}|${dateISO}`;
                const entries = byKey.get(key) || [];
                if (entries.length === 0) {
                    if (statusVal === 'all' || statusVal === 'not_scanned' || statusVal === 'absent') {
                        addRow(dateISO, s, statusVal==='absent'?'អវត្តមាន':'មិនទាន់បានស្កេន');
                    }
                    continue;
                }
                // Merge to single row: use earliest in and latest out
                const inTimes = entries.map(e => e.scan_time_in).filter(Boolean).sort();
                const outTimes = entries.map(e => e.scan_time_out).filter(Boolean).sort();
                const inISO = inTimes[0] || null; const outISO = outTimes[outTimes.length-1] || null;
                // Status rules
                let status = 'វត្តមាន';
                const sch = scById.get(entries[0].schedule_id);
                if (inISO && sch) {
                    const t = new Date(inISO); const hhmm = fmtTimeHHMM(t);
                    if (hhmm > sch.start_time) status = 'មកយឺត';
                }
                if (inISO && !outISO) status = 'មិនបានស្កេនចេញ';
                // Filter
                const mapVal = {present:'វត្តមាន', late:'មកយឺត', no_checkout:'មិនបានស្កេនចេញ'}[statusVal] || null;
                if (statusVal !== 'all' && mapVal && status !== mapVal) continue;
                addRow(dateISO, s, status, inISO?.substring(11,16), outISO?.substring(11,16));
            }
        }
    }

    // Kick off initial auth + data load if page already initialized
    (async () => {
        if (await ensureAuth()) {
            await loadClassesForSelect();
            await loadStudents();
            await loadSchedules();
        }
    })();
    </script>
</body>
</html>

<script>
(function(){
  function offline(){ return !window.currentUserId; }
  if (!offline() || typeof db === 'undefined') return;
  // Dexie-based fallback for class selects
  window.loadClassesForSelect = async function(){
    try {
      const classes = await db.classes.toArray();
      window.allClasses = (classes||[]).map(c => ({ class_id: c.classId, class_name: c.className, academic_year: c.academicYear }));
      const selects = document.querySelectorAll('.class-select');
      selects.forEach(sel => {
        const prev = sel.value;
        const firstOption = sel.options[0] ? sel.options[0].outerHTML : '<option value="">-- ជ្រើសរើសថ្នាក់ --</option>';
        sel.innerHTML = firstOption;
        (window.allClasses||[]).forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.class_id;
          opt.textContent = c.class_name + (c.academic_year ? ' ('+c.academic_year+')' : '');
          sel.appendChild(opt);
        });
        if (prev) sel.value = prev;
      });
      const repSel = document.getElementById('reportFilterClass');
      if (repSel) {
        const prev = repSel.value;
        repSel.innerHTML = '<option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option><option value="">-- គ្រប់ថ្នាក់រៀន --</option>';
        (window.allClasses||[]).forEach(c => { const opt = document.createElement('option'); opt.value = c.class_id; opt.textContent = c.class_name; repSel.appendChild(opt); });
        if (prev) repSel.value = prev;
      }
      const rosterSel = document.getElementById('rosterFilterClass');
      if (rosterSel) {
        const prev = rosterSel.value;
        rosterSel.innerHTML = '<option value="none" selected>-- សូមជ្រើសរើសថ្នាក់ --</option>';
        (window.allClasses||[]).forEach(c => { const opt = document.createElement('option'); opt.value = c.class_id; opt.textContent = c.class_name; rosterSel.appendChild(opt); });
        if (prev) rosterSel.value = prev;
      }
    } catch(e){ console.error(e); }
  };
  // Dexie-based fallback for students
  window.loadStudents = async function(){
    const classFilter = (document.getElementById('filterStudentClass')||{}).value || 'all';
    const search = ((document.getElementById('searchStudentInput')||{}).value || '').toLowerCase().trim();
    const sortBy = (document.getElementById('sortStudentBy')||{}).value || 'name';
    const listEl = document.getElementById('student-list'); if (!listEl) return;
    let students = await db.students.toArray();
    if (classFilter !== 'all') students = students.filter(s => s.classId === classFilter);
    if (search) students = students.filter(s => (s.studentId+' '+s.lastName+' '+s.firstName).toLowerCase().includes(search));
    students.sort((a,b) => sortBy==='class' ? (a.classId||'').localeCompare(b.classId||'') : (a.lastName+' '+a.firstName).localeCompare(b.lastName+' '+b.firstName));
    listEl.innerHTML = '';
    const classNameById = new Map(((window.allClasses)||[]).map(c => [c.class_id, c.class_name]));
    students.forEach(s => {
      const tr = document.createElement('tr'); tr.className='border-b';
      const photo = s.photoUrl ? '<img src="'+s.photoUrl+'" class="h-10 w-10 object-cover rounded"/>' : '';
      const age = (typeof window.calculateAge==='function' && s.dob) ? window.calculateAge(s.dob) : '';
      const classLabel = classNameById.get(s.classId) || s.classId || '';
      tr.innerHTML = '<td class="px-4 py-2">'+photo+'</td>'+
                     '<td class="px-4 py-2">'+s.studentId+'</td>'+
                     '<td class="px-4 py-2">'+s.lastName+' '+s.firstName+'</td>'+
                     '<td class="px-4 py-2">'+(s.gender||'')+'</td>'+
                     '<td class="px-4 py-2">'+age+'</td>'+
                     '<td class="px-4 py-2">'+classLabel+'</td>'+
                     '<td class="px-4 py-2"><button class="btn btn-blue" onclick="openEditModal(\'student\', '+s.id+')">កែសម្រួល</button></td>';
      listEl.appendChild(tr);
    });
  };
  // Dexie-based fallback for schedules
  window.loadSchedules = async function(){
    const listEl = document.getElementById('schedule-list'); if (!listEl) return;
    const search = ((document.getElementById('searchScheduleInput')||{}).value || '').toLowerCase().trim();
    let items = await db.schedule.toArray();
    if (search) items = items.filter(x => (x.classId||'').toLowerCase().includes(search));
    listEl.innerHTML='';
    const dayMap = {0:'អាទិត្យ',1:'ច័ន្ទ',2:'អង្គារ',3:'ពុធ',4:'ព្រហស្បតិ៍',5:'សុក្រ',6:'សៅរ៍'};
    items.forEach(sc => {
      const tr = document.createElement('tr'); tr.className='border-b';
      tr.innerHTML = '<td class="px-4 py-2">'+(sc.classId||'')+'</td>'+
                     '<td class="px-4 py-2">'+dayMap[sc.dayOfWeek]+'</td>'+
                     '<td class="px-4 py-2">'+sc.startTime+'</td>'+
                     '<td class="px-4 py-2">'+sc.endTime+'</td>'+
                     '<td class="px-4 py-2"><button class="btn btn-blue" onclick="openEditModal(\'schedule\', '+sc.id+')">កែសម្រួល</button></td>';
      listEl.appendChild(tr);
    });
  };
  // Bind scan input to Dexie handler (onScanSuccess) if present
  const input = document.getElementById('usb-scanner-input');
  if (input && typeof window.onScanSuccess === 'function') {
    input.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); window.onScanSuccess(input.value); input.value=''; }});
  }
})();
</script>
